<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Capturador de Datos</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://kit.fontawesome.com/4f3ce16e3d.js" crossorigin="anonymous"></script>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <script src="capturador.js"></script>
</head>

<!-- üì° SUPABASE CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- üîë CONFIGURACI√ìN SUPABASE -->
<script src="supabase-config.js"></script>
<script src="roles.js"></script>

<body>

<!-- NAVBAR MEJORADA -->
 <nav class="navbar">
  <h1>üíß Agua Zafiro</h1>
  <div class="nav-actions">
    <div class="status"><i class="fas fa-circle"></i> Sistema Activo</div>
    
    <!-- Botones de importar/exportar (solo para admin) -->
    <button class="btn import admin-only" onclick="iniciarImportacionDirecta()" id="btnImportar">
      <i class="fas fa-upload"></i> Importar
    </button>      
    <button class="btn export admin-only" onclick="iniciarExportacion()">
      <i class="fas fa-download"></i> Exportar
    </button>
    
    <!-- Navegaci√≥n -->
    <a href="capturador.html" class="nav-btn active">
      <i class="fas fa-clipboard-list"></i>
      <span>Capturador</span>
    </a>
    href="calendario-ventas.html"
      <i class="fas fa-calendar-alt"></i>
      <span>Calendario</span>
    </a>
    <a href="dashboard.html" class="nav-btn dashboard-only">
      <i class="fas fa-chart-line"></i>
      <span>Dashboard</span>
    </a>
    
    <!-- ‚úÖ AGREGAR AQU√ç -->
    <a href="produccion.html" class="nav-btn admin-only">
      <i class="fas fa-industry"></i>
      <span>Producci√≥n</span>
    </a>

    <!-- Info del usuario -->
    <div class="user-info">
      <span class="user-name">Usuario</span> | 
      <span class="user-role">Rol</span>
    </div>
    
    <!-- Bot√≥n logout -->
    <button class="btn logout-btn" onclick="cerrarSesion()" title="Cerrar Sesi√≥n">
      <i class="fas fa-sign-out-alt"></i>
    </button>
  </div>
</nav>

<!-- MENSAJE DE ROL SOCIO -->
<div id="mensajeSocio" class="socio-message" style="display: none;">
  <div class="socio-content">
    <i class="fas fa-eye"></i>
    <span>Modo Solo Lectura - Puede ver y llenar campos, pero no guardar datos</span>
  </div>
</div>

  <!-- BARRA DE PROGRESO -->
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <!-- CAPTURA DE INFORMACI√ìN -->
  <section class="section">
    <h2>üìë Captura de Informaci√≥n</h2>
    <div class="form-grid">
      <label for="fecha">Fecha:</label>
      <input type="date" id="fecha" required>

      <label for="cajaInicial">Caja Inicial (L.):</label>
      <input type="number" id="cajaInicial" value="0" step="0.01" min="0">
    </div>
  </section>

  <!-- VENTAS -->
  <section class="section">
    <div class="section-header">
      <div class="section-title">
        <span>üì¶</span>
        <span>Registro de Ventas</span>
      </div>
      <div class="section-stats">
        <span class="counter-badge" id="ventasCounter">0 registros</span>
        <span class="total-badge" id="ventasTotal">L. 0.00</span>
        <button class="auto-fill-btn" onclick="autoFillVentas()">üéØ Ejemplo</button>
      </div>
    </div>
    
    <div id="ventas-container">
      <!-- Los registros se generan din√°micamente con JavaScript -->
    </div>
    
    <button class="add-registro-btn" id="addVentaBtn" onclick="addVentaRegistro()">
      ‚ûï Agregar Nueva Venta
    </button>
  </section>

  <!-- GASTOS -->
  <section class="section">
    <div class="section-header">
      <div class="section-title">
        <span>üí∏</span>
        <span>Registro de Gastos</span>
      </div>
      <div class="section-stats">
        <span class="counter-badge" id="gastosCounter">0 registros</span>
        <span class="total-badge" id="gastosTotal">L. 0.00</span>
        <button class="auto-fill-btn" onclick="autoFillGastos()">üéØ Ejemplo</button>
      </div>
    </div>
    
    <div id="gastos-container">
      <!-- Los registros se generan din√°micamente con JavaScript -->
    </div>
    
    <button class="add-registro-btn" id="addGastoBtn" onclick="addGastoRegistro()">
      ‚ûï Agregar Nuevo Gasto
    </button>
  </section>

  <!-- CR√âDITOS -->
  <section class="section">
    <div class="section-header">
      <div class="section-title">
        <span>üìë</span>
        <span>Registro de Cr√©ditos</span>
      </div>
      <div class="section-stats">
        <span class="counter-badge" id="creditosCounter">0 registros</span>
        <span class="total-badge" id="creditosTotal">L. 0.00</span>
        <button class="auto-fill-btn" onclick="autoFillCreditos()">üéØ Ejemplo</button>
      </div>
    </div>
    
    <div id="creditos-container">
      <!-- Los registros se generan din√°micamente con JavaScript -->
    </div>
    
    <button class="add-registro-btn" id="addCreditoBtn" onclick="addCreditoRegistro()">
      ‚ûï Agregar Nuevo Cr√©dito
    </button>
  </section>

  <!-- RESUMEN -->
  <section class="section">
    <h2>üïí Resumen del D√≠a</h2>
    <div class="resumen">
      <div class="card caja">Caja Inicial: <span id="cajaResumen">L.0.00</span></div>
      <div class="card venta">Total Ventas: <span id="totalVentasResumen">L.0.00</span></div>
      <div class="card gasto">Total Gastos: <span id="totalGastosResumen">L.0.00</span></div>
      <div class="card credito">Total Cr√©ditos: <span id="totalCreditosResumen">L.0.00</span></div>
      <div class="card resultado">Resultado Final: <span id="resultadoFinal">L.0.00</span></div>
    </div>
  </section>

  <!-- OBSERVACIONES Y FOTOS MEJORADAS -->
  <section class="section">
    <div class="fotos-section-header">
      <div class="fotos-section-icon">
        <i class="fas fa-camera"></i>
      </div>
      <h2>Observaciones y Fotos</h2>
    </div>
    
    <textarea id="observaciones" placeholder="Observaciones del d√≠a..."></textarea>
    
    <div class="fotos">
      <div class="foto-upload" onclick="seleccionarOpcionFoto(1)">
        <div class="upload-content">
          <div class="upload-icon">
            <i class="fas fa-camera"></i>
          </div>
          <div class="upload-text">Subir Foto 1</div>
          <div class="upload-options">
            <div class="option-btn" onclick="event.stopPropagation(); abrirArchivos(1)">
              <i class="fas fa-folder"></i> Archivo
            </div>
            <div class="option-btn" onclick="event.stopPropagation(); abrirCamara(1)">
              <i class="fas fa-camera"></i> C√°mara
            </div>
          </div>
        </div>
        <input type="file" class="file-input" id="file1" accept="image/*" onchange="previsualizarFoto(1, this)">
        <input type="file" class="file-input" id="camera1" accept="image/*" capture="camera" onchange="previsualizarFoto(1, this)">
      </div>

      <div class="foto-upload" onclick="seleccionarOpcionFoto(2)">
        <div class="upload-content">
          <div class="upload-icon">
            <i class="fas fa-camera"></i>
          </div>
          <div class="upload-text">Subir Foto 2</div>
          <div class="upload-options">
            <div class="option-btn" onclick="event.stopPropagation(); abrirArchivos(2)">
              <i class="fas fa-folder"></i> Archivo
            </div>
            <div class="option-btn" onclick="event.stopPropagation(); abrirCamara(2)">
              <i class="fas fa-camera"></i> C√°mara
            </div>
          </div>
        </div>
        <input type="file" class="file-input" id="file2" accept="image/*" onchange="previsualizarFoto(2, this)">
        <input type="file" class="file-input" id="camera2" accept="image/*" capture="camera" onchange="previsualizarFoto(2, this)">
      </div>

      <div class="foto-upload" onclick="seleccionarOpcionFoto(3)">
        <div class="upload-content">
          <div class="upload-icon">
            <i class="fas fa-camera"></i>
          </div>
          <div class="upload-text">Subir Foto 3</div>
          <div class="upload-options">
            <div class="option-btn" onclick="event.stopPropagation(); abrirArchivos(3)">
              <i class="fas fa-folder"></i> Archivo
            </div>
            <div class="option-btn" onclick="event.stopPropagation(); abrirCamara(3)">
              <i class="fas fa-camera"></i> C√°mara
            </div>
          </div>
        </div>
        <input type="file" class="file-input" id="file3" accept="image/*" onchange="previsualizarFoto(3, this)">
        <input type="file" class="file-input" id="camera3" accept="image/*" capture="camera" onchange="previsualizarFoto(3, this)">
      </div>
    </div>
  </section>

  <!-- BOTONES -->
  <div class="footer-actions">
    <button id="btnGuardar" class="btn save">üíæ Guardar Registro Completo</button>
    <button id="btnLimpiar" class="btn">üßπ Limpiar Todo</button>
    <button id="btnValidar" class="btn">‚úÖ Validar Datos</button>
  </div>

 <script>
// üîê FUNCI√ìN DE CERRAR SESI√ìN COMPLETA Y CORREGIDA
function cerrarSesion() {
  if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
    const result = SupabaseAuth.logout();
    if (result.success) {
      console.log('üö™ Sesi√≥n cerrada correctamente');
      
      // Mostrar mensaje de confirmaci√≥n
      const notification = document.createElement('div');
      notification.innerHTML = `
        <div style="
          position: fixed; top: 20px; right: 20px; z-index: 10000;
          background: #10b981; color: white; padding: 15px 20px;
          border-radius: 10px; box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        ">
          <i class="fas fa-check-circle"></i> Sesi√≥n cerrada correctamente
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 1500);
    }
  }
}

// üîê FUNCI√ìN DE GUARDADO MODIFICADA PARA SOCIO
function interceptarGuardadoSocio() {
  const btnGuardar = document.getElementById('btnGuardar');
  if (!btnGuardar) return;

  // Guardar funci√≥n original si existe
  const guardarOriginal = window.guardarRegistro || function() {
    console.warn('Funci√≥n guardarRegistro no encontrada');
  };

  btnGuardar.onclick = function(e) {
    e.preventDefault();
    
    const currentUser = SupabaseAuth.getCurrentUser();
    if (!currentUser) {
      alert('‚ùå Debe estar autenticado para guardar');
      return;
    }

    // Si es socio, mostrar mensaje de error
    if (currentUser.role === 'socio') {
      mostrarMensajeErrorSocio();
      return;
    }

    // Para admin y vendedor, proceder normalmente
    guardarOriginal();
  };
}

// üì¢ MOSTRAR MENSAJE DE ERROR PARA SOCIO
function mostrarMensajeErrorSocio() {
  // Crear modal de error
  const modal = document.createElement('div');
  modal.innerHTML = `
    <div style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); z-index: 20000;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(3px);
    ">
      <div style="
        background: white; border-radius: 15px; padding: 30px;
        max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        border: 3px solid #dc2626; text-align: center;
      ">
        <div style="
          width: 80px; height: 80px; background: #dc2626; border-radius: 50%;
          display: flex; align-items: center; justify-content: center;
          margin: 0 auto 20px auto;
        ">
          <i class="fas fa-lock" style="color: white; font-size: 32px;"></i>
        </div>
        
        <h2 style="color: #dc2626; margin: 0 0 15px 0;">üö´ Acceso Restringido</h2>
        
        <p style="color: #374151; margin: 0 0 20px 0; line-height: 1.5;">
          Su rol de <strong>Socio</strong> no permite guardar informaci√≥n en el sistema.
          <br><br>
          <span style="color: #6b7280;">
            ‚úÖ Puede ver todos los datos<br>
            ‚úÖ Puede llenar los campos<br>
            ‚ùå No puede guardar cambios
          </span>
        </p>
        
        <button onclick="this.closest('div').parentNode.remove()" style="
          background: #dc2626; color: white; border: none; padding: 12px 25px;
          border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;
        ">
          üìã Entendido
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Auto-cerrar despu√©s de 8 segundos
  setTimeout(() => {
    if (modal.parentNode) {
      modal.parentNode.removeChild(modal);
    }
  }, 8000);
}

// üé® CONFIGURAR UI SEG√öN ROL
function configurarUISegunRol() {
  const currentUser = SupabaseAuth.getCurrentUser();
  if (!currentUser) {
    // Redirigir al login si no est√° autenticado
    window.location.href = 'login.html';
    return;
  }

  // Mostrar info del usuario
  const userNameEl = document.querySelector('.user-name');
  const userRoleEl = document.querySelector('.user-role');
  
  if (userNameEl) {
    userNameEl.textContent = currentUser.full_name || currentUser.username;
  }
  
  if (userRoleEl) {
    const roleNames = {
      'admin': 'Administrador',
      'socio': 'Socio (Solo lectura)',
      'vendedor': 'Vendedor'
    };
    userRoleEl.textContent = roleNames[currentUser.role] || currentUser.role;
  }

  // Configurar seg√∫n rol
  if (currentUser.role === 'socio') {
    // Mostrar mensaje de socio
    const mensajeSocio = document.getElementById('mensajeSocio');
    if (mensajeSocio) {
      mensajeSocio.style.display = 'block';
    }
  }

  // Aplicar restricciones de roles usando roles.js
  if (typeof setupRoleBasedUI === 'function') {
    setupRoleBasedUI(currentUser.role);
  }

  // Interceptar funci√≥n de guardado para socio
  interceptarGuardadoSocio();
}

// üöÄ INICIALIZACI√ìN COMPLETA
window.addEventListener('load', function() {
  console.log('üîÑ Inicializando capturador con autenticaci√≥n...');
  
  // ESPERAR a que TODO est√© cargado
  setTimeout(() => {
    // PRIMERO: Siempre agregar filas iniciales
    try {
      if (typeof addVentaRegistro === 'function') {
        addVentaRegistro();
        addGastoRegistro(); 
        addCreditoRegistro();
        console.log('‚úÖ Filas iniciales agregadas');
      } else {
        console.warn('‚ö†Ô∏è Funciones de capturador no disponibles a√∫n - reintentando...');
        // Reintentar despu√©s de un segundo
        setTimeout(() => {
          if (typeof addVentaRegistro === 'function') {
            addVentaRegistro();
            addGastoRegistro(); 
            addCreditoRegistro();
            console.log('‚úÖ Filas iniciales agregadas (segundo intento)');
          }
        }, 1000);
      }
    } catch (error) {
      console.error('Error agregando filas iniciales:', error);
    }
    
    // SEGUNDO: Configurar autenticaci√≥n
    try {
      configurarUISegunRol();
      console.log('‚úÖ Autenticaci√≥n configurada');
    } catch (error) {
      console.error('Error en autenticaci√≥n:', error);
    }
    
    console.log('‚úÖ Capturador inicializado');
  }, 500);
});

// Hacer funciones disponibles globalmente
window.cerrarSesion = cerrarSesion;
window.configurarUISegunRol = configurarUISegunRol;
window.interceptarGuardadoSocio = interceptarGuardadoSocio;
window.mostrarMensajeErrorSocio = mostrarMensajeErrorSocio;

console.log('‚úÖ Sistema de autenticaci√≥n y logout cargado correctamente');
</script>
  
  <!-- IMPORTADOR DE EXCEL (SOLO ADMIN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="importador-nuevo.js"></script>

<!-- PROCESADOR JSON AGREGADO AQU√ç -->
<script>
// ===== PROCESADOR EXCEL-TO-JSON MEJORADO =====
// Convierte Excel a JSON limpio y maneja celdas vac√≠as correctamente

console.log('üìä Cargando procesador Excel-to-JSON mejorado...');

// Funci√≥n principal mejorada
async function importarConProcesadorJSON() {
    console.log('üîÑ === INICIANDO IMPORTACI√ìN CON PROCESADOR JSON ===');
    
    try {
        const usuario = SupabaseAuth?.getCurrentUser();
        if (!usuario || usuario.role !== 'admin') {
            alert('Solo administradores pueden importar datos');
            return;
        }
        
        const input = document.getElementById('archivoExcelJSON');
        if (!input || !input.files[0]) {
            alert('Selecciona un archivo Excel primero');
            return;
        }
        
        const archivo = input.files[0];
        console.log(`üìÅ Procesando: ${archivo.name} (${Math.round(archivo.size/1024)}KB)`);
        
        const eliminarExistentes = confirm(
            `PROCESADOR EXCEL-TO-JSON MEJORADO\n\n` +
            `Archivo: ${archivo.name}\n` +
            `Este m√©todo procesa el Excel de manera m√°s robusta.\n\n` +
            `¬øEliminar datos existentes primero?\n` +
            `S√ç = Reemplazar todo\n` +
            `NO = Solo agregar`
        );
        
        if (eliminarExistentes === null) return;
        
        mostrarProgresoJSON();
        
        // PASO 1: Convertir Excel a JSON limpio
        actualizarProgresoJSON(10, 'Convirtiendo Excel a JSON...');
        const datosJSON = await convertirExcelAJSON(archivo);
        console.log(`üìä Conversi√≥n completada: ${datosJSON.registros.length} registros, ${datosJSON.filas.vacias} filas vac√≠as`);
        
        // PASO 2: Procesar JSON
        actualizarProgresoJSON(40, 'Procesando datos JSON...');
        const registrosLimpios = procesarDatosJSON(datosJSON.registros);
        
        // PASO 3: Limpiar datos existentes si necesario
        if (eliminarExistentes) {
            actualizarProgresoJSON(60, 'Eliminando datos existentes...');
            await eliminarDatosSupabase();
        }
        
        // PASO 4: Subir a Supabase
        actualizarProgresoJSON(70, 'Subiendo a Supabase...');
        const resultado = await subirDatosJSON(registrosLimpios, usuario.id);
        
        // Completado
        actualizarProgresoJSON(100, 'Completado!');
        
        setTimeout(() => {
            ocultarProgresoJSON();
            alert(
                `IMPORTACI√ìN CON JSON COMPLETADA\n\n` +
                `‚úÖ ${resultado.exitosos} registros importados\n` +
                `‚ùå ${resultado.errores} errores\n` +
                `üìä Total JSON: ${datosJSON.registros.length} registros\n` +
                `üßπ Registros v√°lidos: ${registrosLimpios.length}`
            );
            
            if (resultado.exitosos > 0 && confirm('¬øRecargar p√°gina?')) {
                window.location.reload();
            }
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå ERROR JSON:', error);
        ocultarProgresoJSON();
        alert(`ERROR: ${error.message}`);
    }
}

// Convertir Excel a JSON de manera robusta
async function convertirExcelAJSON(archivo) {
    console.log('üìä Iniciando conversi√≥n Excel-to-JSON...');
    
    const buffer = await archivo.arrayBuffer();
    
    // Leer con configuraci√≥n espec√≠fica para manejar celdas vac√≠as
    const workbook = XLSX.read(buffer, {
        cellDates: true,        // Convertir fechas autom√°ticamente
        cellNF: false,          // No usar formato de n√∫mero
        cellText: false,        // No forzar texto
        raw: false,             // Procesar valores
        defval: '',             // Valor por defecto para celdas vac√≠as
        sheetStubs: true        // Incluir celdas vac√≠as como stubs
    });
    
    const nombreHoja = workbook.SheetNames[0];
    const hoja = workbook.Sheets[nombreHoja];
    
    console.log(`üìã Procesando hoja: ${nombreHoja}`);
    
    // Obtener rango de la hoja
    const rango = XLSX.utils.decode_range(hoja['!ref'] || 'A1:BA1000');
    console.log(`üìê Rango detectado: ${XLSX.utils.encode_range(rango)}`);
    
    const registros = [];
    let filasVacias = 0;
    let filasConDatos = 0;
    
    // Procesar fila por fila (saltando header)
    for (let fila = rango.s.r + 1; fila <= rango.e.r; fila++) {
        const registro = {};
        let tieneDatos = false;
        
        // Procesar cada columna
        for (let col = rango.s.c; col <= rango.e.c; col++) {
            const direccion = XLSX.utils.encode_cell({ r: fila, c: col });
            const celda = hoja[direccion];
            
            // Obtener valor de la celda
            let valor = '';
            if (celda) {
                // Manejar diferentes tipos de celdas
                if (celda.t === 'd') {
                    // Fecha
                    valor = celda.v;
                } else if (celda.t === 'n') {
                    // N√∫mero
                    valor = celda.v;
                } else if (celda.t === 's' || celda.t === 'str') {
                    // String
                    valor = String(celda.v || '').trim();
                } else if (celda.t === 'b') {
                    // Boolean
                    valor = celda.v;
                } else {
                    valor = String(celda.v || '').trim();
                }
                
                if (valor !== '' && valor !== null && valor !== undefined) {
                    tieneDatos = true;
                }
            }
            
            registro[`col${col}`] = valor;
        }
        
        if (tieneDatos) {
            registro.filaOriginal = fila + 1; // +1 porque Excel empieza en 1
            registros.push(registro);
            filasConDatos++;
        } else {
            filasVacias++;
        }
    }
    
    console.log(`‚úÖ Conversi√≥n JSON completada:`);
    console.log(`  - Filas procesadas: ${rango.e.r - rango.s.r}`);
    console.log(`  - Filas con datos: ${filasConDatos}`);
    console.log(`  - Filas vac√≠as: ${filasVacias}`);
    console.log(`  - Registros JSON: ${registros.length}`);
    
    return {
        registros,
        filas: { total: rango.e.r - rango.s.r, conDatos: filasConDatos, vacias: filasVacias },
        rango: { inicio: rango.s, fin: rango.e }
    };
}

// Procesar datos JSON a registros v√°lidos
function procesarDatosJSON(datosJSON) {
    console.log('üîÑ Procesando datos JSON a registros...');
    
    const registros = [];
    let registrosValidos = 0;
    let registrosInvalidos = 0;
    
    for (const dato of datosJSON) {
        try {
            // Extraer fecha (columna B = col1)
            const fechaRaw = dato.col1;
            const fecha = procesarFechaJSON(fechaRaw);
            
            if (!fecha) {
                console.warn(`Fila ${dato.filaOriginal}: Fecha inv√°lida - ${fechaRaw}`);
                registrosInvalidos++;
                continue;
            }
            
            // Extraer datos b√°sicos
            const cajaInicial = procesarNumeroJSON(dato.col2) || 0;
            const observaciones = procesarTextoJSON(dato.col75) || '';
            
            // Extraer ventas (columnas 3-38)
            const ventas = extraerVentasJSON(dato);
            
            // Extraer gastos (columnas 39-56)
            const gastos = extraerGastosJSON(dato);
            
            // Extraer cr√©ditos (columnas 57-74)
            const creditos = extraerCreditosJSON(dato);
            
            // Solo agregar si tiene datos √∫tiles
            if (fecha && (ventas.length > 0 || gastos.length > 0 || creditos.length > 0 || cajaInicial > 0)) {
                registros.push({
                    id: generarUUID(),
                    fecha,
                    cajaInicial,
                    observaciones,
                    ventas,
                    gastos,
                    creditos,
                    filaOriginal: dato.filaOriginal
                });
                registrosValidos++;
            } else {
                console.warn(`Fila ${dato.filaOriginal}: Sin datos suficientes (${fecha}, V:${ventas.length}, G:${gastos.length}, C:${creditos.length})`);
                registrosInvalidos++;
            }
            
        } catch (error) {
            console.error(`Error procesando fila ${dato.filaOriginal}:`, error);
            registrosInvalidos++;
        }
    }
    
    console.log(`üìä Procesamiento JSON completado:`);
    console.log(`  - Registros v√°lidos: ${registrosValidos}`);
    console.log(`  - Registros inv√°lidos: ${registrosInvalidos}`);
    console.log(`  - Total final: ${registros.length}`);
    
    return registros;
}

// Procesar fecha desde JSON
function procesarFechaJSON(valor) {
    if (!valor) return null;
    
    try {
        // Si ya es una fecha
        if (valor instanceof Date) {
            return valor.toISOString().split('T')[0];
        }
        
        // Si es un string
        if (typeof valor === 'string') {
            const fecha = new Date(valor.trim());
            if (!isNaN(fecha.getTime())) {
                return fecha.toISOString().split('T')[0];
            }
        }
        
        // Si es un n√∫mero de Excel (d√≠as desde 1900)
        if (typeof valor === 'number' && valor > 0) {
            const fecha = new Date((valor - 25569) * 86400 * 1000);
            if (!isNaN(fecha.getTime())) {
                return fecha.toISOString().split('T')[0];
            }
        }
    } catch (error) {
        console.warn('Error procesando fecha:', valor, error);
    }
    
    return null;
}

// Procesar n√∫mero desde JSON
function procesarNumeroJSON(valor) {
    if (valor === '' || valor === null || valor === undefined) return 0;
    
    const numero = parseFloat(valor);
    return isNaN(numero) ? 0 : numero;
}

// Procesar texto desde JSON
function procesarTextoJSON(valor) {
    if (valor === null || valor === undefined) return '';
    return String(valor).trim();
}

// Extraer ventas desde JSON (columnas 3-38, grupos de 6)
function extraerVentasJSON(dato) {
    const ventas = [];
    
    for (let v = 0; v < 6; v++) {
        const baseCol = 3 + (v * 6);
        
        const vendedor = procesarTextoJSON(dato[`col${baseCol}`]);
        const ciudad = procesarTextoJSON(dato[`col${baseCol + 1}`]);
        const producto = procesarTextoJSON(dato[`col${baseCol + 2}`]);
        const cantidad = procesarNumeroJSON(dato[`col${baseCol + 3}`]);
        const precio = procesarNumeroJSON(dato[`col${baseCol + 4}`]);
        const total = procesarNumeroJSON(dato[`col${baseCol + 5}`]) || (cantidad * precio);
        
        if (vendedor && ciudad && producto && cantidad > 0 && precio > 0) {
            ventas.push({ vendedor, ciudad, producto, cantidad, precio, total });
        }
    }
    
    return ventas;
}

// Extraer gastos desde JSON (columnas 39-56, grupos de 3)
function extraerGastosJSON(dato) {
    const gastos = [];
    
    for (let g = 0; g < 6; g++) {
        const baseCol = 39 + (g * 3);
        
        const categoria = procesarTextoJSON(dato[`col${baseCol}`]);
        const descripcion = procesarTextoJSON(dato[`col${baseCol + 1}`]);
        const monto = procesarNumeroJSON(dato[`col${baseCol + 2}`]);
        
        if (categoria && monto > 0) {
            gastos.push({ categoria, descripcion, monto });
        }
    }
    
    return gastos;
}

// Extraer cr√©ditos desde JSON (columnas 57-74, grupos de 3)
function extraerCreditosJSON(dato) {
    const creditos = [];
    
    for (let c = 0; c < 6; c++) {
        const baseCol = 57 + (c * 3);
        
        const categoria = procesarTextoJSON(dato[`col${baseCol}`]);
        const detalle = procesarTextoJSON(dato[`col${baseCol + 1}`]);
        const monto = procesarNumeroJSON(dato[`col${baseCol + 2}`]);
        
        if (categoria && monto > 0) {
            creditos.push({ categoria, detalle, monto });
        }
    }
    
    return creditos;
}

// Generar UUID
function generarUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Eliminar datos existentes de Supabase
async function eliminarDatosSupabase() {
    console.log('üóëÔ∏è Eliminando datos existentes de Supabase...');
    
    const client = supabaseClient;
    const { data: records } = await client.from('daily_records').select('id');
    
    if (!records || records.length === 0) {
        console.log('No hay datos para eliminar');
        return;
    }
    
    const ids = records.map(r => r.id);
    console.log(`Eliminando ${ids.length} registros...`);
    
    await client.from('sales').delete().in('daily_record_id', ids);
    await client.from('expenses').delete().in('daily_record_id', ids);
    await client.from('credits').delete().in('daily_record_id', ids);
    await client.from('daily_records').delete().in('id', ids);
    
    console.log('‚úÖ Datos eliminados');
}

// Subir datos JSON a Supabase
async function subirDatosJSON(registros, userId) {
    console.log(`üöÄ Subiendo ${registros.length} registros desde JSON...`);
    
    const client = supabaseClient;
    let exitosos = 0;
    let errores = 0;
    const erroresDetalle = [];
    
    for (let i = 0; i < registros.length; i++) {
        const registro = registros[i];
        
        try {
            console.log(`üìù [${i+1}/${registros.length}] JSON->DB: ${registro.fecha} (Fila ${registro.filaOriginal})`);
            
            // Crear daily_record
            const { data: dailyRecord, error: errorDaily } = await client
                .from('daily_records')
                .insert({
                    id: registro.id,
                    fecha: registro.fecha,
                    caja_inicial: registro.cajaInicial,
                    observaciones: registro.observaciones,
                    created_by: userId,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .select()
                .single();
            
            if (errorDaily) throw errorDaily;
            
            const recordId = dailyRecord.id;
            
            // Insertar sales, expenses, credits
            if (registro.ventas.length > 0) {
                const salesData = registro.ventas.map((venta, idx) => ({
                    id: generarUUID(),
                    daily_record_id: recordId,
                    vendedor: venta.vendedor,
                    ciudad: venta.ciudad,
                    producto: venta.producto,
                    cantidad: venta.cantidad,
                    precio: venta.precio,
                    total: venta.total,
                    orden: idx + 1,
                    created_at: new Date().toISOString()
                }));
                
                const { error: errorSales } = await client.from('sales').insert(salesData);
                if (errorSales) throw errorSales;
            }
            
            if (registro.gastos.length > 0) {
                const expensesData = registro.gastos.map((gasto, idx) => ({
                    id: generarUUID(),
                    daily_record_id: recordId,
                    categoria: gasto.categoria,
                    descripcion: gasto.descripcion,
                    monto: gasto.monto,
                    orden: idx + 1,
                    created_at: new Date().toISOString()
                }));
                
                const { error: errorExpenses } = await client.from('expenses').insert(expensesData);
                if (errorExpenses) throw errorExpenses;
            }
            
            if (registro.creditos.length > 0) {
                const creditsData = registro.creditos.map((credito, idx) => ({
                    id: generarUUID(),
                    daily_record_id: recordId,
                    categoria: credito.categoria,
                    detalle: credito.detalle,
                    monto: credito.monto,
                    orden: idx + 1,
                    created_at: new Date().toISOString()
                }));
                
                const { error: errorCredits } = await client.from('credits').insert(creditsData);
                if (errorCredits) throw errorCredits;
            }
            
            exitosos++;
            console.log(`‚úÖ ${registro.fecha}: ${registro.ventas.length}V ${registro.gastos.length}G ${registro.creditos.length}C`);
            
            const progreso = 70 + ((exitosos / registros.length) * 25);
            actualizarProgresoJSON(progreso, `${exitosos}/${registros.length} registros`);
            
            await new Promise(resolve => setTimeout(resolve, 50));
            
        } catch (error) {
            errores++;
            const errorMsg = `Fila ${registro.filaOriginal} (${registro.fecha}): ${error.message}`;
            erroresDetalle.push(errorMsg);
            console.error(`‚ùå ${errorMsg}`);
        }
    }
    
    console.log(`üìä RESULTADO JSON: ${exitosos} exitosos, ${errores} errores`);
    return { exitosos, errores };
}

// ===== INTERFAZ DE PROGRESO =====
function mostrarProgresoJSON() {
    const div = document.createElement('div');
    div.id = 'progresoJSON';
    div.innerHTML = `
        <div style="
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 20000;
            min-width: 450px; border: 3px solid #0ea5e9;
        ">
            <h3 style="margin: 0 0 20px 0; text-align: center; color: #0ea5e9;">
                üìä Procesador Excel-to-JSON
            </h3>
            <div style="background: #f0f0f0; height: 25px; border-radius: 12px; overflow: hidden; margin-bottom: 15px; position: relative;">
                <div id="barraJSON" style="height: 100%; background: linear-gradient(90deg, #0ea5e9, #0284c7); width: 0%; transition: width 0.5s;"></div>
                <div id="porcentajeJSON" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #374151; font-weight: bold;">0%</div>
            </div>
            <p id="textoJSON" style="margin: 0; text-align: center; color: #374151; font-size: 14px;">Iniciando conversi√≥n Excel-to-JSON...</p>
        </div>
    `;
    document.body.appendChild(div);
}

function actualizarProgresoJSON(porcentaje, mensaje) {
    const barra = document.getElementById('barraJSON');
    const texto = document.getElementById('textoJSON');
    const porciento = document.getElementById('porcentajeJSON');
    
    if (barra) barra.style.width = `${porcentaje}%`;
    if (texto) texto.textContent = mensaje;
    if (porciento) porciento.textContent = `${Math.round(porcentaje)}%`;
}

function ocultarProgresoJSON() {
    const div = document.getElementById('progresoJSON');
    if (div) div.remove();
}

// ===== INTERFAZ PRINCIPAL =====
function crearInterfazJSON() {
    const container = document.getElementById('importContainer') || document.body;
    
    const existente = container.querySelector('.interfaz-json');
    if (existente) existente.remove();
    
    const interfaz = document.createElement('div');
    interfaz.className = 'interfaz-json';
    interfaz.innerHTML = `
        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: white; margin: 0 0 10px 0; font-size: 24px;">üìä Procesador Excel-to-JSON</h2>
                <p style="color: rgba(255,255,255,0.9); margin: 0;">Convierte Excel a JSON y maneja celdas vac√≠as correctamente</p>
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600; color: white; font-size: 16px;">
                    üìÅ Archivo Excel para procesamiento JSON:
                </label>
                <input type="file" id="archivoExcelJSON" accept=".xlsx,.xls" 
                       style="padding: 12px; border: none; border-radius: 8px; width: 100%; background: white; color: #374151; font-size: 14px;">
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: white; margin: 0 0 10px 0;">üîß Mejoras del Procesador JSON:</h4>
                <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.9); font-size: 14px;">
                    <li><strong>Manejo robusto de celdas vac√≠as</strong> - No m√°s undefined</li>
                    <li><strong>Conversi√≥n Excel-to-JSON limpia</strong> - Datos consistentes</li>
                    <li><strong>Procesamiento de fechas mejorado</strong> - M√∫ltiples formatos</li>
                    <li><strong>Validaci√≥n de datos por tipo</strong> - N√∫meros, textos, fechas</li>
                    <li><strong>Logging detallado por fila</strong> - Identifica problemas exactos</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="importarConProcesadorJSON()" 
                        style="background: #1f2937; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(31, 41, 55, 0.3);">
                    üöÄ Procesar con JSON
                </button>
                
                <button onclick="this.closest('.interfaz-json').remove()" 
                        style="background: #6b7280; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ‚ùå Cerrar
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(interfaz);
}

// Hacer disponible globalmente
if (typeof window !== 'undefined') {
    window.importarConProcesadorJSON = importarConProcesadorJSON;
    window.crearInterfazJSON = crearInterfazJSON;
    
    console.log('‚úÖ PROCESADOR EXCEL-TO-JSON cargado');
    console.log('üìä Maneja celdas vac√≠as y convierte a JSON limpio');
}
</script>

<!-- FUNCI√ìN DE IMPORTACI√ìN REAL -->
<script>
// üöÄ IMPORTADOR DE EXCEL MEJORADO - AGUA ZAFIRO
// Versi√≥n corregida que maneja correctamente los conflictos de Supabase

// Funci√≥n para generar UUID v4 compatible
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Funci√≥n principal de importaci√≥n mejorada
async function iniciarImportacionMejorada() {
    console.log('üîÑ Iniciando importaci√≥n MEJORADA...');
    
    const currentUser = SupabaseAuth.getCurrentUser();
    if (!currentUser || currentUser.role !== 'admin') {
        alert('‚ùå Solo los administradores pueden importar datos hist√≥ricos');
        return;
    }

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.xlsx,.xls';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) {
            document.body.removeChild(fileInput);
            return;
        }

        // Opciones de importaci√≥n
        const opciones = confirm(
            `üìä IMPORTACI√ìN DE DATOS HIST√ìRICOS\n\n` +
            `Archivo: ${file.name}\n` +
            `Tama√±o: ${Math.round(file.size/1024)} KB\n\n` +
            `OPCIONES:\n` +
            `‚úÖ Aceptar = ACTUALIZAR registros existentes\n` +
            `‚ùå Cancelar = SOLO AGREGAR nuevos registros\n\n` +
            `¬øDesea ACTUALIZAR registros que ya existen?`
        );

        if (opciones === null) {
            document.body.removeChild(fileInput);
            return;
        }

        const modoActualizacion = opciones;

        try {
            // Crear interfaz de progreso mejorada
            const progressContainer = document.createElement('div');
            progressContainer.innerHTML = `
                <div style="
                    position: fixed; 
                    top: 20px; 
                    right: 20px; 
                    background: white; 
                    padding: 30px; 
                    border-radius: 15px; 
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
                    z-index: 10000; 
                    min-width: 450px;
                    max-width: 500px;
                    border: 2px solid #3b82f6;
                ">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="
                            width: 40px; 
                            height: 40px; 
                            background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            margin-right: 15px;
                        ">
                            <i class="fas fa-upload" style="color: white; font-size: 18px;"></i>
                        </div>
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px;">üöÄ Importaci√≥n en Progreso</h3>
                    </div>
                    
                    <div style="background: #f3f4f6; height: 28px; border-radius: 14px; overflow: hidden; margin-bottom: 15px; position: relative;">
                        <div id="progressBarMejorado" style="
                            height: 100%; 
                            background: linear-gradient(90deg, #10b981, #059669); 
                            width: 0%; 
                            transition: width 0.3s ease;
                            border-radius: 14px;
                        "></div>
                        <div id="progressPercent" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            color: #374151;
                            font-weight: bold;
                            font-size: 14px;
                        ">0%</div>
                    </div>
                    
                    <p id="progressTextMejorado" style="margin: 0 0 10px 0; color: #374151; font-weight: 500;">Iniciando...</p>
                    <div id="progressStats" style="
                        display: grid; 
                        grid-template-columns: 1fr 1fr; 
                        gap: 10px; 
                        margin-bottom: 15px;
                        font-size: 13px;
                    ">
                        <div style="background: #e5e7eb; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: bold; color: #059669;" id="procesados">0</div>
                            <div style="color: #6b7280;">Procesados</div>
                        </div>
                        <div style="background: #e5e7eb; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-weight: bold; color: #dc2626;" id="errores">0</div>
                            <div style="color: #6b7280;">Errores</div>
                        </div>
                    </div>
                    
                    <p id="progressDetails" style="margin: 0; font-size: 13px; color: #6b7280; min-height: 18px;"></p>
                    
                    <button id="cancelarImportacion" style="
                        display: none;
                        width: 100%;
                        padding: 10px;
                        background: #dc2626;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        margin-top: 15px;
                    ">‚ùå Cancelar Importaci√≥n</button>
                </div>
            `;
            document.body.appendChild(progressContainer);

            const progressBar = document.getElementById('progressBarMejorado');
            const progressText = document.getElementById('progressTextMejorado');
            const progressDetails = document.getElementById('progressDetails');
            const progressPercent = document.getElementById('progressPercent');
            const procesadosCount = document.getElementById('procesados');
            const erroresCount = document.getElementById('errores');

            let cancelado = false;
            document.getElementById('cancelarImportacion').onclick = () => {
                cancelado = true;
                progressText.textContent = 'Cancelando...';
            };

            // PASO 1: Leer Excel
            progressText.textContent = 'üìñ Leyendo archivo Excel...';
            progressDetails.textContent = 'Procesando estructura del archivo';
            progressBar.style.width = '10%';
            progressPercent.textContent = '10%';
            
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { 
                cellDates: true,
                cellNF: false,
                cellHTML: false
            });
            
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            progressText.textContent = 'üîç Analizando datos...';
            progressDetails.textContent = `${rawData.length} filas encontradas`;
            progressBar.style.width = '20%';
            progressPercent.textContent = '20%';

            // PASO 2: Procesar y validar registros
            const registros = [];
            const erroresValidacion = [];

            for (let i = 1; i < rawData.length && !cancelado; i++) {
                const row = rawData[i];
                
                // Validar que tenga datos m√≠nimos
                if (!row || !row[1] || row.length < 3) {
                    erroresValidacion.push(`Fila ${i + 1}: Datos insuficientes`);
                    continue;
                }
                
                try {
                    // Procesar fecha con m√∫ltiples formatos
                    let fecha;
                    const fechaRaw = row[1];
                    
                    if (fechaRaw instanceof Date) {
                        fecha = fechaRaw.toISOString().split('T')[0];
                    } else if (typeof fechaRaw === 'string') {
                        const fechaTest = new Date(fechaRaw);
                        if (!isNaN(fechaTest.getTime())) {
                            fecha = fechaTest.toISOString().split('T')[0];
                        }
                    } else if (typeof fechaRaw === 'number') {
                        // Excel date serial number
                        const excelDate = new Date((fechaRaw - 25569) * 86400 * 1000);
                        fecha = excelDate.toISOString().split('T')[0];
                    }
                    
                    if (!fecha || fecha === 'Invalid Date') {
                        erroresValidacion.push(`Fila ${i + 1}: Fecha inv√°lida (${fechaRaw})`);
                        continue;
                    }
                    
                    // Crear registro con estructura completa
                    const registro = {
                        id: generateUUID(),
                        fecha: fecha,
                        caja_inicial: parseFloat(row[2]) || 0,
                        observaciones: (row[75] || '').toString().trim().substring(0, 500), // Limitar longitud
                        created_by: currentUser.id,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    registros.push(registro);
                    
                } catch (error) {
                    erroresValidacion.push(`Fila ${i + 1}: Error procesando - ${error.message}`);
                }
            }

            if (cancelado) {
                progressContainer.remove();
                return;
            }

            progressText.textContent = '‚úÖ Validaci√≥n completada';
            progressDetails.textContent = `${registros.length} registros v√°lidos, ${erroresValidacion.length} errores`;
            progressBar.style.width = '40%';
            progressPercent.textContent = '40%';

            // PASO 3: Procesar por lotes en Supabase
            progressText.textContent = 'üíæ Guardando en Supabase...';
            progressDetails.textContent = 'Procesando en lotes de 10 registros';

            let procesados = 0;
            let errores = 0;
            const batchSize = 10;
            const erroresSupabase = [];

            for (let i = 0; i < registros.length && !cancelado; i += batchSize) {
                const batch = registros.slice(i, i + batchSize);
                
                try {
                    if (modoActualizacion) {
                        // Modo UPSERT: actualizar si existe, crear si no existe
                        const { data, error } = await supabaseClient
                            .from('registros_diarios')
                            .upsert(batch, { 
                                onConflict: 'fecha',
                                ignoreDuplicates: false 
                            });
                        
                        if (error) {
                            console.error('Error en upsert:', error);
                            erroresSupabase.push(`Lote ${Math.floor(i/batchSize) + 1}: ${error.message}`);
                            errores += batch.length;
                        } else {
                            procesados += batch.length;
                        }
                    } else {
                        // Modo SOLO INSERTAR: ignorar duplicados
                        const { data, error } = await supabaseClient
                            .from('daily_records')
                            .insert(batch)
                            .select();
                        
                        if (error) {
                            // Si es error de conflicto, intentar uno por uno
                            if (error.code === '23505' || error.message.includes('duplicate')) {
                                for (const registro of batch) {
                                    try {
                                        const { error: singleError } = await supabaseClient
                                            .from('daily_records')
                                            .insert(registro);
                                        
                                        if (!singleError) {
                                            procesados++;
                                        } else if (!singleError.message.includes('duplicate')) {
                                            errores++;
                                            erroresSupabase.push(`Fecha ${registro.fecha}: ${singleError.message}`);
                                        }
                                    } catch (e) {
                                        errores++;
                                    }
                                }
                            } else {
                                console.error('Error en insert:', error);
                                erroresSupabase.push(`Lote ${Math.floor(i/batchSize) + 1}: ${error.message}`);
                                errores += batch.length;
                            }
                        } else {
                            procesados += batch.length;
                        }
                    }
                    
                } catch (error) {
                    console.error('Error inesperado:', error);
                    erroresSupabase.push(`Lote ${Math.floor(i/batchSize) + 1}: Error inesperado`);
                    errores += batch.length;
                }
                
                // Actualizar progreso
                const progreso = Math.min(95, 40 + ((i + batchSize) / registros.length) * 50);
                progressBar.style.width = progreso + '%';
                progressPercent.textContent = Math.round(progreso) + '%';
                procesadosCount.textContent = procesados;
                erroresCount.textContent = errores;
                progressDetails.textContent = `Procesando lote ${Math.floor(i/batchSize) + 1} de ${Math.ceil(registros.length/batchSize)}`;
                
                // Pausa peque√±a para no saturar Supabase
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            if (cancelado) {
                progressContainer.remove();
                return;
            }

            // FINALIZACI√ìN
            progressText.textContent = 'üéâ ¬°Importaci√≥n Completada!';
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            procesadosCount.textContent = procesados;
            erroresCount.textContent = errores;
            
            const resumen = [
                `üìä RESUMEN DE IMPORTACI√ìN`,
                ``,
                `‚úÖ Registros procesados: ${procesados}`,
                `‚ùå Errores: ${errores}`,
                `üìù Total filas en Excel: ${rawData.length - 1}`,
                ``,
                `Modo: ${modoActualizacion ? 'Actualizaci√≥n' : 'Solo nuevos'}`
            ];

            progressDetails.innerHTML = resumen.join('<br>');

            // Mostrar errores si los hay
            if (erroresValidacion.length > 0 || erroresSupabase.length > 0) {
                console.group('üîç Errores de importaci√≥n:');
                console.log('Errores de validaci√≥n:', erroresValidacion);
                console.log('Errores de Supabase:', erroresSupabase);
                console.groupEnd();
            }

            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                if (progressContainer.parentNode) {
                    progressContainer.remove();
                }
                
                // Mostrar resumen final
                alert(
                    `üéâ IMPORTACI√ìN COMPLETADA\n\n` +
                    `‚úÖ ${procesados} registros procesados exitosamente\n` +
                    `${errores > 0 ? `‚ùå ${errores} registros con errores\n` : ''}` +
                    `\nüìä Revisa la consola para m√°s detalles`
                );
                
                // Recargar p√°gina para mostrar nuevos datos
                if (procesados > 0) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            }, 5000);

        } catch (error) {
            console.error('‚ùå Error general:', error);
            alert(`Error durante la importaci√≥n: ${error.message}`);
            
            // Limpiar interfaz si existe
            const progressContainer = document.querySelector('[style*="position: fixed"]');
            if (progressContainer) {
                progressContainer.remove();
            }
        }

        document.body.removeChild(fileInput);
    };

    fileInput.click();
}

// Funci√≥n auxiliar para limpiar datos de texto
function limpiarTexto(texto) {
    if (!texto) return '';
    return String(texto)
        .trim()
        .replace(/[\r\n\t]/g, ' ')
        .replace(/\s+/g, ' ')
        .substring(0, 500);
}

// Funci√≥n auxiliar para validar y limpiar n√∫meros
function limpiarNumero(valor, porDefecto = 0) {
    if (valor === null || valor === undefined || valor === '') return porDefecto;
    const numero = parseFloat(valor);
    return isNaN(numero) ? porDefecto : numero;
}

// Reemplazar la funci√≥n original del HTML
window.iniciarImportacionDirecta = iniciarImportacionMejorada;

// Tambi√©n hacer disponible para uso directo
window.iniciarImportacionMejorada = iniciarImportacionMejorada;

console.log('‚úÖ Importador Excel mejorado cargado correctamente');

console.log('‚úÖ Funci√≥n de importaci√≥n REAL cargada');
</script>

<div id="importContainer"></div>
<!-- CONSOLIDADOR COMPLETO AGUA ZAFIRO -->
<script>
// üöÄ CONSOLIDADOR COMPLETO AGUA ZAFIRO
// Importa Excel, consolida registros duplicados por fecha, sube a Supabase

console.log('üîÑ Cargando Consolidador Completo Agua Zafiro...');

// ===== FUNCI√ìN PRINCIPAL =====
async function consolidarImportacionCompleta() {
    console.log('üîÑ === INICIANDO CONSOLIDACI√ìN COMPLETA ===');
    
    try {
        // Verificar permisos
        const usuario = SupabaseAuth?.getCurrentUser();
        if (!usuario || usuario.role !== 'admin') {
            alert('‚ùå Solo administradores pueden importar datos hist√≥ricos');
            return;
        }
        
        // Seleccionar archivo
        const archivo = await seleccionarArchivo();
        if (!archivo) return;
        
        // Confirmar proceso
        const proceder = confirm(
            `üîÑ CONSOLIDADOR AGUA ZAFIRO\n\n` +
            `Archivo: ${archivo.name}\n` +
            `Tama√±o: ${Math.round(archivo.size/1024)} KB\n\n` +
            `PROCESO:\n` +
            `‚úÖ Leer Excel y agrupar por fecha\n` +
            `‚úÖ Consolidar registros duplicados\n` +
            `‚úÖ Sumar ventas, gastos y cr√©ditos\n` +
            `‚úÖ Usar caja inicial correcta\n` +
            `‚úÖ Subir a Supabase\n\n` +
            `¬øContinuar con la consolidaci√≥n?`
        );
        
        if (!proceder) return;
        
        // Crear interfaz de progreso
        const interfazProgreso = crearInterfazProgreso();
        
        try {
            // PASO 1: Leer Excel
            actualizarProgreso(interfazProgreso, 10, 'Leyendo archivo Excel...');
            const datosExcel = await leerExcelCompleto(archivo);
            
            // PASO 2: Agrupar por fecha
            actualizarProgreso(interfazProgreso, 25, 'Agrupando registros por fecha...');
            const gruposPorFecha = agruparPorFecha(datosExcel);
            
            // PASO 3: Consolidar grupos
            actualizarProgreso(interfazProgreso, 40, 'Consolidando registros duplicados...');
            const registrosConsolidados = consolidarGrupos(gruposPorFecha);
            
            // PASO 4: Limpiar Supabase (opcional)
            const limpiar = confirm('¬øEliminar datos existentes en Supabase primero?');
            if (limpiar) {
                actualizarProgreso(interfazProgreso, 55, 'Limpiando datos existentes...');
                await limpiarSupabase();
            }
            
            // PASO 5: Subir a Supabase
            actualizarProgreso(interfazProgreso, 70, 'Subiendo registros consolidados...');
            const resultado = await subirRegistrosConsolidados(registrosConsolidados, usuario.id);
            
            // FINALIZAR
            actualizarProgreso(interfazProgreso, 100, 'üéâ ¬°Consolidaci√≥n completada!');
            
            setTimeout(() => {
                cerrarInterfazProgreso(interfazProgreso);
                mostrarResumenFinal(datosExcel, registrosConsolidados, resultado);
                
                if (resultado.exitosos > 0 && confirm('¬øRecargar p√°gina para ver los datos?')) {
                    window.location.reload();
                }
            }, 3000);
            
        } catch (error) {
            cerrarInterfazProgreso(interfazProgreso);
            throw error;
        }
        
    } catch (error) {
        console.error('‚ùå ERROR CONSOLIDACI√ìN:', error);
        alert(`Error durante la consolidaci√≥n: ${error.message}`);
    }
}

// ===== FUNCIONES DE EXCEL =====
// FUNCI√ìN CORREGIDA - seleccionarArchivo()
async function seleccionarArchivo() {
    return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls';
        input.style.display = 'none';
        
        let resuelto = false; // Flag para evitar resolver m√∫ltiples veces
        
        const limpiarYResolver = (archivo) => {
            if (resuelto) return;
            resuelto = true;
            
            // Remover input de manera segura
            try {
                if (input.parentNode) {
                    input.parentNode.removeChild(input);
                }
            } catch (error) {
                console.log('Input ya removido');
            }
            
            resolve(archivo);
        };
        
        input.onchange = (e) => {
            const archivo = e.target.files[0];
            limpiarYResolver(archivo);
        };
        
        // Manejar cancelaci√≥n
        input.oncancel = () => {
            limpiarYResolver(null);
        };
        
        // Backup para cancelaci√≥n (algunos navegadores)
        setTimeout(() => {
            if (!resuelto) {
                limpiarYResolver(null);
            }
        }, 30000); // 30 segundos timeout
        
        document.body.appendChild(input);
        input.click();
    });
}

async function leerExcelCompleto(archivo) {
    console.log('üìñ Leyendo Excel...');
    
    const buffer = await archivo.arrayBuffer();
    const workbook = XLSX.read(buffer, {
        cellDates: true,
        cellNF: false,
        raw: false,
        defval: ''
    });
    
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    
    // Filtrar solo filas con datos
    const registros = [];
    for (let i = 1; i < jsonData.length; i++) {
        const fila = jsonData[i];
        if (fila && fila[1] && (fila[2] > 0 || tieneVentas(fila) || tieneGastos(fila) || tieneCreditos(fila))) {
            registros.push({
                fila: i + 1,
                datos: fila
            });
        }
    }
    
    console.log(`‚úÖ Excel le√≠do: ${registros.length} registros v√°lidos`);
    return registros;
}

function tieneVentas(fila) {
    // Verificar si tiene al menos una venta (vendedor, cantidad, precio)
    for (let v = 0; v < 6; v++) {
        const baseCol = 3 + (v * 6); // Columnas D, J, P, V, AB, AH
        if (fila[baseCol] && fila[baseCol + 3] > 0 && fila[baseCol + 4] > 0) {
            return true;
        }
    }
    return false;
}

function tieneGastos(fila) {
    // Verificar si tiene al menos un gasto (categor√≠a, monto)
    for (let g = 0; g < 6; g++) {
        const baseCol = 39 + (g * 3); // Columnas AN, AQ, AT, AW, AZ, BC
        if (fila[baseCol] && fila[baseCol + 2] > 0) {
            return true;
        }
    }
    return false;
}

function tieneCreditos(fila) {
    // Verificar si tiene al menos un cr√©dito (nombre, monto)
    for (let c = 0; c < 6; c++) {
        const baseCol = 57 + (c * 3); // Columnas BF, BI, BL, BO, BR, BU
        if (fila[baseCol] && fila[baseCol + 2] > 0) {
            return true;
        }
    }
    return false;
}

// ===== FUNCIONES DE AGRUPACI√ìN =====
function agruparPorFecha(registros) {
    console.log('üìÖ Agrupando por fecha...');
    
    const grupos = {};
    
    for (const registro of registros) {
        const fecha = new Date(registro.datos[1]).toISOString().split('T')[0];
        
        if (!grupos[fecha]) {
            grupos[fecha] = [];
        }
        
        grupos[fecha].push(registro);
    }
    
    const fechasUnicas = Object.keys(grupos).length;
    const fechasDuplicadas = Object.keys(grupos).filter(f => grupos[f].length > 1).length;
    
    console.log(`‚úÖ Agrupaci√≥n completada:`);
    console.log(`- Fechas √∫nicas: ${fechasUnicas}`);
    console.log(`- Fechas con duplicados: ${fechasDuplicadas}`);
    
    return grupos;
}

// ===== FUNCIONES DE CONSOLIDACI√ìN =====
function consolidarGrupos(grupos) {
    console.log('üîÑ Consolidando grupos...');
    
    const registrosConsolidados = [];
    
    for (const [fecha, registros] of Object.entries(grupos)) {
        const consolidado = consolidarRegistrosPorFecha(fecha, registros);
        registrosConsolidados.push(consolidado);
    }
    
    console.log(`‚úÖ ${registrosConsolidados.length} registros consolidados`);
    return registrosConsolidados;
}

function consolidarRegistrosPorFecha(fecha, registros) {
    console.log(`üìù Consolidando ${fecha}: ${registros.length} registros`);
    
    // Obtener caja inicial (usar el valor > 0)
    let cajaInicial = 0;
    for (const registro of registros) {
        if (registro.datos[2] > 0) {
            cajaInicial = registro.datos[2];
            break;
        }
    }
    
    // Consolidar observaciones
    const observaciones = registros
        .map(r => r.datos[75])
        .filter(obs => obs && obs.trim())
        .join(' | ');
    
    // Consolidar ventas
    const ventas = [];
    for (const registro of registros) {
        const ventasRegistro = extraerVentas(registro.datos);
        ventas.push(...ventasRegistro);
    }
    
    // Consolidar gastos
    const gastos = [];
    for (const registro of registros) {
        const gastosRegistro = extraerGastos(registro.datos);
        gastos.push(...gastosRegistro);
    }
    
    // Consolidar cr√©ditos
    const creditos = [];
    for (const registro of registros) {
        const creditosRegistro = extraerCreditos(registro.datos);
        creditos.push(...creditosRegistro);
    }
    
    return {
        id: generarUUID(),
        fecha,
        cajaInicial,
        observaciones: observaciones.substring(0, 500), // Limitar longitud
        ventas,
        gastos,
        creditos,
        registrosOriginales: registros.length
    };
}

function extraerVentas(fila) {
    const ventas = [];
    
    for (let v = 0; v < 6; v++) {
        const baseCol = 3 + (v * 6);
        
        const vendedor = limpiarTexto(fila[baseCol]);
        const ciudad = limpiarTexto(fila[baseCol + 1]);
        const producto = limpiarTexto(fila[baseCol + 2]);
        const cantidad = limpiarNumero(fila[baseCol + 3]);
        const precio = limpiarNumero(fila[baseCol + 4]);
        const total = limpiarNumero(fila[baseCol + 5]) || (cantidad * precio);
        
        if (vendedor && ciudad && producto && cantidad > 0 && precio > 0) {
            ventas.push({
                vendedor,
                ciudad,
                producto,
                cantidad,
                precio,
                total
            });
        }
    }
    
    return ventas;
}

function extraerGastos(fila) {
    const gastos = [];
    
    for (let g = 0; g < 6; g++) {
        const baseCol = 39 + (g * 3);
        
        const categoria = limpiarTexto(fila[baseCol]);
        const descripcion = limpiarTexto(fila[baseCol + 1]);
        const monto = limpiarNumero(fila[baseCol + 2]);
        
        if (categoria && monto > 0) {
            gastos.push({
                categoria,
                descripcion: descripcion || '',
                monto
            });
        }
    }
    
    return gastos;
}

function extraerCreditos(fila) {
    const creditos = [];
    
    for (let c = 0; c < 6; c++) {
        const baseCol = 57 + (c * 3);
        
        const categoria = limpiarTexto(fila[baseCol]);
        const detalle = limpiarTexto(fila[baseCol + 1]);
        const monto = limpiarNumero(fila[baseCol + 2]);
        
        if (categoria && monto > 0) {
            creditos.push({
                categoria,
                detalle: detalle || '',
                monto
            });
        }
    }
    
    return creditos;
}

// ===== FUNCIONES DE SUPABASE =====
async function limpiarSupabase() {
    console.log('üóëÔ∏è Limpiando Supabase...');
    
    const client = supabaseClient;
    
    // Obtener todos los daily_records
    const { data: records } = await client
        .from('daily_records')
        .select('id');
    
    if (!records || records.length === 0) {
        console.log('No hay datos para limpiar');
        return;
    }
    
    const ids = records.map(r => r.id);
    console.log(`Eliminando ${ids.length} registros...`);
    
    // Eliminar en orden correcto (relaciones)
    await client.from('sales').delete().in('daily_record_id', ids);
    await client.from('expenses').delete().in('daily_record_id', ids);
    await client.from('credits').delete().in('daily_record_id', ids);
    await client.from('daily_records').delete().in('id', ids);
    
    console.log('‚úÖ Limpieza completada');
}

async function subirRegistrosConsolidados(registros, userId) {
    console.log(`üöÄ Subiendo ${registros.length} registros consolidados...`);
    
    const client = supabaseClient;
    let exitosos = 0;
    let errores = 0;
    
    for (let i = 0; i < registros.length; i++) {
        const registro = registros[i];
        
        try {
            console.log(`üìù [${i+1}/${registros.length}] Subiendo: ${registro.fecha}`);
            
            // Crear daily_record
            const { data: dailyRecord, error: errorDaily } = await client
                .from('daily_records')
                .insert({
                    id: registro.id,
                    fecha: registro.fecha,
                    caja_inicial: registro.cajaInicial,
                    observaciones: registro.observaciones,
                    created_by: userId,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .select()
                .single();
            
            if (errorDaily) throw errorDaily;
            
            const recordId = dailyRecord.id;
            
            // Subir ventas
            if (registro.ventas.length > 0) {
                const salesData = registro.ventas.map((venta, idx) => ({
                    id: generarUUID(),
                    daily_record_id: recordId,
                    vendedor: venta.vendedor,
                    ciudad: venta.ciudad,
                    producto: venta.producto,
                    cantidad: venta.cantidad,
                    precio: venta.precio,
                    total: venta.total,
                    orden: idx + 1,
                    created_at: new Date().toISOString()
                }));
                
                const { error: errorSales } = await client.from('sales').insert(salesData);
                if (errorSales) throw errorSales;
            }
            
            // Subir gastos
            if (registro.gastos.length > 0) {
                const expensesData = registro.gastos.map((gasto, idx) => ({
                    id: generarUUID(),
                    daily_record_id: recordId,
                    categoria: gasto.categoria,
                    descripcion: gasto.descripcion,
                    monto: gasto.monto,
                    orden: idx + 1,
                    created_at: new Date().toISOString()
                }));
                
                const { error: errorExpenses } = await client.from('expenses').insert(expensesData);
                if (errorExpenses) throw errorExpenses;
            }
            
            // Subir cr√©ditos
            if (registro.creditos.length > 0) {
                const creditsData = registro.creditos.map((credito, idx) => ({
                    id: generarUUID(),
                    daily_record_id: recordId,
                    categoria: credito.categoria,
                    detalle: credito.detalle,
                    monto: credito.monto,
                    orden: idx + 1,
                    created_at: new Date().toISOString()
                }));
                
                const { error: errorCredits } = await client.from('credits').insert(creditsData);
                if (errorCredits) throw errorCredits;
            }
            
            exitosos++;
            console.log(`‚úÖ ${registro.fecha}: ${registro.ventas.length}V ${registro.gastos.length}G ${registro.creditos.length}C`);
            
            // Pausa peque√±a
            await new Promise(resolve => setTimeout(resolve, 100));
            
        } catch (error) {
            errores++;
            console.error(`‚ùå Error ${registro.fecha}:`, error.message);
        }
    }
    
    console.log(`üìä RESULTADO: ${exitosos} exitosos, ${errores} errores`);
    return { exitosos, errores };
}

// ===== FUNCIONES AUXILIARES =====
function limpiarTexto(valor) {
    if (!valor) return '';
    return String(valor).trim().substring(0, 255);
}

function limpiarNumero(valor) {
    if (valor === null || valor === undefined || valor === '') return 0;
    const numero = parseFloat(valor);
    return isNaN(numero) ? 0 : numero;
}

function generarUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0;
        var v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// ===== INTERFAZ DE PROGRESO =====
function crearInterfazProgreso() {
    const div = document.createElement('div');
    div.id = 'consolidadorProgreso';
    div.innerHTML = `
        <div style="
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 30000;
            min-width: 500px; border: 3px solid #059669;
        ">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: #059669; margin: 0 0 10px 0;">üîÑ Consolidador Agua Zafiro</h2>
                <p style="color: #6b7280; margin: 0;">Procesando registros duplicados...</p>
            </div>
            
            <div style="background: #f3f4f6; height: 30px; border-radius: 15px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <div id="barraConsolidacion" style="height: 100%; background: linear-gradient(90deg, #059669, #047857); width: 0%; transition: width 0.3s;"></div>
                <div id="porcentajeConsolidacion" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">0%</div>
            </div>
            
            <p id="textoConsolidacion" style="margin: 0; text-align: center; color: #374151; font-weight: 500;">Iniciando consolidaci√≥n...</p>
        </div>
    `;
    document.body.appendChild(div);
    return div;
}

function actualizarProgreso(interfaz, porcentaje, mensaje) {
    const barra = interfaz.querySelector('#barraConsolidacion');
    const texto = interfaz.querySelector('#textoConsolidacion');
    const porciento = interfaz.querySelector('#porcentajeConsolidacion');
    
    if (barra) barra.style.width = `${porcentaje}%`;
    if (texto) texto.textContent = mensaje;
    if (porciento) porciento.textContent = `${Math.round(porcentaje)}%`;
}

function cerrarInterfazProgreso(interfaz) {
    if (interfaz && interfaz.parentNode) {
        interfaz.parentNode.removeChild(interfaz);
    }
}

function mostrarResumenFinal(datosExcel, registrosConsolidados, resultado) {
    const totalVentas = registrosConsolidados.reduce((sum, r) => sum + r.ventas.length, 0);
    const totalGastos = registrosConsolidados.reduce((sum, r) => sum + r.gastos.length, 0);
    const totalCreditos = registrosConsolidados.reduce((sum, r) => sum + r.creditos.length, 0);
    
    alert(
        `üéâ CONSOLIDACI√ìN COMPLETADA\n\n` +
        `üìä RESUMEN:\n` +
        `‚úÖ Registros Excel: ${datosExcel.length}\n` +
        `‚úÖ Fechas consolidadas: ${registrosConsolidados.length}\n` +
        `‚úÖ Subidos exitosamente: ${resultado.exitosos}\n` +
        `‚ùå Errores: ${resultado.errores}\n\n` +
        `üìà DATOS PROCESADOS:\n` +
        `‚Ä¢ Ventas: ${totalVentas}\n` +
        `‚Ä¢ Gastos: ${totalGastos}\n` +
        `‚Ä¢ Cr√©ditos: ${totalCreditos}`
    );
}

// ===== EXPORTAR FUNCI√ìN PRINCIPAL =====
// Reemplazar la funci√≥n del bot√≥n de importaci√≥n
if (typeof window !== 'undefined') {
    window.iniciarImportacionDirecta = consolidarImportacionCompleta;
    window.consolidarImportacionCompleta = consolidarImportacionCompleta;
    
    console.log('‚úÖ CONSOLIDADOR AGUA ZAFIRO CARGADO');
    console.log('üîÑ Maneja duplicados, consolida por fecha, sube a Supabase');
    console.log('üìû Usar: consolidarImportacionCompleta()');
}
</script>
<!-- SISTEMA DE EXPORTACI√ìN COMPLETO AGUA ZAFIRO -->
<script>
// üì§ SISTEMA DE EXPORTACI√ìN AGUA ZAFIRO - VERSI√ìN DIN√ÅMICA COMPLETA
// Exporta datos de Supabase a Excel con formato horizontal din√°mico sin limitaciones

console.log('üì§ Cargando Sistema de Exportaci√≥n Agua Zafiro (Din√°mico)...');

// ===== FUNCIONES GLOBALES =====
window.iniciarExportacion = async function() {
    console.log('üì§ === INICIANDO EXPORTACI√ìN ===');
    
    try {
        // Verificar permisos
        const usuario = SupabaseAuth?.getCurrentUser();
        if (!usuario) {
            alert('‚ùå Debe estar logueado para exportar');
            return;
        }
        
        // Solo admin y socios pueden exportar
        if (usuario.role !== 'admin' && usuario.role !== 'socio') {
            alert('‚ùå Solo administradores y socios pueden exportar datos');
            return;
        }
        
        // Mostrar modal de opciones
        window.mostrarModalExportacion();
        
    } catch (error) {
        console.error('‚ùå Error iniciando exportaci√≥n:', error);
        alert(`Error: ${error.message}`);
    }
};

window.mostrarModalExportacion = function() {
    // Eliminar modal existente si hay uno
    const existingModal = document.getElementById('exportModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Crear modal
    const modal = document.createElement('div');
    modal.id = 'exportModal';
    modal.innerHTML = `
        <div style="
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        ">
            <div style="
                background: white; border-radius: 20px; padding: 30px;
                max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                border: 3px solid #9333ea;
            ">
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="color: #9333ea; margin: 0 0 10px 0; font-size: 24px;">üì§ Exportar Datos</h2>
                    <p style="color: #6b7280; margin: 0;">Seleccione el rango de fechas para exportar</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 15px; font-weight: 600;">
                        <input type="radio" name="rangoExport" value="todo" checked style="margin-right: 10px;">
                        üìã Exportar todos los registros
                    </label>
                    
                    <label style="display: block; margin-bottom: 15px; font-weight: 600;">
                        <input type="radio" name="rangoExport" value="mes" style="margin-right: 10px;">
                        üìÖ Solo este mes
                    </label>
                    
                    <label style="display: block; margin-bottom: 15px; font-weight: 600;">
                        <input type="radio" name="rangoExport" value="ano" style="margin-right: 10px;">
                        üìÜ Solo este a√±o
                    </label>
                    
                    <label style="display: block; margin-bottom: 15px; font-weight: 600;">
                        <input type="radio" name="rangoExport" value="rango" style="margin-right: 10px;">
                        üìä Rango personalizado
                    </label>
                </div>
                
                <div id="rangoPersonalizado" style="display: none; margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 10px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Fecha inicial:</label>
                            <input type="date" id="fechaInicio" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Fecha final:</label>
                            <input type="date" id="fechaFin" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #eff6ff; border-radius: 10px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin: 0 0 10px 0; color: #1e40af;">‚ÑπÔ∏è Informaci√≥n del archivo:</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #1e40af; font-size: 14px;">
                        <li>Formato: Excel (.xlsx) DIN√ÅMICO</li>
                        <li>Sin l√≠mites de ventas/gastos/cr√©ditos</li>
                        <li>Una fila por d√≠a registrado</li>
                        <li>Columnas se ajustan autom√°ticamente</li>
                        <li>Incluye totales calculados</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="btnExportar" style="
                        background: #9333ea; color: white; border: none; padding: 12px 25px;
                        border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px;
                    ">üì§ Exportar</button>
                    
                    <button id="btnCancelar" style="
                        background: #6b7280; color: white; border: none; padding: 12px 25px;
                        border-radius: 10px; cursor: pointer; font-weight: 600;
                    ">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Agregar event listeners usando JavaScript en lugar de onclick
    const radios = modal.querySelectorAll('input[name="rangoExport"]');
    const rangoPersonalizado = modal.querySelector('#rangoPersonalizado');
    const btnExportar = modal.querySelector('#btnExportar');
    const btnCancelar = modal.querySelector('#btnCancelar');
    
    // Event listeners para los radios
    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'rango') {
                rangoPersonalizado.style.display = 'block';
                
                // Establecer fechas por defecto
                const hoy = new Date();
                const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                
                modal.querySelector('#fechaInicio').value = inicioMes.toISOString().split('T')[0];
modal.querySelector('#fechaFin').value = hoy.toISOString().split('T')[0];
            } else {
                rangoPersonalizado.style.display = 'none';
            }
        });
    });
    
    // Event listeners para los botones
    btnExportar.addEventListener('click', window.procesarExportacion);
    btnCancelar.addEventListener('click', window.cerrarModalExportacion);
    
    // Cerrar modal al hacer clic fuera
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            window.cerrarModalExportacion();
        }
    });
};

window.cerrarModalExportacion = function() {
    const modal = document.getElementById('exportModal');
    if (modal) {
        modal.remove();
    }
};

window.procesarExportacion = async function() {
    try {
        // Obtener opciones seleccionadas
        const modal = document.getElementById('exportModal');
        const rangoSeleccionado = modal.querySelector('input[name="rangoExport"]:checked').value;
        
        let fechaInicio, fechaFin;
        
        // Determinar rango de fechas
        const hoy = new Date();
        
        switch (rangoSeleccionado) {
            case 'todo':
                fechaInicio = '1900-01-01';
                fechaFin = '2100-12-31';
                break;
                
            case 'mes':
                fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
                fechaFin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).toISOString().split('T')[0];
                break;
                
            case 'ano':
                fechaInicio = `${hoy.getFullYear()}-01-01`;
                fechaFin = `${hoy.getFullYear()}-12-31`;
                break;
                
            case 'rango':
                fechaInicio = modal.querySelector('#fechaInicio').value;
fechaFin = modal.querySelector('#fechaFin').value;
                
                if (!fechaInicio || !fechaFin) {
                    alert('‚ùå Debe seleccionar ambas fechas para el rango personalizado');
                    return;
                }
                
                if (fechaInicio > fechaFin) {
                    alert('‚ùå La fecha inicial no puede ser mayor que la fecha final');
                    return;
                }
                break;
        }
        
        console.log(`üì§ Exportando desde ${fechaInicio} hasta ${fechaFin}`);
        
        // Cerrar modal y mostrar progreso
        window.cerrarModalExportacion();
        const progressModal = window.mostrarProgresoExportacion();
        
        try {
            // Obtener datos de Supabase
            window.actualizarProgresoExportacion(progressModal, 20, 'Obteniendo datos de Supabase...');
            const datos = await window.obtenerDatosParaExportar(fechaInicio, fechaFin);
            
            if (!datos || datos.length === 0) {
                window.cerrarProgresoExportacion(progressModal);
                alert('‚ùå No se encontraron datos en el rango seleccionado');
                return;
            }
            
            // Convertir datos a formato Excel DIN√ÅMICO
            window.actualizarProgresoExportacion(progressModal, 50, 'Procesando datos din√°micamente...');
            const datosExcel = window.convertirDatosAExcelDinamico(datos);
            
            // Generar archivo Excel
            window.actualizarProgresoExportacion(progressModal, 80, 'Generando archivo Excel...');
            const nombreArchivo = window.generarNombreArchivo(rangoSeleccionado, fechaInicio, fechaFin);
            
            // Crear y descargar archivo
            window.actualizarProgresoExportacion(progressModal, 100, 'Descargando archivo...');
            await window.generarYDescargarExcel(datosExcel, nombreArchivo);
            
            setTimeout(() => {
                window.cerrarProgresoExportacion(progressModal);
                alert(`‚úÖ Exportaci√≥n completada!\n\nArchivo: ${nombreArchivo}\nRegistros: ${datos.length}\nColumnas: ${datosExcel[0].length} (din√°micas)`);
            }, 1500);
            
        } catch (error) {
            window.cerrarProgresoExportacion(progressModal);
            throw error;
        }
        
    } catch (error) {
        console.error('‚ùå Error en exportaci√≥n:', error);
        alert(`Error durante la exportaci√≥n: ${error.message}`);
    }
};

// ===== FUNCIONES DE DATOS =====
window.obtenerDatosParaExportar = async function(fechaInicio, fechaFin) {
    console.log(`üîç Obteniendo datos desde ${fechaInicio} hasta ${fechaFin}`);
    
    try {
        const { data: records, error } = await supabaseClient
            .from('daily_records')
            .select(`
                fecha,
                caja_inicial,
                observaciones,
                sales(vendedor, ciudad, producto, cantidad, precio, total, orden),
                expenses(categoria, descripcion, monto, orden),
                credits(categoria, detalle, monto, orden)
            `)
            .gte('fecha', fechaInicio)
            .lte('fecha', fechaFin)
            .order('fecha', { ascending: true });
        
        if (error) throw error;
        
        console.log(`‚úÖ Obtenidos ${records?.length || 0} registros`);
        return records || [];
        
    } catch (error) {
        console.error('‚ùå Error obteniendo datos:', error);
        throw new Error(`Error obteniendo datos: ${error.message}`);
    }
};

// ===== FUNCI√ìN PRINCIPAL DIN√ÅMICA =====
window.convertirDatosAExcelDinamico = function(registros) {
    console.log(`üîÑ Convirtiendo ${registros.length} registros a formato Excel DIN√ÅMICO...`);
    
    // PASO 1: Analizar todos los registros para determinar m√°ximos
    let maxVentas = 0;
    let maxGastos = 0;
    let maxCreditos = 0;
    
    registros.forEach(registro => {
        const ventasCount = (registro.sales || []).length;
        const gastosCount = (registro.expenses || []).length;
        const creditosCount = (registro.credits || []).length;
        
        if (ventasCount > maxVentas) maxVentas = ventasCount;
        if (gastosCount > maxGastos) maxGastos = gastosCount;
        if (creditosCount > maxCreditos) maxCreditos = creditosCount;
    });
    
    console.log(`üìä M√°ximos detectados: ${maxVentas} ventas, ${maxGastos} gastos, ${maxCreditos} cr√©ditos`);
    
    // PASO 2: Generar headers din√°micamente
    const headers = ['ID', 'FECHA', 'CAJA_INICIAL'];
    
    // Headers de ventas (din√°micos)
    for (let i = 1; i <= maxVentas; i++) {
        headers.push(
            `VENDEDOR_${i}`,
            `CIUDAD_${i}`,
            `PRODUCTO_${i}`,
            `CANTIDAD_${i}`,
            `PRECIO_${i}`,
            `TOTAL_${i}`
        );
    }
    
    // Headers de gastos (din√°micos)
    for (let i = 1; i <= maxGastos; i++) {
        headers.push(
            `GASTO_${i}`,
            `DESCRIPCION_${i}`,
            `MONTO_GASTO_${i}`
        );
    }
    
    // Headers de cr√©ditos (din√°micos)
    for (let i = 1; i <= maxCreditos; i++) {
        headers.push(
            `CREDITO_${i}_NOMBRE`,
            `CREDITO_${i}_DETALLE`,
            `CREDITO_${i}_MONTO`
        );
    }
    
    // Headers finales con totales calculados
    headers.push(
        'TOTAL_VENTAS', 
        'TOTAL_GASTOS', 
        'TOTAL_CREDITOS', 
        'UTILIDAD_NETA', 
        'OBSERVACIONES',
        'FOTOS',
        'REGISTRO_NUM'
    );
    
    const totalColumnas = headers.length;
    console.log(`üìã Headers generados: ${totalColumnas} columnas din√°micas`);
    
    const filas = [headers];
    
    // PASO 3: Procesar cada registro
    registros.forEach((registro, index) => {
        const fila = new Array(totalColumnas).fill('');
        let colIndex = 0;
        
        // Informaci√≥n b√°sica
        fila[colIndex++] = index + 1; // ID secuencial
        fila[colIndex++] = registro.fecha;
        fila[colIndex++] = registro.caja_inicial || 0;
        
        // Ventas (todas las que existan)
        const ventas = (registro.sales || []).sort((a, b) => (a.orden || 0) - (b.orden || 0));
        for (let i = 0; i < maxVentas; i++) {
            if (i < ventas.length) {
                const venta = ventas[i];
                fila[colIndex++] = venta.vendedor || '';
                fila[colIndex++] = venta.ciudad || '';
                fila[colIndex++] = venta.producto || '';
                fila[colIndex++] = venta.cantidad || 0;
                fila[colIndex++] = venta.precio || 0;
                fila[colIndex++] = venta.total || 0;
            } else {
                // Rellenar columnas vac√≠as para mantener estructura
                colIndex += 6;
            }
        }
        
        // Gastos (todos los que existan)
        const gastos = (registro.expenses || []).sort((a, b) => (a.orden || 0) - (b.orden || 0));
        for (let i = 0; i < maxGastos; i++) {
            if (i < gastos.length) {
                const gasto = gastos[i];
                fila[colIndex++] = gasto.categoria || '';
                fila[colIndex++] = gasto.descripcion || '';
                fila[colIndex++] = gasto.monto || 0;
            } else {
                // Rellenar columnas vac√≠as
                colIndex += 3;
            }
        }
        
        // Cr√©ditos (todos los que existan)
        const creditos = (registro.credits || []).sort((a, b) => (a.orden || 0) - (b.orden || 0));
        for (let i = 0; i < maxCreditos; i++) {
            if (i < creditos.length) {
                const credito = creditos[i];
                fila[colIndex++] = credito.categoria || '';
                fila[colIndex++] = credito.detalle || '';
                fila[colIndex++] = credito.monto || 0;
            } else {
                // Rellenar columnas vac√≠as
                colIndex += 3;
            }
        }
        
        // Calcular totales
        const totalVentas = ventas.reduce((sum, v) => sum + (v.total || 0), 0);
        const totalGastos = gastos.reduce((sum, g) => sum + (g.monto || 0), 0);
        const totalCreditos = creditos.reduce((sum, c) => sum + (c.monto || 0), 0);
        const utilidadNeta = (registro.caja_inicial || 0) + totalVentas - totalGastos + totalCreditos;
        
        // Agregar totales y campos finales
        fila[colIndex++] = totalVentas;
        fila[colIndex++] = totalGastos;
        fila[colIndex++] = totalCreditos;
        fila[colIndex++] = utilidadNeta;
        fila[colIndex++] = registro.observaciones || '';
        fila[colIndex++] = ''; // Fotos (vac√≠o por ahora)
        fila[colIndex++] = 1; // Registro_num
        
        filas.push(fila);
    });
    
    console.log(`‚úÖ Convertidos ${filas.length - 1} registros con ${totalColumnas} columnas din√°micas`);
    console.log(`üìä Estructura: ${maxVentas} ventas + ${maxGastos} gastos + ${maxCreditos} cr√©ditos + totales`);
    return filas;
};

window.generarNombreArchivo = function(rango, fechaInicio, fechaFin) {
    const fecha = new Date().toISOString().split('T')[0];
    const hora = new Date().toTimeString().split(' ')[0].replace(/:/g, '');
    
    let sufijo;
    switch (rango) {
        case 'todo':
            sufijo = 'TODOS_LOS_DATOS';
            break;
        case 'mes':
            const mesActual = new Date().toISOString().slice(0, 7);
            sufijo = `MES_${mesActual}`;
            break;
        case 'ano':
            const anoActual = new Date().getFullYear();
            sufijo = `ANO_${anoActual}`;
            break;
        case 'rango':
            sufijo = `${fechaInicio}_AL_${fechaFin}`;
            break;
        default:
            sufijo = 'EXPORTACION';
    }
    
    return `AguaZafiro_DINAMICO_${sufijo}_${fecha}_${hora}.xlsx`;
};

window.generarYDescargarExcel = async function(datos, nombreArchivo) {
    console.log(`üìÅ Generando archivo din√°mico: ${nombreArchivo}`);
    
    try {
        // Crear workbook
        const ws = XLSX.utils.aoa_to_sheet(datos);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Datos Agua Zafiro");
        
        // Configurar anchos de columnas din√°micamente
        const colWidths = [];
        const numCols = datos[0].length;
        
        for (let i = 0; i < numCols; i++) {
            if (i < 3) {
                // Columnas b√°sicas (ID, FECHA, CAJA_INICIAL)
                colWidths.push({ wch: i === 1 ? 12 : 15 });
            } else if (datos[0][i].includes('TOTAL') || datos[0][i].includes('UTILIDAD')) {
                // Columnas de totales
                colWidths.push({ wch: 18 });
            } else if (datos[0][i].includes('OBSERVACIONES')) {
                // Observaciones m√°s ancha
                colWidths.push({ wch: 30 });
            } else {
                // Resto de columnas
                colWidths.push({ wch: 15 });
            }
        }
        ws['!cols'] = colWidths;
        
        // Aplicar formato a headers
        const headerRange = XLSX.utils.decode_range(ws['!ref']);
        for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
            const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
            if (!ws[cellRef]) continue;
            
            ws[cellRef].s = {
                font: { bold: true },
                fill: { fgColor: { rgb: "CCCCCC" } },
                alignment: { horizontal: "center" }
            };
        }
        
        // Generar archivo y descargar
        XLSX.writeFile(wb, nombreArchivo);
        
        console.log(`‚úÖ Archivo din√°mico generado y descargado: ${nombreArchivo}`);
        console.log(`üìä ${datos.length - 1} registros, ${datos[0].length} columnas`);
        
    } catch (error) {
        console.error('‚ùå Error generando Excel:', error);
        throw new Error(`Error generando archivo: ${error.message}`);
    }
};

// ===== INTERFAZ DE PROGRESO =====
window.mostrarProgresoExportacion = function() {
    const modal = document.createElement('div');
    modal.id = 'exportProgress';
    modal.innerHTML = `
        <div style="
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 20000;
            min-width: 400px; border: 3px solid #9333ea;
        ">
            <h3 style="margin: 0 0 20px 0; text-align: center; color: #9333ea;">üì§ Exportando Datos Din√°micos</h3>
            
            <div style="background: #f0f0f0; height: 25px; border-radius: 12px; overflow: hidden; margin-bottom: 15px; position: relative;">
                <div id="barraExport" style="height: 100%; background: linear-gradient(90deg, #9333ea, #7c3aed); width: 0%; transition: width 0.5s;"></div>
                <div id="porcentajeExport" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">0%</div>
            </div>
            
            <p id="textoExport" style="margin: 0; text-align: center; color: #374151;">Iniciando exportaci√≥n din√°mica...</p>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
};

window.actualizarProgresoExportacion = function(modal, porcentaje, mensaje) {
    const barra = modal.querySelector('#barraExport');
    const texto = modal.querySelector('#textoExport');
    const porciento = modal.querySelector('#porcentajeExport');
    
    if (barra) barra.style.width = `${porcentaje}%`;
    if (texto) texto.textContent = mensaje;
    if (porciento) porciento.textContent = `${Math.round(porcentaje)}%`;
};

window.cerrarProgresoExportacion = function(modal) {
    if (modal && modal.parentNode) {
        modal.parentNode.removeChild(modal);
    }
};

// ===== CONECTAR BOTONES =====
function conectarBotonesExportacion() {
    // Buscar botones de exportar
    const selectores = [
        'button.export',
        '.btn.export', 
        'button:contains("Exportar")',
        '.nav-actions .btn.export'
    ];
    
    let botonesConectados = 0;
    
    selectores.forEach(selector => {
        try {
            const botones = document.querySelectorAll(selector);
            botones.forEach(boton => {
                if (boton.textContent.includes('Exportar')) {
                    boton.onclick = null;
                    boton.addEventListener('click', function(e) {
                        e.preventDefault();
                        window.iniciarExportacion();
                    });
                    botonesConectados++;
                }
            });
        } catch (e) {
            // Ignorar errores de selectores
        }
    });
    
    console.log(`‚úÖ ${botonesConectados} botones de exportaci√≥n din√°micos conectados`);
}

// ===== INICIALIZACI√ìN =====
// Ejecutar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(conectarBotonesExportacion, 1000);
    });
} else {
    setTimeout(conectarBotonesExportacion, 1000);
}

// Alias para compatibilidad
window.exportarAguaZafiro = window.iniciarExportacion;

console.log('‚úÖ SISTEMA DE EXPORTACI√ìN DIN√ÅMICO AGUA ZAFIRO CARGADO');
console.log('üì§ Funciones disponibles: iniciarExportacion(), exportarAguaZafiro()');
console.log('üîí Permisos: Solo admin y socios pueden exportar');
console.log('üìä DIN√ÅMICO: Sin l√≠mites de ventas/gastos/cr√©ditos - columnas se ajustan autom√°ticamente');
</script>
</body>
</html>