<!DOCTYPE html>
<div class="user-info">
  <span class="user-name"></span> | 
  <span class="user-role"></span>
</div>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard General</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- üì° SUPABASE CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- üìä XLSX PARA REPORTES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      transition: transform 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-2px);
    }

    .chart-card h3 {
      margin: 0 0 15px 0;
      color: #1f2937;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .chart-container.large {
      height: 400px;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 6px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      font-weight: 500;
    }

    .filter-select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .performance-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      margin-top: 25px;
    }

    .performance-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .performance-table th,
    .performance-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .performance-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .performance-table tr:hover {
      background: #f3f4f6;
    }

    .refresh-btn {
      position: fixed;
      top: 100px;
      right: 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      z-index: 1000;
    }

    .refresh-btn:hover {
      background: #059669;
      transform: scale(1.1);
    }

    .data-source-indicator {
      position: fixed;
      top: 160px;
      right: 20px;
      background: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #e5e7eb;
    }

    .data-source-indicator.real-data {
      border-color: #10b981;
      color: #10b981;
    }

    .data-source-indicator.demo-data {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    .connection-status {
      position: fixed;
      top: 210px;
      right: 20px;
      background: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #e5e7eb;
      z-index: 1000;
    }

    .connection-status.connected {
      border-color: #10b981;
      color: #10b981;
    }

    .connection-status.disconnected {
      border-color: #ef4444;
      color: #ef4444;
    }

    .connection-status.connecting {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <h1>üíß Agua Zafiro</h1>
    <div class="nav-actions">
      <div class="status"><i class="fas fa-circle"></i> Sistema Activo</div>
      <button class="btn import"><i class="fas fa-upload"></i> Importar</button>
      <button class="btn export"><i class="fas fa-download"></i> Exportar</button>
      <button class="btn reports" onclick="abrirModuloReportes()"><i class="fas fa-chart-bar"></i> Reportes</button>
      <a href="capturador.html" class="nav-btn">
        <i class="fas fa-clipboard-list"></i>
        <span>Capturador</span>
      </a>
      <a href="calendario.html" class="nav-btn">
        <i class="fas fa-calendar-alt"></i>
        <span>Calendario</span>
      </a>
      <a href="dashboard.html" class="nav-btn active">
        <i class="fas fa-chart-line"></i>
        <span>Dashboard</span>
      </a>
<!-- ‚úÖ AGREGAR AQU√ç -->
    <a href="produccion.html" class="nav-btn admin-only">
      <i class="fas fa-industry"></i>
      <span>Producci√≥n</span>
    </a>
    </div>
  </nav>

  <!-- Bot√≥n de actualizaci√≥n y indicadores -->
  <button class="refresh-btn" onclick="cargarDatosSupabase()" title="Actualizar datos reales">
    <i class="fas fa-sync-alt"></i>
  </button>
  
  <div class="data-source-indicator demo-data" id="dataSourceIndicator">
    <i class="fas fa-database"></i> Datos Demo
  </div>

  <div class="connection-status connecting" id="connectionStatus">
    <i class="fas fa-wifi"></i> Conectando...
  </div>

  <div class="dashboard">
    <!-- KPIs Principales -->
    <div class="stats" id="statsSection">
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #10b981;" id="totalVentas">L. 53,262</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Ventas</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="totalGastos">L. 15,240</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Gastos</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="totalCreditos">L. 3,445</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Cr√©ditos</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;" id="resultadoFinal">L. 41,467</div>
        <div style="color: #6b7280; margin-top: 5px;">Resultado Final</div>
      </div>
    </div>

    <!-- Gr√°ficas -->
    <div class="charts-grid" id="chartsSection">
      <div class="chart-card">
        <h3><i class="fas fa-chart-pie"></i> Ventas por Producto</h3>
        <div class="filters">
          <select class="filter-select" id="periodoProducto">
            <option value="7">√öltimos 7 d√≠as</option>
            <option value="30" selected>√öltimos 30 d√≠as</option>
            <option value="90">√öltimos 90 d√≠as</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="ventasProductoChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-users"></i> Ventas por Vendedor</h3>
        <div class="filters">
          <select class="filter-select" id="tipoVenta">
            <option value="unidades">Por Unidades</option>
            <option value="dinero">Por Dinero</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="ventasChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-wallet"></i> Gastos por Categor√≠a</h3>
        <div class="chart-container">
          <canvas id="gastosChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-map-marker-alt"></i> Ventas por Ciudad</h3>
        <div class="chart-container">
          <canvas id="ciudadesChart"></canvas>
        </div>
      </div>
    </div>

    <div class="chart-card" id="evolutionSection">
      <h3><i class="fas fa-chart-line"></i> Evoluci√≥n Ventas vs Gastos</h3>
      <div class="filters">
        <select class="filter-select" id="periodoEvolucion">
          <option value="7">√öltimos 7 d√≠as</option>
          <option value="30" selected>√öltimos 30 d√≠as</option>
          <option value="90">√öltimos 90 d√≠as</option>
        </select>
      </div>
      <div class="chart-container large">
        <canvas id="evolucionChart"></canvas>
      </div>
    </div>

    <div class="performance-section" id="performanceSection">
      <h3 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px; font-weight: 600;">
        <i class="fas fa-trophy"></i> Performance de Vendedores
      </h3>
      <table class="performance-table">
        <thead>
          <tr>
            <th>Vendedor</th>
            <th>Botellones</th>
            <th>Bolsas</th>
            <th>Total Ventas</th>
            <th>Tendencia</th>
          </tr>
        </thead>
        <tbody id="performanceTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <script>
// ===== CONFIGURACI√ìN DE SUPABASE =====
const SUPABASE_URL = 'https://hjrplwxvyukevcljodyg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqcnBsd3h2eXVrZXZjbGpvZHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzUzMzQsImV4cCI6MjA3MzYxMTMzNH0.uJ-krjLrFVo7cHuIQQb1-x2wQzXwyZfcvg4XvnppkqE';

let supabaseClient = null;

async function inicializarSupabase() {
  try {
    const statusElement = document.getElementById('connectionStatus');
    
    if (SUPABASE_URL === 'TU_SUPABASE_URL_AQUI' || SUPABASE_ANON_KEY === 'TU_SUPABASE_ANON_KEY_AQUI') {
      console.warn('üîë Credenciales de Supabase no configuradas, usando datos demo');
      if (statusElement) {
        statusElement.className = 'connection-status disconnected';
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sin configurar';
      }
      return false;
    }

    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const { data, error } = await supabaseClient
      .from('daily_records')
      .select('count', { count: 'exact', head: true });

    if (error) {
      throw error;
    }

    console.log('‚úÖ Supabase conectado correctamente');
    if (statusElement) {
      statusElement.className = 'connection-status connected';
      statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Conectado';
    }
    return true;
    
  } catch (error) {
    console.error('‚ùå Error conectando a Supabase:', error);
    const statusElement = document.getElementById('connectionStatus');
    if (statusElement) {
      statusElement.className = 'connection-status disconnected';
      statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Error conexi√≥n';
    }
    return false;
  }
}

console.log('üöÄ Dashboard Agua Zafiro iniciando...');

let charts = {};
let datosActuales = null;
let periodoActual = 'mes';
let fechaSeleccionada = new Date().toISOString().split('T')[0];
let conexionSupabase = false;

const colores = {
  primary: '#3b82f6',
  success: '#10b981',
  warning: '#f59e0b',
  danger: '#ef4444',
  purple: '#8b5cf6',
  teal: '#14b8a6',
  orange: '#f97316',
  indigo: '#6366f1'
};

const datosDemo = {
  totalRegistros: 5,
  ventasPorVendedor: {
    'Brayan': { cantidad: 456, total: 24580, botellones: 300, bolsas: 156 },
    'Ariel': { cantidad: 389, total: 22300, botellones: 250, bolsas: 139 },
    'Bodega': { cantidad: 334, total: 18700, botellones: 200, bolsas: 134 }
  },
  ventasPorProducto: {
    'Botell√≥n 20L': { cantidad: 750, total: 22500 },
    'Bolsa 500ml': { cantidad: 429, total: 7722 }
  },
  ventasPorCiudad: {
    'Tegucigalpa': 28400,
    'San Pedro Sula': 15600,
    'La Ceiba': 9800,
    'Comayagua': 8200
  },
  gastosPorCategoria: {
    'COMBUSTIBLE': 5500,
    'PLANILLAS': 6800,
    'MANTENIMIENTO': 2200,
    'OTROS': 740
  },
  creditosPorCategoria: {
    'VENTAS A CREDITO': 3445
  },
  totalVentas: 53262,
  totalGastos: 15240,
  totalCreditos: 3445,
  cajaInicialTotal: 5000,
  evolucionDiaria: [
    { fecha: '2025-09-15', ventas: 12000, gastos: 3000, cajaInicial: 1000 },
    { fecha: '2025-09-16', ventas: 15000, gastos: 3500, cajaInicial: 1000 },
    { fecha: '2025-09-17', ventas: 13500, gastos: 2800, cajaInicial: 1000 },
    { fecha: '2025-09-18', ventas: 14200, gastos: 3200, cajaInicial: 1000 },
    { fecha: '2025-09-19', ventas: 16800, gastos: 4100, cajaInicial: 1000 }
  ]
};

document.addEventListener("DOMContentLoaded", async function() {
  console.log('üìä Inicializando Dashboard...');
  
  conexionSupabase = await inicializarSupabase();
  
  crearControlesPeriodo();
  
  if (conexionSupabase) {
    await cargarDatosSupabase();
  } else {
    cargarDatosDemo();
  }
  
  crearTodasLasGraficas();
  actualizarGraficas(datosActuales);
  
  console.log('‚úÖ Dashboard inicializado');
});
function crearControlesPeriodo() {
  const statsSection = document.getElementById('statsSection');
  if (!statsSection) return;
  
  const hoy = new Date().toISOString().split('T')[0];
  
  const controlesHTML = `
    <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
        <h2 style="margin: 0; color: #1f2937; font-size: 24px; font-weight: 700;">
          üìä Dashboard Agua Zafiro
        </h2>
        
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <button id="btnActualizar" style="background: #10b981; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer;">
            üîÑ Actualizar
          </button>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 15px;">
        
        <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">‚ö° Per√≠odos R√°pidos:</label>
          <select id="selectorPeriodo" style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 500;">
            <option value="hoy">üìÖ Hoy</option>
            <option value="ayer">üìÖ Ayer</option>
            <option value="mes" selected>üóìÔ∏è Este mes</option>
            <option value="mes_pasado">üóìÔ∏è Mes pasado</option>
            <option value="ano">üìÜ Este a√±o</option>
            <option value="ano_pasado">üìÜ A√±o pasado</option>
          </select>
        </div>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border: 1px solid #bae6fd;">
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">üìÖ Por Semanas:</label>
          <select id="selectorSemana" style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 500;">
            <option value="">Seleccionar semana...</option>
            <option value="esta_semana">üìÖ Esta semana</option>
            <option value="semana_pasada">üìÖ Semana pasada</option>
            <option value="ultimas_2_semanas">üìÖ √öltimas 2 semanas</option>
            <option value="ultimas_4_semanas">üìÖ √öltimas 4 semanas</option>
            <option value="este_mes_semanas">üìÖ Semanas de este mes</option>
          </select>
        </div>
        
        <div style="background: #fefce8; padding: 15px; border-radius: 10px; border: 1px solid #fde047;">
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">üéØ Rango Personalizado:</label>
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <input type="date" id="fechaInicio" style="padding: 6px 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;" value="${hoy}">
            <span style="color: #6b7280; font-weight: 500;">hasta</span>
            <input type="date" id="fechaFin" style="padding: 6px 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;" value="${hoy}">
            <button id="btnAplicarRango" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 500; font-size: 13px; cursor: pointer;">
              Aplicar
            </button>
          </div>
        </div>
        
      </div>
      
      <div id="infoStatus" style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 8px; font-size: 14px; color: #6b7280;">
        üìç Cargando datos...
      </div>
    </div>
  `;
  
  statsSection.insertAdjacentHTML('beforebegin', controlesHTML);
  
  const selector = document.getElementById('selectorPeriodo');
  const selectorSemana = document.getElementById('selectorSemana');
  const fechaInicio = document.getElementById('fechaInicio');
  const fechaFin = document.getElementById('fechaFin');
  const btnActualizar = document.getElementById('btnActualizar');
  const btnAplicarRango = document.getElementById('btnAplicarRango');
  
  selector.addEventListener('change', function() {
    if (this.value) {
      periodoActual = this.value;
      selectorSemana.value = '';
      cargarDatosSegunConexion();
    }
  });
  
  selectorSemana.addEventListener('change', function() {
    if (this.value) {
      periodoActual = this.value;
      selector.value = '';
      cargarDatosSegunConexion();
    }
  });
  
  btnAplicarRango.addEventListener('click', function() {
    const inicio = fechaInicio.value;
    const fin = fechaFin.value;
    
    if (!inicio || !fin) {
      alert('Por favor selecciona ambas fechas');
      return;
    }
    
    if (inicio > fin) {
      alert('La fecha de inicio no puede ser mayor que la fecha de fin');
      return;
    }
    
    periodoActual = 'rango_personalizado';
    selector.value = '';
    selectorSemana.value = '';
    cargarDatosSegunConexion();
  });
  
  btnActualizar.addEventListener('click', cargarDatosSegunConexion);
  
  function cargarDatosSegunConexion() {
    if (conexionSupabase) {
      cargarDatosSupabase();
    } else {
      cargarDatosDemo();
    }
  }
}

function cargarDatosDemo() {
  console.log('üìã Cargando datos demo...');
  
  const statusElement = document.getElementById('infoStatus');
  const dataSourceElement = document.getElementById('dataSourceIndicator');
  
  if (statusElement) {
    statusElement.innerHTML = '‚ö†Ô∏è Usando datos de demostraci√≥n - Configure Supabase para datos reales';
    statusElement.style.background = '#fef3c7';
    statusElement.style.color = '#92400e';
  }
  
  if (dataSourceElement) {
    dataSourceElement.className = 'data-source-indicator demo-data';
    dataSourceElement.innerHTML = '<i class="fas fa-database"></i> Datos Demo';
  }
  
  datosActuales = datosDemo;
  
  const descripcion = `Datos demo - ${periodoActual}`;
  actualizarKPIs(datosActuales, descripcion);
  actualizarGraficas(datosActuales);
  crearTablaPerformance(datosActuales);
}

async function cargarDatosSupabase() {
  if (!conexionSupabase || !supabaseClient) {
    console.log('‚ùå No hay conexi√≥n a Supabase, usando datos demo');
    cargarDatosDemo();
    return;
  }
  
  console.log(`üì° Cargando datos de Supabase - Per√≠odo: ${periodoActual}`);
  
  const statusElement = document.getElementById('infoStatus');
  const dataSourceElement = document.getElementById('dataSourceIndicator');
  
  try {
    if (statusElement) {
      statusElement.innerHTML = '‚è≥ Cargando datos de Supabase...';
      statusElement.style.background = '#fef3c7';
    }
    
    const { fechaInicio, fechaFin, descripcion } = calcularRangoFechas();
    
    console.log(`üìÖ Consultando desde ${fechaInicio} hasta ${fechaFin}`);
    
    const { data: records, error } = await supabaseClient
      .from('daily_records')
      .select(`
        fecha,
        caja_inicial,
        observaciones,
        sales(vendedor, ciudad, producto, cantidad, precio, total, orden),
        expenses(categoria, descripcion, monto, orden),
        credits(categoria, detalle, monto, orden)
      `)
      .gte('fecha', fechaInicio)
      .lte('fecha', fechaFin)
      .order('fecha', { ascending: true });
    
    if (error) {
      throw new Error(`Error consultando Supabase: ${error.message}`);
    }
    
    datosActuales = procesarDatosSupabase(records || []);
    
    actualizarKPIs(datosActuales, descripcion);
    actualizarGraficas(datosActuales);
    crearTablaPerformance(datosActuales);
    
    if (statusElement) {
      statusElement.innerHTML = `‚úÖ ${descripcion} - ${records?.length || 0} registros encontrados - √öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`;
      statusElement.style.background = '#ecfdf5';
      statusElement.style.color = '#065f46';
    }
    
    if (dataSourceElement) {
      dataSourceElement.className = 'data-source-indicator real-data';
      dataSourceElement.innerHTML = '<i class="fas fa-database"></i> Datos Reales';
    }
    
    console.log(`‚úÖ Datos cargados: ${records?.length || 0} registros`);
    
  } catch (error) {
    console.error('‚ùå Error cargando datos:', error);
    
    if (statusElement) {
      statusElement.innerHTML = `‚ùå Error: ${error.message}`;
      statusElement.style.background = '#fef2f2';
      statusElement.style.color = '#991b1b';
    }
    
    cargarDatosDemo();
  }
}

function calcularRangoFechas() {
  const hoy = new Date();
  let fechaInicio, fechaFin, descripcion;
  
  switch (periodoActual) {
    case 'hoy':
      const fechaHoy = hoy.toISOString().split('T')[0];
      fechaInicio = fechaHoy;
      fechaFin = fechaHoy;
      descripcion = `Datos de hoy (${fechaHoy})`;
      break;
      
    case 'ayer':
      const ayer = new Date(hoy);
      ayer.setDate(hoy.getDate() - 1);
      const fechaAyer = ayer.toISOString().split('T')[0];
      fechaInicio = fechaAyer;
      fechaFin = fechaAyer;
      descripcion = `Datos de ayer (${fechaAyer})`;
      break;
      
    case 'mes':
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      fechaInicio = inicioMes.toISOString().split('T')[0];
      fechaFin = finMes.toISOString().split('T')[0];
      descripcion = `Datos de ${hoy.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
      break;
      
    case 'mes_pasado':
      const inicioMesPasado = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
      const finMesPasado = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
      fechaInicio = inicioMesPasado.toISOString().split('T')[0];
      fechaFin = finMesPasado.toISOString().split('T')[0];
      descripcion = `Datos de ${inicioMesPasado.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
      break;
      
    case 'ano':
      fechaInicio = `${hoy.getFullYear()}-01-01`;
      fechaFin = `${hoy.getFullYear()}-12-31`;
      descripcion = `Datos del a√±o ${hoy.getFullYear()}`;
      break;
      
    case 'ano_pasado':
      const anoPasado = hoy.getFullYear() - 1;
      fechaInicio = `${anoPasado}-01-01`;
      fechaFin = `${anoPasado}-12-31`;
      descripcion = `Datos del a√±o ${anoPasado}`;
      break;
      
    case 'esta_semana':
      const inicioEstaSemana = obtenerInicioSemana(hoy);
      const finEstaSemana = obtenerFinSemana(hoy);
      fechaInicio = inicioEstaSemana.toISOString().split('T')[0];
      fechaFin = finEstaSemana.toISOString().split('T')[0];
      descripcion = `Esta semana (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'semana_pasada':
      const inicioPasado = new Date(hoy);
      inicioPasado.setDate(hoy.getDate() - 7);
      const inicioSemPasada = obtenerInicioSemana(inicioPasado);
      const finSemPasada = obtenerFinSemana(inicioPasado);
      fechaInicio = inicioSemPasada.toISOString().split('T')[0];
      fechaFin = finSemPasada.toISOString().split('T')[0];
      descripcion = `Semana pasada (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'ultimas_2_semanas':
      const hace2Semanas = new Date(hoy);
      hace2Semanas.setDate(hoy.getDate() - 14);
      fechaInicio = hace2Semanas.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = `√öltimas 2 semanas (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'ultimas_4_semanas':
      const hace4Semanas = new Date(hoy);
      hace4Semanas.setDate(hoy.getDate() - 28);
      fechaInicio = hace4Semanas.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = `√öltimas 4 semanas (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'este_mes_semanas':
      const inicioMesActual = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      fechaInicio = inicioMesActual.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = `Semanas de este mes (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'rango_personalizado':
      const fechaInicioInput = document.getElementById('fechaInicio');
      const fechaFinInput = document.getElementById('fechaFin');
      
      if (fechaInicioInput && fechaFinInput) {
        fechaInicio = fechaInicioInput.value;
        fechaFin = fechaFinInput.value;
        
        const inicioFormateado = new Date(fechaInicio).toLocaleDateString('es-ES');
        const finFormateado = new Date(fechaFin).toLocaleDateString('es-ES');
        
        if (fechaInicio === fechaFin) {
          descripcion = `Datos del ${inicioFormateado}`;
        } else {
          descripcion = `Rango personalizado (${inicioFormateado} al ${finFormateado})`;
        }
      } else {
        fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
        descripcion = 'Datos de hoy (fallback)';
      }
      break;
      
    case 'dia':
      const fechaDia = hoy.toISOString().split('T')[0];
      fechaInicio = fechaDia;
      fechaFin = fechaDia;
      descripcion = `Datos de hoy (${fechaDia})`;
      break;
      
    case 'personalizado':
      fechaInicio = fechaSeleccionada;
      fechaFin = fechaSeleccionada;
      descripcion = `Datos del ${new Date(fechaSeleccionada).toLocaleDateString('es-ES')}`;
      break;
      
    default:
      fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Datos de hoy (por defecto)';
  }
  
  return { fechaInicio, fechaFin, descripcion };
}

function obtenerInicioSemana(fecha) {
  const nuevaFecha = new Date(fecha);
  const diaSemana = nuevaFecha.getDay();
  const diasHastaLunes = diaSemana === 0 ? 6 : diaSemana - 1;
  nuevaFecha.setDate(nuevaFecha.getDate() - diasHastaLunes);
  return nuevaFecha;
}

function obtenerFinSemana(fecha) {
  const inicioSemana = obtenerInicioSemana(fecha);
  const finSemana = new Date(inicioSemana);
  finSemana.setDate(inicioSemana.getDate() + 6);
  return finSemana;
}

function normalizar(texto) {
    if (!texto || typeof texto !== 'string') {
        return texto;
    }
    return texto.trim().toUpperCase();
}

function normalizarVendedor(vendedor) {
    const normalizado = normalizar(vendedor);
    const mapeoVendedores = {
        'BRAYAN': 'BRAYAN',
        'BRYAN': 'BRAYAN',
        'ARIEL': 'ARIEL',
        'BODEGA': 'BODEGA'
    };
    return mapeoVendedores[normalizado] || normalizado;
}

function normalizarProducto(producto) {
    const normalizado = normalizar(producto);
    const mapeoProductos = {
        'BOTELLONES': 'BOTELLONES',
        'BOTELLON': 'BOTELLONES',
        'BOTELL√ìN': 'BOTELLONES',
        'BOLSAS': 'BOLSAS',
        'BOLSA': 'BOLSAS'
    };
    return mapeoProductos[normalizado] || normalizado;
}

function normalizarCiudad(ciudad) {
    return normalizar(ciudad);
}

function normalizarCategoria(categoria) {
    return normalizar(categoria);
}

function procesarDatosSupabase(records) {
  console.log('üîÑ Procesando datos de Supabase...');
  
  const datos = {
    totalRegistros: records.length,
    ventasPorVendedor: {},
    ventasPorProducto: {},
    ventasPorCiudad: {},
    gastosPorCategoria: {},
    creditosPorCategoria: {},
    totalVentas: 0,
    totalGastos: 0,
    totalCreditos: 0,
    cajaInicialTotal: 0,
    evolucionDiaria: []
  };
  
  records.forEach(record => {
    datos.cajaInicialTotal += record.caja_inicial || 0;
    
    if (record.sales) {
      record.sales.forEach(sale => {
        const vendedorNorm = normalizarVendedor(sale.vendedor);
        const ciudadNorm = normalizarCiudad(sale.ciudad);
        const productoNorm = normalizarProducto(sale.producto);

        if (!datos.ventasPorVendedor[vendedorNorm]) {
          datos.ventasPorVendedor[vendedorNorm] = { cantidad: 0, total: 0, botellones: 0, bolsas: 0 };
        }
        datos.ventasPorVendedor[vendedorNorm].cantidad += sale.cantidad;
        datos.ventasPorVendedor[vendedorNorm].total += sale.total;
        
        if (productoNorm.toLowerCase().includes('botellon')) {
          datos.ventasPorVendedor[vendedorNorm].botellones += sale.cantidad;
        } else {
          datos.ventasPorVendedor[vendedorNorm].bolsas += sale.cantidad;
        }
        
        if (!datos.ventasPorProducto[productoNorm]) {
          datos.ventasPorProducto[productoNorm] = { cantidad: 0, total: 0 };
        }
        
        if (!datos.ventasPorCiudad[ciudadNorm]) {
          datos.ventasPorCiudad[ciudadNorm] = 0;
        }
        datos.ventasPorCiudad[ciudadNorm] += sale.total;
        
        datos.totalVentas += sale.total;
      });
    }
    
    if (record.expenses) {
      record.expenses.forEach(expense => {
        const categoriaNorm = normalizarCategoria(expense.categoria);
        if (!datos.gastosPorCategoria[categoriaNorm]) {
          datos.gastosPorCategoria[categoriaNorm] = 0;
        }
        datos.gastosPorCategoria[categoriaNorm] += expense.monto;
        datos.totalGastos += expense.monto;
      });
    }

    if (record.credits) {
      record.credits.forEach(credit => {
        const categoriaCreditoNorm = normalizarCategoria(credit.categoria);
        if (!datos.creditosPorCategoria[categoriaCreditoNorm]) {
          datos.creditosPorCategoria[categoriaCreditoNorm] = 0;
        }
        datos.creditosPorCategoria[categoriaCreditoNorm] += credit.monto;
        datos.totalCreditos += credit.monto;
      });
    }
    
    const ventasDia = record.sales ? record.sales.reduce((sum, s) => sum + s.total, 0) : 0;
    const gastosDia = record.expenses ? record.expenses.reduce((sum, e) => sum + e.monto, 0) : 0;
    
    datos.evolucionDiaria.push({
      fecha: record.fecha,
      ventas: ventasDia,
      gastos: gastosDia,
      cajaInicial: record.caja_inicial || 0
    });
  });
  
  console.log('‚úÖ Datos procesados:', datos);
  return datos;
}

function actualizarKPIs(datos, descripcion) {
  const elementos = {
    totalVentas: document.getElementById('totalVentas'),
    totalGastos: document.getElementById('totalGastos'),
    totalCreditos: document.getElementById('totalCreditos'),
    resultadoFinal: document.getElementById('resultadoFinal')
  };
  
  const resultadoFinal = datos.cajaInicialTotal + datos.totalVentas - datos.totalGastos + datos.totalCreditos;
  
  if (elementos.totalVentas) {
    elementos.totalVentas.textContent = `L. ${datos.totalVentas.toLocaleString()}`;
  }
  if (elementos.totalGastos) {
    elementos.totalGastos.textContent = `L. ${datos.totalGastos.toLocaleString()}`;
  }
  if (elementos.totalCreditos) {
    elementos.totalCreditos.textContent = `L. ${datos.totalCreditos.toLocaleString()}`;
  }
  if (elementos.resultadoFinal) {
    elementos.resultadoFinal.textContent = `L. ${resultadoFinal.toLocaleString()}`;
  }
  
  console.log('üìä KPIs actualizados para:', descripcion);
}

function crearTodasLasGraficas() {
  console.log('üé® Preparando contenedores de gr√°ficas...');
}

function actualizarGraficas(datos) {
  console.log('üìà Actualizando gr√°ficas...');
  
  actualizarGraficaProductos(datos);
  actualizarGraficaVendedores(datos);
  actualizarGraficaGastos(datos);
  actualizarGraficaCiudades(datos);
  actualizarGraficaEvolucion(datos);
}

function actualizarGraficaProductos(datos) {
  const ctx = document.getElementById('ventasProductoChart');
  if (!ctx) return;
  
  if (charts.productos) charts.productos.destroy();
  
  const productos = Object.keys(datos.ventasPorProducto);
  const cantidades = Object.values(datos.ventasPorProducto).map(p => p.cantidad);
  
  charts.productos = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: productos,
      datasets: [{
        data: cantidades,
        backgroundColor: [colores.primary, colores.success, colores.warning, colores.purple],
        borderWidth: 3,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

function actualizarGraficaVendedores(datos) {
  const ctx = document.getElementById('ventasChart');
  if (!ctx) return;
  
  if (charts.vendedores) charts.vendedores.destroy();
  
  const vendedores = Object.keys(datos.ventasPorVendedor);
  const botellones = vendedores.map(v => datos.ventasPorVendedor[v].botellones);
  const bolsas = vendedores.map(v => datos.ventasPorVendedor[v].bolsas);
  
  charts.vendedores = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: vendedores,
      datasets: [
        {
          label: 'Botellones',
          data: botellones,
          backgroundColor: colores.primary
        },
        {
          label: 'Bolsas',
          data: bolsas,
          backgroundColor: colores.success
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function actualizarGraficaGastos(datos) {
  const ctx = document.getElementById('gastosChart');
  if (!ctx) return;
  
  if (charts.gastos) charts.gastos.destroy();
  
  const categorias = Object.keys(datos.gastosPorCategoria);
  const montos = Object.values(datos.gastosPorCategoria);
  
  charts.gastos = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: categorias,
      datasets: [{
        data: montos,
        backgroundColor: [colores.danger, colores.warning, colores.primary, colores.purple, colores.teal]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

function actualizarGraficaCiudades(datos) {
  const ctx = document.getElementById('ciudadesChart');
  if (!ctx) return;
  
  if (charts.ciudades) charts.ciudades.destroy();
  
  const ciudades = Object.keys(datos.ventasPorCiudad);
  const ventas = Object.values(datos.ventasPorCiudad);
  
  charts.ciudades = new Chart(ctx, {
    type: 'polarArea',
    data: {
      labels: ciudades,
      datasets: [{
        data: ventas,
        backgroundColor: [colores.primary, colores.success, colores.warning, colores.purple, colores.teal]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

function actualizarGraficaEvolucion(datos) {
  const ctx = document.getElementById('evolucionChart');
  if (!ctx) return;
  
  if (charts.evolucion) charts.evolucion.destroy();
  
  const fechas = datos.evolucionDiaria.map(d => new Date(d.fecha).toLocaleDateString());
  const ventas = datos.evolucionDiaria.map(d => d.ventas);
  const gastos = datos.evolucionDiaria.map(d => d.gastos);
  
  charts.evolucion = new Chart(ctx, {
    type: 'line',
    data: {
      labels: fechas,
      datasets: [
        {
          label: 'Ventas',
          data: ventas,
          borderColor: colores.success,
          backgroundColor: colores.success + '20',
          tension: 0.4
        },
        {
          label: 'Gastos',
          data: gastos,
          borderColor: colores.danger,
          backgroundColor: colores.danger + '20',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function crearTablaPerformance(datos) {
  const tbody = document.getElementById('performanceTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  Object.entries(datos.ventasPorVendedor).forEach(([vendedor, info]) => {
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td><strong>${vendedor}</strong></td>
      <td>${info.botellones} unidades</td>
      <td>${info.bolsas} unidades</td>
      <td><strong>L. ${info.total.toLocaleString()}</strong></td>
      <td style="color: ${info.total > 15000 ? '#10b981' : '#f59e0b'};">
        ${info.total > 15000 ? '‚Üó Bueno' : '‚Üí Regular'}
      </td>
    `;
    tbody.appendChild(fila);
  });
}

console.log('‚úÖ Dashboard con Supabase configurado correctamente');
console.log('üìä Cargando Sistema de Reportes Administrativos...');

let modalReportesAbierto = false;
let datosReporte = null;

function abrirModuloReportes() {
  if (modalReportesAbierto) return;
  
  console.log('üìä Abriendo m√≥dulo de reportes...');
  modalReportesAbierto = true;
  
  const modal = document.createElement('div');
  modal.id = 'modalReportes';
  modal.innerHTML = `
    <div style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 50000;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(8px);
    ">
      <div style="
        background: white; border-radius: 25px; padding: 35px;
        max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        border: 3px solid #1e40af;
      ">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px;">
          <h2 style="color: #1e40af; margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">
            üìä Reportes Administrativos
          </h2>
          <p style="color: #6b7280; margin: 0; font-size: 16px;">
            An√°lisis avanzado para Agua Zafiro
          </p>
        </div>
        
        <div style="background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #e2e8f0;">
          <h3 style="margin: 0 0 15px 0; color: #374151; font-size: 18px;">üóìÔ∏è Seleccionar Per√≠odo</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            
            <div>
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">‚ö° Per√≠odos R√°pidos:</label>
              <select id="reportePeriodo" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                <option value="hoy">üìÖ Hoy</option>
                <option value="ayer">üìÖ Ayer</option>
                <option value="esta_semana">üìÖ Esta semana</option>
                <option value="semana_pasada">üìÖ Semana pasada</option>
                <option value="mes" selected>üóìÔ∏è Este mes</option>
                <option value="mes_pasado">üóìÔ∏è Mes pasado</option>
                <option value="ano">üìÜ Este a√±o</option>
                <option value="personalizado">üéØ Rango personalizado</option>
              </select>
            </div>
            
            <div id="rangoPersonalizadoReporte" style="display: none;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">üìÖ Rango de fechas:</label>
              <div style="display: flex; gap: 10px;">
                <input type="date" id="reporteFechaInicio" style="flex: 1; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                <span style="align-self: center; color: #6b7280;">‚Üí</span>
                <input type="date" id="reporteFechaFin" style="flex: 1; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
              </div>
            </div>
            
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
          
          <div class="reporte-card" onclick="generarReporte('vendedores')" style="
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üë•</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Performance Vendedores</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Ranking, metas vs real, an√°lisis por vendedor
            </p>
          </div>
          
          <div class="reporte-card" onclick="generarReporte('productos')" style="
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üßä</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">An√°lisis de Productos</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Botellones vs Bolsas, rentabilidad, tendencias
            </p>
          </div>
          
          <div class="reporte-card" onclick="generarReporte('ciudades')" style="
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üó∫Ô∏è</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">An√°lisis Geogr√°fico</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Ventas por ciudad, oportunidades de mercado
            </p>
          </div>
          
          <div class="reporte-card" onclick="generarReporte('financiero')" style="
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üí∞</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Estado Financiero</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Ingresos, gastos, utilidades, flujo de caja
            </p>
          </div>
          
          <div class="reporte-card" onclick="generarReporte('gastos')" style="
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üí∏</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">An√°lisis de Gastos</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Categor√≠as, tendencias, control de costos
            </p>
          </div>
          
          <div class="reporte-card" onclick="generarReporte('creditos')" style="
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üí≥</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Cr√©ditos y Cobranza</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Cuentas por cobrar, hist√≥rico de cr√©ditos
            </p>
          </div>
          
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; border-top: 2px solid #e5e7eb; padding-top: 20px;">
          
          <button onclick="generarReporteCompleto()" style="
            background: #059669; color: white; border: none; padding: 12px 25px;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px;
            display: flex; align-items: center; gap: 8px;
          ">
            üìã Reporte Ejecutivo Completo
          </button>
          
          <button onclick="cerrarModalReportes()" style="
            background: #6b7280; color: white; border: none; padding: 12px 25px;
            border-radius: 10px; cursor: pointer; font-weight: 600;
          ">
            ‚ùå Cerrar
          </button>
          
        </div>
        
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  document.getElementById('reportePeriodo').addEventListener('change', function() {
    const rangoDiv = document.getElementById('rangoPersonalizadoReporte');
    if (this.value === 'personalizado') {
      rangoDiv.style.display = 'block';
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      document.getElementById('reporteFechaInicio').value = inicioMes.toISOString().split('T')[0];
      document.getElementById('reporteFechaFin').value = hoy.toISOString().split('T')[0];
    } else {
      rangoDiv.style.display = 'none';
    }
  });
  
  const style = document.createElement('style');
  style.textContent = `
    .reporte-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
  `;
  document.head.appendChild(style);
}

function cerrarModalReportes() {
  const modal = document.getElementById('modalReportes');
  if (modal) {
    modal.remove();
    modalReportesAbierto = false;
  }
}

function obtenerRangoFechasReporte() {
  const periodo = document.getElementById('reportePeriodo').value;
  const hoy = new Date();
  let fechaInicio, fechaFin, descripcion;
  
  switch (periodo) {
    case 'hoy':
      fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Hoy';
      break;
    case 'ayer':
      const ayer = new Date(hoy);
      ayer.setDate(hoy.getDate() - 1);
      fechaInicio = fechaFin = ayer.toISOString().split('T')[0];
      descripcion = 'Ayer';
      break;
    case 'esta_semana':
      const inicioSemana = obtenerInicioSemana(hoy);
      fechaInicio = inicioSemana.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Esta semana';
      break;
    case 'semana_pasada':
      const semPasada = new Date(hoy);
      semPasada.setDate(hoy.getDate() - 7);
      const inicioSemPasada = obtenerInicioSemana(semPasada);
      const finSemPasada = obtenerFinSemana(semPasada);
      fechaInicio = inicioSemPasada.toISOString().split('T')[0];
      fechaFin = finSemPasada.toISOString().split('T')[0];
      descripcion = 'Semana pasada';
      break;
    case 'mes':
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      fechaInicio = inicioMes.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Este mes';
      break;
    case 'mes_pasado':
      const inicioMesPasado = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
      const finMesPasado = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
      fechaInicio = inicioMesPasado.toISOString().split('T')[0];
      fechaFin = finMesPasado.toISOString().split('T')[0];
      descripcion = 'Mes pasado';
      break;
    case 'ano':
      fechaInicio = `${hoy.getFullYear()}-01-01`;
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Este a√±o';
      break;
    case 'personalizado':
      fechaInicio = document.getElementById('reporteFechaInicio').value;
      fechaFin = document.getElementById('reporteFechaFin').value;
      descripcion = `${fechaInicio} al ${fechaFin}`;
      break;
    default:
      fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Hoy';
  }
  
  return { fechaInicio, fechaFin, descripcion };
}

async function obtenerDatosParaReportes(fechaInicio, fechaFin) {
  console.log(`üìä Obteniendo datos para reporte: ${fechaInicio} - ${fechaFin}`);
  
  try {
    if (!conexionSupabase || !supabaseClient) {
      throw new Error('No hay conexi√≥n a Supabase');
    }
    
    const { data: records, error } = await supabaseClient
      .from('daily_records')
      .select(`
        fecha,
        caja_inicial,
        observaciones,
        sales(vendedor, ciudad, producto, cantidad, precio, total, orden),
        expenses(categoria, descripcion, monto, orden),
        credits(categoria, detalle, monto, orden)
      `)
      .gte('fecha', fechaInicio)
      .lte('fecha', fechaFin)
      .order('fecha', { ascending: true });
    
    if (error) throw error;
    
    console.log(`‚úÖ Datos obtenidos: ${records?.length || 0} registros`);
    return records || [];
    
  } catch (error) {
    console.error('‚ùå Error obteniendo datos para reporte:', error);
    throw error;
  }
}

async function generarReporteCompleto() {
  console.log('üìã Generando reporte ejecutivo completo...');
  
  try {
    const progress = mostrarProgresoReporte();
    actualizarProgresoReporte(progress, 20, 'Obteniendo datos...');
    
    const { fechaInicio, fechaFin, descripcion } = obtenerRangoFechasReporte();
    const datos = await obtenerDatosParaReportes(fechaInicio, fechaFin);
    
    if (!datos || datos.length === 0) {
      cerrarProgresoReporte(progress);
      alert('‚ùå No se encontraron datos en el per√≠odo seleccionado');
      return;
    }
    
    actualizarProgresoReporte(progress, 60, 'Procesando reporte completo...');
    
    const reporteCompleto = {
      periodo: descripcion,
      datos: datos.length,
      vendedores: generarReporteVendedores(datos, descripcion).vendedores,
      productos: generarReporteProductos(datos, descripcion).productos,
      ciudades: generarReporteCiudades(datos, descripcion).ciudades,
      financiero: generarReporteFinanciero(datos, descripcion).financiero,
      gastos: generarReporteGastos(datos, descripcion).gastos,
      creditos: generarReporteCreditos(datos, descripcion).creditos
    };
    
    actualizarProgresoReporte(progress, 90, 'Generando vista...');
    cerrarProgresoReporte(progress);
    
    mostrarReporteEnPantalla(reporteCompleto, 'completo', descripcion);
    
  } catch (error) {
    console.error('‚ùå Error generando reporte completo:', error);
    alert(`Error generando reporte completo: ${error.message}`);
  }
}

async function generarReporte(tipoReporte) {
  console.log(`üìä Generando reporte: ${tipoReporte}`);
  
  try {
    const progress = mostrarProgresoReporte();
    actualizarProgresoReporte(progress, 20, 'Obteniendo datos...');
    
    const { fechaInicio, fechaFin, descripcion } = obtenerRangoFechasReporte();
    const datos = await obtenerDatosParaReportes(fechaInicio, fechaFin);
    
    if (!datos || datos.length === 0) {
      cerrarProgresoReporte(progress);
      alert('‚ùå No se encontraron datos en el per√≠odo seleccionado');
      return;
    }
    
    actualizarProgresoReporte(progress, 60, 'Procesando reporte...');
    
    let datosReporte;
    switch (tipoReporte) {
      case 'vendedores':
        datosReporte = generarReporteVendedores(datos, descripcion);
        break;
      case 'productos':
        datosReporte = generarReporteProductos(datos, descripcion);
        break;
      case 'ciudades':
        datosReporte = generarReporteCiudades(datos, descripcion);
        break;
      case 'financiero':
        datosReporte = generarReporteFinanciero(datos, descripcion);
        break;
      case 'gastos':
        datosReporte = generarReporteGastos(datos, descripcion);
        break;
      case 'creditos':
        datosReporte = generarReporteCreditos(datos, descripcion);
        break;
      default:
        throw new Error('Tipo de reporte no v√°lido');
    }
    
    actualizarProgresoReporte(progress, 90, 'Generando vista...');
    cerrarProgresoReporte(progress);
    
    mostrarReporteEnPantalla(datosReporte, tipoReporte, descripcion);
    
  } catch (error) {
    console.error('‚ùå Error generando reporte:', error);
    alert(`Error generando reporte: ${error.message}`);
  }
}

function mostrarProgresoReporte() {
  const modal = document.createElement('div');
  modal.id = 'modalProgreso';
  modal.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 70000; display: flex; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; min-width: 300px;">
        <h3 style="margin: 0 0 20px 0; color: #1f2937;">Generando Reporte</h3>
        <div style="background: #f3f4f6; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
          <div id="barraProgreso" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <p id="textoProgreso" style="margin: 0; color: #6b7280;">Iniciando...</p>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  return modal;
}

function actualizarProgresoReporte(modal, porcentaje, texto) {
  if (modal) {
    const barra = modal.querySelector('#barraProgreso');
    const textoElement = modal.querySelector('#textoProgreso');
    if (barra) barra.style.width = porcentaje + '%';
    if (textoElement) textoElement.textContent = texto;
  }
}

function cerrarProgresoReporte(modal) {
  if (modal) {
    modal.remove();
  }
}

function mostrarReporteEnPantalla(datosReporte, tipoReporte, periodo) {
  cerrarModalReportes();
  
  const modal = document.createElement('div');
  modal.id = 'modalVistaReporte';
  modal.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 60000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
      <div style="background: white; border-radius: 20px; padding: 30px; max-width: 95vw; width: 1200px; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.4); border: 3px solid #1e40af; display: flex; flex-direction: column;">
        
        <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 20px; border-radius: 15px; margin: -30px -30px 20px -30px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin: 0 0 5px 0; font-size: 24px; font-weight: 700;">
              ${obtenerTituloReporte(tipoReporte)}
            </h2>
            <p style="margin: 0; opacity: 0.9; font-size: 16px;">
              Per√≠odo: ${periodo} | ${datosReporte.resumen || 'Datos procesados'}
            </p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="cerrarVistaReporte()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
              ‚úï
            </button>
          </div>
        </div>
        
        <div style="flex: 1; overflow-y: auto; padding: 10px 0;">
          ${generarHTMLReporte(datosReporte, tipoReporte)}
        </div>
        
        <div style="border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
          <div style="color: #6b7280; font-size: 14px;">
            Generado: ${new Date().toLocaleString('es-ES')} | Agua Zafiro
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="cerrarVistaReporte()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
              ‚ùå Cerrar
            </button>
          </div>
        </div>
        
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  window.datosReporteActual = datosReporte;
}

function obtenerTituloReporte(tipoReporte) {
  const titulos = {
    'vendedores': 'üë• Performance de Vendedores',
    'productos': 'üßä An√°lisis de Productos',
    'ciudades': 'üó∫Ô∏è An√°lisis Geogr√°fico',
    'financiero': 'üí∞ Estado Financiero',
    'gastos': 'üí∏ An√°lisis de Gastos',
    'creditos': 'üí≥ Cr√©ditos y Cobranza',
    'completo': 'üìã Reporte Ejecutivo Completo'
  };
  return titulos[tipoReporte] || 'üìä Reporte';
}

function cerrarVistaReporte() {
  const modal = document.getElementById('modalVistaReporte');
  if (modal) {
    modal.remove();
  }
}

function generarReporteVendedores(datos, periodo) {
  const vendedores = {};
  let totalVentasGeneral = 0;
  
  datos.forEach(record => {
    if (record.sales) {
      record.sales.forEach(sale => {
        const vendedorNorm = normalizarVendedor(sale.vendedor);
        const ciudadNorm = normalizarCiudad(sale.ciudad);
        const productoNorm = normalizarProducto(sale.producto);

        if (!vendedores[vendedorNorm]) {
          vendedores[vendedorNorm] = {
            ventas: 0,
            cantidad: 0,
            botellones: 0,
            bolsas: 0,
            ingresoTotal: 0,
            ciudades: new Set(),
            diasActivos: new Set()
          };
        }
        
        const v = vendedores[vendedorNorm];
        v.ventas++;
        v.cantidad += sale.cantidad;
        v.ingresoTotal += sale.total;
        v.ciudades.add(ciudadNorm);
        v.diasActivos.add(record.fecha);
        
        if (productoNorm.toLowerCase().includes('botellon')) {
          v.botellones += sale.cantidad;
        } else {
          v.bolsas += sale.cantidad;
        }
        
        totalVentasGeneral += sale.total;
      });
    }
  });
  
  const vendedoresArray = Object.entries(vendedores).map(([nombre, data]) => ({
    vendedor: nombre,
    totalVentas: data.ventas,
    cantidadUnidades: data.cantidad,
    botellones: data.botellones,
    bolsas: data.bolsas,
    ingresoTotal: data.ingresoTotal,
    promedioPorVenta: data.ingresoTotal / data.ventas,
    participacion: (data.ingresoTotal / totalVentasGeneral * 100),
    ciudadesAtendidas: data.ciudades.size,
    diasActivos: data.diasActivos.size
  }));
  
  vendedoresArray.sort((a, b) => b.ingresoTotal - a.ingresoTotal);
  
  return { 
    vendedores: vendedoresArray,
    resumen: `${vendedoresArray.length} vendedores activos`
  };
}

function generarReporteProductos(datos, periodo) {
  const productos = {};
  
  datos.forEach(record => {
    if (record.sales) {
      record.sales.forEach(sale => {
        const productoNorm = normalizarProducto(sale.producto);
        
        if (!productos[productoNorm]) {
          productos[productoNorm] = {
            cantidad: 0,
            ingresos: 0,
            ventas: 0
          };
        }
        
        productos[productoNorm].cantidad += sale.cantidad;
        productos[productoNorm].ingresos += sale.total;
        productos[productoNorm].ventas++;
      });
    }
  });
  
  const productosArray = Object.entries(productos).map(([nombre, data]) => ({
    producto: nombre,
    cantidadVendida: data.cantidad,
    ingresoTotal: data.ingresos,
    precioPromedio: data.ingresos / data.cantidad
  }));
  
  return { productos: productosArray, resumen: `${productosArray.length} productos` };
}

function generarReporteCiudades(datos, periodo) {
  const ciudades = {};
  
  datos.forEach(record => {
    if (record.sales) {
      record.sales.forEach(sale => {
        const ciudadNorm = normalizarCiudad(sale.ciudad);
        
        if (!ciudades[ciudadNorm]) {
          ciudades[ciudadNorm] = { ventas: 0, ingresos: 0 };
        }
        
        ciudades[ciudadNorm].ventas++;
        ciudades[ciudadNorm].ingresos += sale.total;
      });
    }
  });
  
  const ciudadesArray = Object.entries(ciudades).map(([nombre, data]) => ({
    ciudad: nombre,
    totalVentas: data.ventas,
    ingresoTotal: data.ingresos
  }));
  
  return { ciudades: ciudadesArray, resumen: `${ciudadesArray.length} ciudades` };
}

function generarReporteFinanciero(datos, periodo) {
  let totalVentas = 0;
  let totalGastos = 0;
  let totalCreditos = 0;
  let cajaInicialTotal = 0;
  
  const filasPorDia = [];
  
  datos.forEach(record => {
    const ventasDia = record.sales ? record.sales.reduce((sum, s) => sum + s.total, 0) : 0;
    const gastosDia = record.expenses ? record.expenses.reduce((sum, e) => sum + e.monto, 0) : 0;
    const creditosDia = record.credits ? record.credits.reduce((sum, c) => sum + c.monto, 0) : 0;
    const cajaInicial = record.caja_inicial || 0;
    
    totalVentas += ventasDia;
    totalGastos += gastosDia;
    totalCreditos += creditosDia;
    cajaInicialTotal += cajaInicial;
    
    filasPorDia.push({
      fecha: record.fecha,
      cajaInicial: cajaInicial,
      ventas: ventasDia,
      gastos: gastosDia,
      creditos: creditosDia,
      utilidad: cajaInicial + ventasDia - gastosDia + creditosDia
    });
  });
  
  const utilidadNeta = cajaInicialTotal + totalVentas - totalGastos + totalCreditos;
  
  return { 
    financiero: {
      totalVentas,
      totalGastos,
      totalCreditos,
      utilidadNeta,
      margenUtilidad: (utilidadNeta / totalVentas * 100)
    },
    filasPorDia,
    resumen: `${datos.length} d√≠as analizados`
  };
}

function generarReporteGastos(datos, periodo) {
  const gastos = {};
  
  datos.forEach(record => {
    if (record.expenses) {
      record.expenses.forEach(expense => {
        const categoriaNorm = normalizarCategoria(expense.categoria);
        if (!gastos[categoriaNorm]) {
          gastos[categoriaNorm] = { total: 0, cantidad: 0 };
        }
        gastos[categoriaNorm].total += expense.monto;
        gastos[categoriaNorm].cantidad++;
      });
    }
  });
  
  const gastosArray = Object.entries(gastos).map(([categoria, data]) => ({
    categoria,
    total: data.total,
    cantidad: data.cantidad,
    promedio: data.total / data.cantidad
  }));
  
  return { gastos: gastosArray, resumen: `${gastosArray.length} categor√≠as` };
}

function generarReporteCreditos(datos, periodo) {
  const creditos = {};
  
  datos.forEach(record => {
    if (record.credits) {
      record.credits.forEach(credit => {
        const categoriaNorm = normalizarCategoria(credit.categoria);
        if (!creditos[categoriaNorm]) {
          creditos[categoriaNorm] = { total: 0, cantidad: 0 };
        }
        creditos[categoriaNorm].total += credit.monto;
        creditos[categoriaNorm].cantidad++;
      });
    }
  });
  
  const creditosArray = Object.entries(creditos).map(([categoria, data]) => ({
    categoria,
    total: data.total,
    cantidad: data.cantidad,
    promedio: data.total / data.cantidad
  }));
  
  return { creditos: creditosArray, resumen: `${creditosArray.length} categor√≠as` };
}
// ===== VISTAS HTML ADICIONALES =====

// HTML para reporte de productos
function generarHTMLProductos(datosReporte) {
  if (!datosReporte.productos || datosReporte.productos.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de productos en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalUnidades = datosReporte.productos.reduce((sum, p) => sum + p.cantidadVendida, 0);
  const totalIngresos = datosReporte.productos.reduce((sum, p) => sum + p.ingresoTotal, 0);
  const productoTop = datosReporte.productos[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalUnidades}</div>
      <div style="opacity: 0.9;">Unidades Vendidas</div>
    </div>
    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalIngresos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Ingresos Totales</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 16px; font-weight: bold;">${productoTop.producto}</div>
      <div style="opacity: 0.9;">Producto Top</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.productos.length}</div>
      <div style="opacity: 0.9;">Tipos de Productos</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Producto</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Cantidad</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ingresos</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Precio Prom.</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.productos.forEach((producto, index) => {
    const participacion = (producto.ingresoTotal / totalIngresos * 100);
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${producto.producto}</td>
        <td style="padding: 12px 15px; text-align: center; color: #3b82f6; font-weight: 500;">${producto.cantidadVendida}</td>
        <td style="padding: 12px 15px; text-align: right; color: #1f2937; font-weight: 600;">L. ${producto.ingresoTotal.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">L. ${producto.precioPromedio.toFixed(2)}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 50 ? '#dcfce7' : '#fef3c7'}; 
                       color: ${participacion > 50 ? '#166534' : '#92400e'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

// HTML para reporte financiero
function generarHTMLFinanciero(datosReporte) {
  console.log('üí∞ Generando HTML financiero con datos:', datosReporte);
  
  const tieneFilasPorDia = datosReporte.filasPorDia && datosReporte.filasPorDia.length > 0;
  const tieneFinanciero = datosReporte.financiero;
  
  if (!tieneFilasPorDia && !tieneFinanciero) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos financieros en este per√≠odo</p>';
  }
  
  let filasParaProcesar = datosReporte.filasPorDia;
  
  if (!filasParaProcesar && datosReporte.filas && datosReporte.filas.length > 3) {
    filasParaProcesar = [];
    for (let i = 3; i < datosReporte.filas.length; i++) {
      const fila = datosReporte.filas[i];
      if (fila && fila.length >= 6 && fila[0] !== 'TOTALES') {
        filasParaProcesar.push({
          fecha: fila[0],
          cajaInicial: parseFloat(fila[1]) || 0,
          ventas: parseFloat(fila[2]) || 0,
          gastos: parseFloat(fila[3]) || 0,
          creditos: parseFloat(fila[4]) || 0,
          utilidad: parseFloat(fila[5]) || 0
        });
      }
    }
  }
  
  let totalVentas = 0;
  let totalGastos = 0; 
  let totalCreditos = 0;
  let totalSaldoInicial = 0;
  let resultadoFinal = 0;
  
  if (filasParaProcesar && filasParaProcesar.length > 0) {
    totalVentas = filasParaProcesar.reduce((sum, d) => sum + (d.ventas || 0), 0);
    totalGastos = filasParaProcesar.reduce((sum, d) => sum + (d.gastos || 0), 0);
    totalCreditos = filasParaProcesar.reduce((sum, d) => sum + (d.creditos || 0), 0);
    totalSaldoInicial = filasParaProcesar.reduce((sum, d) => sum + (d.cajaInicial || 0), 0);
    resultadoFinal = totalSaldoInicial + totalVentas - totalGastos + totalCreditos;
  } else if (tieneFinanciero) {
    totalVentas = datosReporte.financiero.totalVentas || 0;
    totalGastos = datosReporte.financiero.totalGastos || 0;
    totalCreditos = datosReporte.financiero.totalCreditos || 0;
    totalSaldoInicial = datosReporte.financiero.cajaInicialTotal || 0;
    resultadoFinal = datosReporte.financiero.utilidadNeta || 0;
  }
  
  const margenUtilidad = totalVentas > 0 ? (resultadoFinal / totalVentas * 100) : 0;
  const promedioDiario = filasParaProcesar && filasParaProcesar.length > 0 ? (totalVentas / filasParaProcesar.length) : 0;
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalSaldoInicial.toLocaleString()}</div>
        <div style="opacity: 0.9;">Saldo Inicial Total</div>
      </div>
      <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalVentas.toLocaleString()}</div>
        <div style="opacity: 0.9;">Total Ventas</div>
      </div>
      <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalGastos.toLocaleString()}</div>
        <div style="opacity: 0.9;">Total Gastos</div>
      </div>
      <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalCreditos.toLocaleString()}</div>
        <div style="opacity: 0.9;">Total Cr√©ditos</div>
      </div>
      <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${resultadoFinal.toLocaleString()}</div>
        <div style="opacity: 0.9;">Resultado Final</div>
      </div>
    </div>
    
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
      <h4 style="margin: 0 0 10px 0; color: #1f2937; font-size: 16px;">üìä F√≥rmula de C√°lculo:</h4>
      <div style="font-family: monospace; font-size: 14px; color: #374151; background: white; padding: 15px; border-radius: 8px;">
        <strong>Resultado Final = Saldo Inicial + Ventas - Gastos + Cr√©ditos</strong><br>
        L. ${resultadoFinal.toLocaleString()} = L. ${totalSaldoInicial.toLocaleString()} + L. ${totalVentas.toLocaleString()} - L. ${totalGastos.toLocaleString()} + L. ${totalCreditos.toLocaleString()}
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
        <div style="font-size: 20px; font-weight: bold; color: #1f2937;">${margenUtilidad.toFixed(1)}%</div>
        <div style="color: #6b7280;">Margen sobre Ventas</div>
      </div>
      <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
        <div style="font-size: 20px; font-weight: bold; color: #1f2937;">L. ${promedioDiario.toLocaleString()}</div>
        <div style="color: #6b7280;">Promedio Diario Ventas</div>
      </div>
    </div>
  `;
  
  if (filasParaProcesar && filasParaProcesar.length > 0) {
    html += `
      <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="background: #3b82f6; color: white; padding: 15px;">
          <h4 style="margin: 0; font-size: 16px; font-weight: 600;">üìà Detalle Diario del Per√≠odo</h4>
        </div>
        
        <div style="max-height: 400px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead style="position: sticky; top: 0; background: #f8fafc;">
              <tr>
                <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üìÖ Fecha</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üí∞ Saldo Inicial</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üìà Ventas</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üí∏ Gastos</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üí≥ Cr√©ditos</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üéØ Resultado</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    filasParaProcesar.forEach((dia, index) => {
      const saldoInicial = dia.cajaInicial || 0;
      const ventasDia = dia.ventas || 0;
      const gastosDia = dia.gastos || 0;
      const creditosDia = dia.creditos || 0;
      const resultadoDia = saldoInicial + ventasDia - gastosDia + creditosDia;
      
      const resultadoColor = resultadoDia > 0 ? '#10b981' : '#ef4444';
      const resultadoIcon = resultadoDia > 0 ? '‚úÖ' : '‚ùå';
      
      html += `
        <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
          <td style="padding: 10px 15px; font-weight: 500; color: #1f2937;">
            ${new Date(dia.fecha).toLocaleDateString('es-ES', { 
              weekday: 'short', 
              day: '2-digit', 
              month: 'short' 
            })}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #f59e0b; font-weight: 500;">
            L. ${saldoInicial.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #10b981; font-weight: 500;">
            L. ${ventasDia.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #ef4444; font-weight: 500;">
            L. ${gastosDia.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #06b6d4; font-weight: 500;">
            L. ${creditosDia.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: ${resultadoColor}; font-weight: 600;">
            ${resultadoIcon} L. ${resultadoDia.toLocaleString()}
          </td>
        </tr>
      `;
    });
    
    html += `
        <tr style="background: #f1f5f9; border-top: 2px solid #3b82f6; font-weight: 600;">
          <td style="padding: 15px; color: #1f2937; font-weight: bold;">üî¢ TOTALES</td>
          <td style="padding: 15px; text-align: right; color: #f59e0b; font-weight: bold;">L. ${totalSaldoInicial.toLocaleString()}</td>
          <td style="padding: 15px; text-align: right; color: #10b981; font-weight: bold;">L. ${totalVentas.toLocaleString()}</td>
          <td style="padding: 15px; text-align: right; color: #ef4444; font-weight: bold;">L. ${totalGastos.toLocaleString()}</td>
          <td style="padding: 15px; text-align: right; color: #06b6d4; font-weight: bold;">L. ${totalCreditos.toLocaleString()}</td>
          <td style="padding: 15px; text-align: right; color: ${resultadoFinal > 0 ? '#10b981' : '#ef4444'}; font-weight: bold; font-size: 16px;">
            ${resultadoFinal > 0 ? 'üéâ' : '‚ö†Ô∏è'} L. ${resultadoFinal.toLocaleString()}
          </td>
        </tr>
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  return html;
}

function generarHTMLCiudades(datosReporte) {
  if (!datosReporte.ciudades || datosReporte.ciudades.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de ciudades en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalVentas = datosReporte.ciudades.reduce((sum, c) => sum + c.totalVentas, 0);
  const totalIngresos = datosReporte.ciudades.reduce((sum, c) => sum + c.ingresoTotal, 0);
  const ciudadTop = datosReporte.ciudades[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalVentas}</div>
      <div style="opacity: 0.9;">Total Ventas</div>
    </div>
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalIngresos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Ingresos Totales</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 18px; font-weight: bold;">${ciudadTop.ciudad}</div>
      <div style="opacity: 0.9;">Ciudad L√≠der</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.ciudades.length}</div>
      <div style="opacity: 0.9;">Ciudades Atendidas</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ranking</th>
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ciudad</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ventas</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ingresos</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Vendedores</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.ciudades.forEach((ciudad, index) => {
    const colorRanking = index === 0 ? '#fbbf24' : index === 1 ? '#9ca3af' : index === 2 ? '#f97316' : '#6b7280';
    const iconoRanking = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
    const participacion = (ciudad.ingresoTotal / totalIngresos * 100);
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px;">
          <span style="color: ${colorRanking}; font-weight: bold; font-size: 16px;">${iconoRanking}</span>
        </td>
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${ciudad.ciudad}</td>
        <td style="padding: 12px 15px; text-align: center; color: #3b82f6; font-weight: 500;">${ciudad.totalVentas}</td>
        <td style="padding: 12px 15px; text-align: right; color: #1f2937; font-weight: 600;">L. ${ciudad.ingresoTotal.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">${ciudad.vendedoresActivos}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 30 ? '#dcfce7' : participacion > 15 ? '#fef3c7' : '#fee2e2'}; 
                       color: ${participacion > 30 ? '#166534' : participacion > 15 ? '#92400e' : '#991b1b'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

function generarHTMLGastos(datosReporte) {
  if (!datosReporte.gastos || datosReporte.gastos.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de gastos en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalGastos = datosReporte.gastos.reduce((sum, g) => sum + g.total, 0);
  const totalCantidad = datosReporte.gastos.reduce((sum, g) => sum + g.cantidad, 0);
  const gastoTop = datosReporte.gastos[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalGastos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Total Gastos</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalCantidad}</div>
      <div style="opacity: 0.9;">Total Registros</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 16px; font-weight: bold;">${gastoTop.categoria}</div>
      <div style="opacity: 0.9;">Categor√≠a Mayor</div>
    </div>
    <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.gastos.length}</div>
      <div style="opacity: 0.9;">Categor√≠as</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Categor√≠a</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Total</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Cantidad</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Promedio</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.gastos.forEach((gasto, index) => {
    const participacion = (gasto.total / totalGastos * 100);
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${gasto.categoria}</td>
        <td style="padding: 12px 15px; text-align: right; color: #ef4444; font-weight: 600;">L. ${gasto.total.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">${gasto.cantidad}</td>
        <td style="padding: 12px 15px; text-align: right; color: #6b7280;">L. ${gasto.promedio.toFixed(2)}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 40 ? '#fef2f2' : participacion > 20 ? '#fef3c7' : '#f0fdf4'}; 
                       color: ${participacion > 40 ? '#991b1b' : participacion > 20 ? '#92400e' : '#166534'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

function generarHTMLCreditos(datosReporte) {
  if (!datosReporte.creditos || datosReporte.creditos.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de cr√©ditos en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalCreditos = datosReporte.creditos.reduce((sum, c) => sum + c.total, 0);
  const totalCantidad = datosReporte.creditos.reduce((sum, c) => sum + c.cantidad, 0);
  const creditoTop = datosReporte.creditos[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalCreditos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Total Cr√©ditos</div>
    </div>
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalCantidad}</div>
      <div style="opacity: 0.9;">Total Registros</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 16px; font-weight: bold;">${creditoTop.categoria}</div>
      <div style="opacity: 0.9;">Categor√≠a Mayor</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.creditos.length}</div>
      <div style="opacity: 0.9;">Categor√≠as</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Categor√≠a</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Total</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Cantidad</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Promedio</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.creditos.forEach((credito, index) => {
    const participacion = (credito.total / totalCreditos * 100);
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${credito.categoria}</td>
        <td style="padding: 12px 15px; text-align: right; color: #06b6d4; font-weight: 600;">L. ${credito.total.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">${credito.cantidad}</td>
        <td style="padding: 12px 15px; text-align: right; color: #6b7280;">L. ${credito.promedio.toFixed(2)}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 50 ? '#ecfdf5' : participacion > 25 ? '#fef3c7' : '#f0f9ff'}; 
                       color: ${participacion > 50 ? '#166534' : participacion > 25 ? '#92400e' : '#0369a1'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}
// ===== GENERAR HTML SEG√öN TIPO DE REPORTE =====
function generarHTMLReporte(datosReporte, tipoReporte) {
  switch (tipoReporte) {
    case 'vendedores':
      return generarHTMLVendedores(datosReporte);
    case 'productos':
      return generarHTMLProductos(datosReporte);
    case 'ciudades':
      return generarHTMLCiudades(datosReporte);
    case 'financiero':
      return generarHTMLFinanciero(datosReporte);
    case 'gastos':
      return generarHTMLGastos(datosReporte);
    case 'creditos':
      return generarHTMLCreditos(datosReporte);
    case 'completo':
      return generarHTMLCompleto(datosReporte);
    default:
      return '<p>Tipo de reporte no v√°lido</p>';
  }
}

// HTML para reporte de vendedores
function generarHTMLVendedores(datosReporte) {
  if (!datosReporte.vendedores || datosReporte.vendedores.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de vendedores en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalVentas = datosReporte.vendedores.reduce((sum, v) => sum + v.totalVentas, 0);
  const totalIngresos = datosReporte.vendedores.reduce((sum, v) => sum + v.ingresoTotal, 0);
  const mejorVendedor = datosReporte.vendedores[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalVentas}</div>
      <div style="opacity: 0.9;">Total Ventas</div>
    </div>
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalIngresos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Ingresos Totales</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 18px; font-weight: bold;">${mejorVendedor.vendedor}</div>
      <div style="opacity: 0.9;">Mejor Vendedor</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.vendedores.length}</div>
      <div style="opacity: 0.9;">Vendedores Activos</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ranking</th>
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Vendedor</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ventas</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Botellones</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Bolsas</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ingresos</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.vendedores.forEach((vendedor, index) => {
    const colorRanking = index === 0 ? '#fbbf24' : index === 1 ? '#9ca3af' : index === 2 ? '#f97316' : '#6b7280';
    const iconoRanking = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px;">
          <span style="color: ${colorRanking}; font-weight: bold; font-size: 16px;">${iconoRanking}</span>
        </td>
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${vendedor.vendedor}</td>
        <td style="padding: 12px 15px; text-align: center; color: #374151;">${vendedor.totalVentas}</td>
        <td style="padding: 12px 15px; text-align: center; color: #3b82f6; font-weight: 500;">${vendedor.botellones}</td>
        <td style="padding: 12px 15px; text-align: center; color: #10b981; font-weight: 500;">${vendedor.bolsas}</td>
        <td style="padding: 12px 15px; text-align: right; color: #1f2937; font-weight: 600;">L. ${vendedor.ingresoTotal.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${vendedor.participacion > 30 ? '#dcfce7' : vendedor.participacion > 20 ? '#fef3c7' : '#fee2e2'}; 
                       color: ${vendedor.participacion > 30 ? '#166534' : vendedor.participacion > 20 ? '#92400e' : '#991b1b'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${vendedor.participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

// HTML para reporte completo
function generarHTMLCompleto(datosReporte) {
  if (!datosReporte) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos para el reporte completo</p>';
  }
  
  let html = `
    <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
      <h2 style="margin: 0 0 15px 0; font-size: 28px; font-weight: 700;">üìä Resumen Ejecutivo</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">${datosReporte.datos || 0}</div>
          <div style="opacity: 0.9;">D√≠as Analizados</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">${datosReporte.vendedores?.length || 0}</div>
          <div style="opacity: 0.9;">Vendedores Activos</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">${datosReporte.productos?.length || 0}</div>
          <div style="opacity: 0.9;">Tipos de Productos</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">L. ${datosReporte.financiero?.totalVentas?.toLocaleString() || '0'}</div>
          <div style="opacity: 0.9;">Ventas Totales</div>
        </div>
      </div>
    </div>
    
    <div style="margin-bottom: 40px;">
      <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px; font-weight: 600; border-bottom: 3px solid #3b82f6; padding-bottom: 10px;">
        üë• Top 3 Vendedores
      </h3>
      ${datosReporte.vendedores ? generarTop3Vendedores(datosReporte.vendedores) : '<p>No hay datos de vendedores</p>'}
    </div>
    
    <div style="margin-bottom: 40px;">
      <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px; font-weight: 600; border-bottom: 3px solid #10b981; padding-bottom: 10px;">
        üßä An√°lisis de Productos
      </h3>
      ${datosReporte.productos ? generarResumenProductos(datosReporte.productos) : '<p>No hay datos de productos</p>'}
    </div>
    
    <div style="margin-bottom: 40px;">
      <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px; font-weight: 600; border-bottom: 3px solid #8b5cf6; padding-bottom: 10px;">
        üí∞ Resumen Financiero
      </h3>
      ${datosReporte.financiero ? generarResumenFinanciero(datosReporte.financiero) : '<p>No hay datos financieros</p>'}
    </div>
  `;
  
  return html;
}

function generarTop3Vendedores(vendedores) {
  const top3 = vendedores.slice(0, 3);
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
  
  top3.forEach((vendedor, index) => {
    const color = index === 0 ? '#fbbf24' : index === 1 ? '#9ca3af' : '#f97316';
    const icono = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
    
    html += `
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid ${color};">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
          <span style="font-size: 24px; margin-right: 10px;">${icono}</span>
          <h4 style="margin: 0; color: #1f2937; font-size: 18px;">${vendedor.vendedor}</h4>
        </div>
        <div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Ventas:</span>
            <strong style="color: #1f2937;">${vendedor.totalVentas}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Ingresos:</span>
            <strong style="color: #10b981;">L. ${vendedor.ingresoTotal?.toLocaleString() || '0'}</strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">Participaci√≥n:</span>
            <strong style="color: #3b82f6;">${vendedor.participacion?.toFixed(1) || '0'}%</strong>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function generarResumenProductos(productos) {
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">';
  
  productos.forEach((producto, index) => {
    const color = index === 0 ? '#10b981' : '#3b82f6';
    
    html += `
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid ${color};">
        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">${producto.producto}</h4>
        <div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Cantidad:</span>
            <strong style="color: #1f2937;">${producto.cantidadVendida || 0}</strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">Ingresos:</span>
            <strong style="color: #10b981;">L. ${producto.ingresoTotal?.toLocaleString() || '0'}</strong>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function generarResumenFinanciero(financiero) {
  const utilidadColor = (financiero.utilidadNeta || 0) > 0 ? '#10b981' : '#ef4444';
  
  return `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #10b981;">
        <div style="font-size: 20px; font-weight: bold; color: #10b981;">L. ${(financiero.totalVentas || 0).toLocaleString()}</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Ventas</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #ef4444;">
        <div style="font-size: 20px; font-weight: bold; color: #ef4444;">L. ${(financiero.totalGastos || 0).toLocaleString()}</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Gastos</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid ${utilidadColor};">
        <div style="font-size: 20px; font-weight: bold; color: ${utilidadColor};">L. ${(financiero.utilidadNeta || 0).toLocaleString()}</div>
        <div style="color: #6b7280; margin-top: 5px;">Utilidad Neta</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #8b5cf6;">
        <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">${(financiero.margenUtilidad || 0).toFixed(1)}%</div>
        <div style="color: #6b7280; margin-top: 5px;">Margen de Utilidad</div>
      </div>
    </div>
  `;
}
console.log('‚úÖ Sistema de Reportes cargado');
// ===== FUNCIONALIDAD DE EXPORTACI√ìN A EXCEL =====
function exportarAExcel() {
  console.log('üì• Exportando datos a Excel...');
  
  try {
    // Verificar que XLSX est√© disponible
    if (typeof XLSX === 'undefined') {
      alert('‚ùå Error: Librer√≠a XLSX no cargada. Por favor recarga la p√°gina.');
      return;
    }
    
    // Verificar que haya datos para exportar
    if (!datosActuales) {
      alert('‚ùå No hay datos para exportar. Por favor actualiza el dashboard primero.');
      return;
    }
    
    // Crear un nuevo libro de Excel
    const wb = XLSX.utils.book_new();
    
    // === HOJA 1: RESUMEN GENERAL ===
    const resumenData = [
      ['DASHBOARD AGUA ZAFIRO'],
      ['Fecha de generaci√≥n:', new Date().toLocaleString('es-ES')],
      ['Per√≠odo:', periodoActual],
      [],
      ['RESUMEN FINANCIERO'],
      ['Concepto', 'Monto (L.)'],
      ['Total Ventas', datosActuales.totalVentas],
      ['Total Gastos', datosActuales.totalGastos],
      ['Total Cr√©ditos', datosActuales.totalCreditos],
      ['Saldo Inicial Total', datosActuales.cajaInicialTotal || 0],
      ['Resultado Final', datosActuales.cajaInicialTotal + datosActuales.totalVentas - datosActuales.totalGastos + datosActuales.totalCreditos],
      [],
      ['Total de Registros:', datosActuales.totalRegistros]
    ];
    
    const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
    
    // Aplicar estilos (anchos de columna)
    wsResumen['!cols'] = [
      { wch: 25 },
      { wch: 15 }
    ];
    
    XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen General');
    
    // === HOJA 2: VENTAS POR VENDEDOR ===
    const vendedoresData = [
      ['VENTAS POR VENDEDOR'],
      [],
      ['Vendedor', 'Cantidad Ventas', 'Botellones', 'Bolsas', 'Total (L.)']
    ];
    
    Object.entries(datosActuales.ventasPorVendedor).forEach(([vendedor, datos]) => {
      vendedoresData.push([
        vendedor,
        datos.cantidad,
        datos.botellones,
        datos.bolsas,
        datos.total
      ]);
    });
    
    const wsVendedores = XLSX.utils.aoa_to_sheet(vendedoresData);
    wsVendedores['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, wsVendedores, 'Ventas por Vendedor');
    
    // === HOJA 3: VENTAS POR PRODUCTO ===
    const productosData = [
      ['VENTAS POR PRODUCTO'],
      [],
      ['Producto', 'Cantidad', 'Total (L.)']
    ];
    
    Object.entries(datosActuales.ventasPorProducto).forEach(([producto, datos]) => {
      productosData.push([
        producto,
        datos.cantidad,
        datos.total
      ]);
    });
    
    const wsProductos = XLSX.utils.aoa_to_sheet(productosData);
    wsProductos['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, wsProductos, 'Ventas por Producto');
    
    // === HOJA 4: VENTAS POR CIUDAD ===
    const ciudadesData = [
      ['VENTAS POR CIUDAD'],
      [],
      ['Ciudad', 'Total (L.)']
    ];
    
    Object.entries(datosActuales.ventasPorCiudad).forEach(([ciudad, total]) => {
      ciudadesData.push([ciudad, total]);
    });
    
    const wsCiudades = XLSX.utils.aoa_to_sheet(ciudadesData);
    wsCiudades['!cols'] = [{ wch: 20 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, wsCiudades, 'Ventas por Ciudad');
    
    // === HOJA 5: GASTOS POR CATEGOR√çA ===
    const gastosData = [
      ['GASTOS POR CATEGOR√çA'],
      [],
      ['Categor√≠a', 'Total (L.)']
    ];
    
    Object.entries(datosActuales.gastosPorCategoria).forEach(([categoria, total]) => {
      gastosData.push([categoria, total]);
    });
    
    const wsGastos = XLSX.utils.aoa_to_sheet(gastosData);
    wsGastos['!cols'] = [{ wch: 20 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, wsGastos, 'Gastos por Categor√≠a');
    
    // === HOJA 6: CR√âDITOS ===
    if (datosActuales.creditosPorCategoria && Object.keys(datosActuales.creditosPorCategoria).length > 0) {
      const creditosData = [
        ['CR√âDITOS POR CATEGOR√çA'],
        [],
        ['Categor√≠a', 'Total (L.)']
      ];
      
      Object.entries(datosActuales.creditosPorCategoria).forEach(([categoria, total]) => {
        creditosData.push([categoria, total]);
      });
      
      const wsCreditos = XLSX.utils.aoa_to_sheet(creditosData);
      wsCreditos['!cols'] = [{ wch: 20 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, wsCreditos, 'Cr√©ditos');
    }
    
    // === HOJA 7: EVOLUCI√ìN DIARIA ===
    if (datosActuales.evolucionDiaria && datosActuales.evolucionDiaria.length > 0) {
      const evolucionData = [
        ['EVOLUCI√ìN DIARIA'],
        [],
        ['Fecha', 'Ventas (L.)', 'Gastos (L.)', 'Caja Inicial (L.)']
      ];
      
      datosActuales.evolucionDiaria.forEach(dia => {
        evolucionData.push([
          dia.fecha,
          dia.ventas,
          dia.gastos,
          dia.cajaInicial
        ]);
      });
      
      const wsEvolucion = XLSX.utils.aoa_to_sheet(evolucionData);
      wsEvolucion['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, wsEvolucion, 'Evoluci√≥n Diaria');
    }
    
    // Generar nombre del archivo con fecha
    const fecha = new Date();
    const nombreArchivo = `Agua_Zafiro_Dashboard_${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}.xlsx`;
    
    // Descargar el archivo
    XLSX.writeFile(wb, nombreArchivo);
    
    console.log('‚úÖ Archivo Excel generado exitosamente:', nombreArchivo);
    
    // Mostrar mensaje de √©xito
    const statusElement = document.getElementById('infoStatus');
    if (statusElement) {
      const mensajeOriginal = statusElement.innerHTML;
      statusElement.innerHTML = '‚úÖ Excel exportado exitosamente: ' + nombreArchivo;
      statusElement.style.background = '#ecfdf5';
      statusElement.style.color = '#065f46';
      
      setTimeout(() => {
        statusElement.innerHTML = mensajeOriginal;
        statusElement.style.background = '#f3f4f6';
        statusElement.style.color = '#6b7280';
      }, 3000);
    }
    
  } catch (error) {
    console.error('‚ùå Error exportando a Excel:', error);
    alert('Error al exportar: ' + error.message);
  }
}

// Vincular el bot√≥n de exportar
document.addEventListener('DOMContentLoaded', function() {
  const btnExportar = document.querySelector('.btn.export');
  if (btnExportar) {
    btnExportar.addEventListener('click', exportarAExcel);
    console.log('‚úÖ Bot√≥n de exportar vinculado correctamente');
  } else {
    console.warn('‚ö†Ô∏è Bot√≥n de exportar no encontrado en el DOM');
  }
});

console.log('‚úÖ Funcionalidad de exportaci√≥n a Excel cargada');
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="auth.js"></script>
<script src="roles.js"></script>

</body>
</html>