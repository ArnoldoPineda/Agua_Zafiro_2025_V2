<!DOCTYPE html>
<div class="user-info">
  <span class="user-name"></span> | 
  <span class="user-role"></span>
</div>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard General</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- üì° SUPABASE CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- üìä XLSX PARA REPORTES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      transition: transform 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-2px);
    }

    .chart-card h3 {
      margin: 0 0 15px 0;
      color: #1f2937;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .chart-container.large {
      height: 400px;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 6px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      font-weight: 500;
    }

    .filter-select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .performance-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      margin-top: 25px;
    }

    .performance-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .performance-table th,
    .performance-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .performance-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .performance-table tr:hover {
      background: #f3f4f6;
    }

    .refresh-btn {
      position: fixed;
      top: 100px;
      right: 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      z-index: 1000;
    }

    .refresh-btn:hover {
      background: #059669;
      transform: scale(1.1);
    }

    .data-source-indicator {
      position: fixed;
      top: 160px;
      right: 20px;
      background: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #e5e7eb;
    }

    .data-source-indicator.real-data {
      border-color: #10b981;
      color: #10b981;
    }

    .data-source-indicator.demo-data {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    .connection-status {
      position: fixed;
      top: 210px;
      right: 20px;
      background: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #e5e7eb;
      z-index: 1000;
    }

    .connection-status.connected {
      border-color: #10b981;
      color: #10b981;
    }

    .connection-status.disconnected {
      border-color: #ef4444;
      color: #ef4444;
    }

    .connection-status.connecting {
      border-color: #f59e0b;
      color: #f59e0b;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <h1>üíß Agua Zafiro</h1>
    <div class="nav-actions">
      <div class="status"><i class="fas fa-circle"></i> Sistema Activo</div>
      <button class="btn import"><i class="fas fa-upload"></i> Importar</button>
      <button class="btn export"><i class="fas fa-download"></i> Exportar</button>
      <!-- <button class="btn reports" onclick="abrirModuloReportes()"><i class="fas fa-chart-bar"></i> Reportes</button> -->
<button class="btn reports" onclick="abrirModuloReportes()"><i class="fas fa-chart-bar"></i> Reportes</button>      <a href="capturador.html" class="nav-btn">
        <i class="fas fa-clipboard-list"></i>
        <span>Capturador</span>
      </a>
      <a href="calendario.html" class="nav-btn">
        <i class="fas fa-calendar-alt"></i>
        <span>Calendario</span>
      </a>
      <a href="dashboard.html" class="nav-btn active">
        <i class="fas fa-chart-line"></i>
        <span>Dashboard</span>
      </a>
    </div>
  </nav>

  <!-- Bot√≥n de actualizaci√≥n y indicadores -->
  <button class="refresh-btn" onclick="cargarDatosSupabase()" title="Actualizar datos reales">
    <i class="fas fa-sync-alt"></i>
  </button>
  
  <div class="data-source-indicator demo-data" id="dataSourceIndicator">
    <i class="fas fa-database"></i> Datos Demo
  </div>

  <div class="connection-status connecting" id="connectionStatus">
    <i class="fas fa-wifi"></i> Conectando...
  </div>

  <div class="dashboard">
    <!-- KPIs Principales -->
    <div class="stats" id="statsSection">
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #10b981;" id="totalVentas">L. 53,262</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Ventas</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="totalGastos">L. 15,240</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Gastos</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="totalCreditos">L. 3,445</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Cr√©ditos</div>
      </div>
      <div class="stat-card">
        <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;" id="resultadoFinal">L. 41,467</div>
        <div style="color: #6b7280; margin-top: 5px;">Resultado Final</div>
      </div>
    </div>

    <!-- Gr√°ficas -->
    <div class="charts-grid" id="chartsSection">
      <div class="chart-card">
        <h3><i class="fas fa-chart-pie"></i> Ventas por Producto</h3>
        <div class="filters">
          <select class="filter-select" id="periodoProducto">
            <option value="7">√öltimos 7 d√≠as</option>
            <option value="30" selected>√öltimos 30 d√≠as</option>
            <option value="90">√öltimos 90 d√≠as</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="ventasProductoChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-users"></i> Ventas por Vendedor</h3>
        <div class="filters">
          <select class="filter-select" id="tipoVenta">
            <option value="unidades">Por Unidades</option>
            <option value="dinero">Por Dinero</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="ventasChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-wallet"></i> Gastos por Categor√≠a</h3>
        <div class="chart-container">
          <canvas id="gastosChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3><i class="fas fa-map-marker-alt"></i> Ventas por Ciudad</h3>
        <div class="chart-container">
          <canvas id="ciudadesChart"></canvas>
        </div>
      </div>
    </div>

    <div class="chart-card" id="evolutionSection">
      <h3><i class="fas fa-chart-line"></i> Evoluci√≥n Ventas vs Gastos</h3>
      <div class="filters">
        <select class="filter-select" id="periodoEvolucion">
          <option value="7">√öltimos 7 d√≠as</option>
          <option value="30" selected>√öltimos 30 d√≠as</option>
          <option value="90">√öltimos 90 d√≠as</option>
        </select>
      </div>
      <div class="chart-container large">
        <canvas id="evolucionChart"></canvas>
      </div>
    </div>

    <div class="performance-section" id="performanceSection">
      <h3 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px; font-weight: 600;">
        <i class="fas fa-trophy"></i> Performance de Vendedores
      </h3>
      <table class="performance-table">
        <thead>
          <tr>
            <th>Vendedor</th>
            <th>Botellones</th>
            <th>Bolsas</th>
            <th>Total Ventas</th>
            <th>Tendencia</th>
          </tr>
        </thead>
        <tbody id="performanceTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <script>
// ===== CONFIGURACI√ìN DE SUPABASE =====
const SUPABASE_URL = 'https://hjrplwxvyukevcljodyg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqcnBsd3h2eXVrZXZjbGpvZHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzUzMzQsImV4cCI6MjA3MzYxMTMzNH0.uJ-krjLrFVo7cHuIQQb1-x2wQzXwyZfcvg4XvnppkqE';

// Inicializar Supabase
let supabaseClient = null;

// Funci√≥n para inicializar Supabase con verificaci√≥n
async function inicializarSupabase() {
  try {
    const statusElement = document.getElementById('connectionStatus');
    
    // Verificar si las credenciales est√°n configuradas
    if (SUPABASE_URL === 'TU_SUPABASE_URL_AQUI' || SUPABASE_ANON_KEY === 'TU_SUPABASE_ANON_KEY_AQUI') {
      console.warn('üîë Credenciales de Supabase no configuradas, usando datos demo');
      if (statusElement) {
        statusElement.className = 'connection-status disconnected';
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sin configurar';
      }
      return false;
    }

    // Crear cliente de Supabase
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Probar la conexi√≥n
    const { data, error } = await supabaseClient
      .from('daily_records')
      .select('count', { count: 'exact', head: true });

    if (error) {
      throw error;
    }

    console.log('‚úÖ Supabase conectado correctamente');
    if (statusElement) {
      statusElement.className = 'connection-status connected';
      statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Conectado';
    }
    return true;
    
  } catch (error) {
    console.error('‚ùå Error conectando a Supabase:', error);
    const statusElement = document.getElementById('connectionStatus');
    if (statusElement) {
      statusElement.className = 'connection-status disconnected';
      statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Error conexi√≥n';
    }
    return false;
  }
}

// ===== DASHBOARD AGUA ZAFIRO =====
console.log('üöÄ Dashboard Agua Zafiro iniciando...');

// Variables globales
let charts = {};
let datosActuales = null;
let periodoActual = 'mes';
let fechaSeleccionada = new Date().toISOString().split('T')[0];
let conexionSupabase = false;

// Configuraci√≥n de colores
const colores = {
  primary: '#3b82f6',
  success: '#10b981',
  warning: '#f59e0b',
  danger: '#ef4444',
  purple: '#8b5cf6',
  teal: '#14b8a6',
  orange: '#f97316',
  indigo: '#6366f1'
};

// Datos demo para cuando no hay conexi√≥n a Supabase
const datosDemo = {
  totalRegistros: 5,
  ventasPorVendedor: {
    'Brayan': { cantidad: 456, total: 24580, botellones: 300, bolsas: 156 },
    'Ariel': { cantidad: 389, total: 22300, botellones: 250, bolsas: 139 },
    'Bodega': { cantidad: 334, total: 18700, botellones: 200, bolsas: 134 }
  },
  ventasPorProducto: {
    'Botell√≥n 20L': { cantidad: 750, total: 22500 },
    'Bolsa 500ml': { cantidad: 429, total: 7722 }
  },
  ventasPorCiudad: {
    'Tegucigalpa': 28400,
    'San Pedro Sula': 15600,
    'La Ceiba': 9800,
    'Comayagua': 8200
  },
  gastosPorCategoria: {
  'COMBUSTIBLE': 5500,
  'PLANILLAS': 6800,
  'MANTENIMIENTO': 2200,
  'OTROS': 740
},
creditosPorCategoria: {
  'VENTAS A CREDITO': 3445
},
  totalVentas: 53262,
  totalGastos: 15240,
  totalCreditos: 3445,
  cajaInicialTotal: 5000,
  evolucionDiaria: [
    { fecha: '2025-09-15', ventas: 12000, gastos: 3000, cajaInicial: 1000 },
    { fecha: '2025-09-16', ventas: 15000, gastos: 3500, cajaInicial: 1000 },
    { fecha: '2025-09-17', ventas: 13500, gastos: 2800, cajaInicial: 1000 },
    { fecha: '2025-09-18', ventas: 14200, gastos: 3200, cajaInicial: 1000 },
    { fecha: '2025-09-19', ventas: 16800, gastos: 4100, cajaInicial: 1000 }
  ]
};

// ===== INICIALIZACI√ìN =====
document.addEventListener("DOMContentLoaded", async function() {
  console.log('üìä Inicializando Dashboard...');
  
  // Intentar conectar a Supabase
  conexionSupabase = await inicializarSupabase();
  
  // Crear controles de per√≠odo
  crearControlesPeriodo();
  
  // Cargar datos (Supabase o demo)
  if (conexionSupabase) {
    await cargarDatosSupabase();
  } else {
    cargarDatosDemo();
  }
  
  // Crear gr√°ficas
crearTodasLasGraficas();
actualizarGraficas(datosActuales);
  
  console.log('‚úÖ Dashboard inicializado');
});

// ===== CONTROLES DE PER√çODO =====
function crearControlesPeriodo() {
  const statsSection = document.getElementById('statsSection');
  if (!statsSection) return;
  
  const hoy = new Date().toISOString().split('T')[0];
  
  const controlesHTML = `
    <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
        <h2 style="margin: 0; color: #1f2937; font-size: 24px; font-weight: 700;">
          üìä Dashboard Agua Zafiro
        </h2>
        
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <button id="btnActualizar" style="background: #10b981; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer;">
            üîÑ Actualizar
          </button>
        </div>
      </div>
      
      <!-- Filtros de per√≠odo -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 15px;">
        
        <!-- Per√≠odos r√°pidos -->
        <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0;">
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">‚ö° Per√≠odos R√°pidos:</label>
          <select id="selectorPeriodo" style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 500;">
            <option value="hoy">üìÖ Hoy</option>
            <option value="ayer">üìÖ Ayer</option>
            <option value="mes" selected>üóìÔ∏è Este mes</option>
            <option value="mes_pasado">üóìÔ∏è Mes pasado</option>
            <option value="ano">üìÜ Este a√±o</option>
            <option value="ano_pasado">üìÜ A√±o pasado</option>
          </select>
        </div>
        
        <!-- Filtros por semanas -->
        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border: 1px solid #bae6fd;">
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">üìÖ Por Semanas:</label>
          <select id="selectorSemana" style="width: 100%; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 500;">
            <option value="">Seleccionar semana...</option>
            <option value="esta_semana">üìÖ Esta semana</option>
            <option value="semana_pasada">üìÖ Semana pasada</option>
            <option value="ultimas_2_semanas">üìÖ √öltimas 2 semanas</option>
            <option value="ultimas_4_semanas">üìÖ √öltimas 4 semanas</option>
            <option value="este_mes_semanas">üìÖ Semanas de este mes</option>
          </select>
        </div>
        
        <!-- Rango personalizado -->
        <div style="background: #fefce8; padding: 15px; border-radius: 10px; border: 1px solid #fde047;">
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">üéØ Rango Personalizado:</label>
          <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <input type="date" id="fechaInicio" style="padding: 6px 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;" value="${hoy}">
            <span style="color: #6b7280; font-weight: 500;">hasta</span>
            <input type="date" id="fechaFin" style="padding: 6px 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;" value="${hoy}">
            <button id="btnAplicarRango" style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 500; font-size: 13px; cursor: pointer;">
              Aplicar
            </button>
          </div>
        </div>
        
      </div>
      
      <div id="infoStatus" style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 8px; font-size: 14px; color: #6b7280;">
        üìç Cargando datos...
      </div>
    </div>
  `;
  
  statsSection.insertAdjacentHTML('beforebegin', controlesHTML);
  
  // Event listeners
  const selector = document.getElementById('selectorPeriodo');
  const selectorSemana = document.getElementById('selectorSemana');
  const fechaInicio = document.getElementById('fechaInicio');
  const fechaFin = document.getElementById('fechaFin');
  const btnActualizar = document.getElementById('btnActualizar');
  const btnAplicarRango = document.getElementById('btnAplicarRango');
  
  // Per√≠odos r√°pidos
  selector.addEventListener('change', function() {
    if (this.value) {
      periodoActual = this.value;
      selectorSemana.value = ''; // Limpiar selector de semanas
      cargarDatosSegunConexion();
    }
  });
  
  // Filtros por semanas
  selectorSemana.addEventListener('change', function() {
    if (this.value) {
      periodoActual = this.value;
      selector.value = ''; // Limpiar selector de per√≠odos
      cargarDatosSegunConexion();
    }
  });
  
  // Rango personalizado
  btnAplicarRango.addEventListener('click', function() {
    const inicio = fechaInicio.value;
    const fin = fechaFin.value;
    
    if (!inicio || !fin) {
      alert('Por favor selecciona ambas fechas');
      return;
    }
    
    if (inicio > fin) {
      alert('La fecha de inicio no puede ser mayor que la fecha de fin');
      return;
    }
    
    periodoActual = 'rango_personalizado';
    selector.value = '';
    selectorSemana.value = '';
    cargarDatosSegunConexion();
  });
  
  // Bot√≥n actualizar
  btnActualizar.addEventListener('click', cargarDatosSegunConexion);
  
  // Funci√≥n auxiliar para cargar datos seg√∫n conexi√≥n
  function cargarDatosSegunConexion() {
    if (conexionSupabase) {
      cargarDatosSupabase();
    } else {
      cargarDatosDemo();
    }
  }
}

// ===== CARGA DE DATOS DEMO =====
function cargarDatosDemo() {
  console.log('üìã Cargando datos demo...');
  
  const statusElement = document.getElementById('infoStatus');
  const dataSourceElement = document.getElementById('dataSourceIndicator');
  
  if (statusElement) {
    statusElement.innerHTML = '‚ö†Ô∏è Usando datos de demostraci√≥n - Configure Supabase para datos reales';
    statusElement.style.background = '#fef3c7';
    statusElement.style.color = '#92400e';
  }
  
  if (dataSourceElement) {
    dataSourceElement.className = 'data-source-indicator demo-data';
    dataSourceElement.innerHTML = '<i class="fas fa-database"></i> Datos Demo';
  }
  
  datosActuales = datosDemo;
  
  // Actualizar interfaz
  const descripcion = `Datos demo - ${periodoActual}`;
  actualizarKPIs(datosActuales, descripcion);
  actualizarGraficas(datosActuales);
  crearTablaPerformance(datosActuales);
}

// ===== CARGA DE DATOS DE SUPABASE =====
async function cargarDatosSupabase() {
  if (!conexionSupabase || !supabaseClient) {
    console.log('‚ùå No hay conexi√≥n a Supabase, usando datos demo');
    cargarDatosDemo();
    return;
  }
  
  console.log(`üì° Cargando datos de Supabase - Per√≠odo: ${periodoActual}`);
  
  const statusElement = document.getElementById('infoStatus');
  const dataSourceElement = document.getElementById('dataSourceIndicator');
  
  try {
    if (statusElement) {
      statusElement.innerHTML = '‚è≥ Cargando datos de Supabase...';
      statusElement.style.background = '#fef3c7';
    }
    
    // Calcular fechas seg√∫n el per√≠odo
    const { fechaInicio, fechaFin, descripcion } = calcularRangoFechas();
    
    console.log(`üìÖ Consultando desde ${fechaInicio} hasta ${fechaFin}`);
    
    // Consultar Supabase
    const { data: records, error } = await supabaseClient
      .from('daily_records')
      .select(`
        fecha,
        caja_inicial,
        observaciones,
        sales(vendedor, ciudad, producto, cantidad, precio, total, orden),
        expenses(categoria, descripcion, monto, orden),
        credits(categoria, detalle, monto, orden)
      `)
      .gte('fecha', fechaInicio)
      .lte('fecha', fechaFin)
      .order('fecha', { ascending: true });
    
    if (error) {
      throw new Error(`Error consultando Supabase: ${error.message}`);
    }
    
    // Procesar datos
    datosActuales = procesarDatosSupabase(records || []);
    
    // Actualizar interfaz
    actualizarKPIs(datosActuales, descripcion);
    actualizarGraficas(datosActuales);
    crearTablaPerformance(datosActuales);
    
    if (statusElement) {
      statusElement.innerHTML = `‚úÖ ${descripcion} - ${records?.length || 0} registros encontrados - √öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`;
      statusElement.style.background = '#ecfdf5';
      statusElement.style.color = '#065f46';
    }
    
    if (dataSourceElement) {
      dataSourceElement.className = 'data-source-indicator real-data';
      dataSourceElement.innerHTML = '<i class="fas fa-database"></i> Datos Reales';
    }
    
    console.log(`‚úÖ Datos cargados: ${records?.length || 0} registros`);
    
  } catch (error) {
    console.error('‚ùå Error cargando datos:', error);
    
    if (statusElement) {
      statusElement.innerHTML = `‚ùå Error: ${error.message}`;
      statusElement.style.background = '#fef2f2';
      statusElement.style.color = '#991b1b';
    }
    
    // Cargar datos demo como fallback
    cargarDatosDemo();
  }
}

// ===== C√ÅLCULO DE RANGOS DE FECHAS =====
function calcularRangoFechas() {
  const hoy = new Date();
  let fechaInicio, fechaFin, descripcion;
  
  switch (periodoActual) {
    case 'hoy':
      const fechaHoy = hoy.toISOString().split('T')[0];
      fechaInicio = fechaHoy;
      fechaFin = fechaHoy;
      descripcion = `Datos de hoy (${fechaHoy})`;
      break;
      
    case 'ayer':
      const ayer = new Date(hoy);
      ayer.setDate(hoy.getDate() - 1);
      const fechaAyer = ayer.toISOString().split('T')[0];
      fechaInicio = fechaAyer;
      fechaFin = fechaAyer;
      descripcion = `Datos de ayer (${fechaAyer})`;
      break;
      
    case 'mes':
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      fechaInicio = inicioMes.toISOString().split('T')[0];
      fechaFin = finMes.toISOString().split('T')[0];
      descripcion = `Datos de ${hoy.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
      break;
      
    case 'mes_pasado':
      const inicioMesPasado = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
      const finMesPasado = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
      fechaInicio = inicioMesPasado.toISOString().split('T')[0];
      fechaFin = finMesPasado.toISOString().split('T')[0];
      descripcion = `Datos de ${inicioMesPasado.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
      break;
      
    case 'ano':
      fechaInicio = `${hoy.getFullYear()}-01-01`;
      fechaFin = `${hoy.getFullYear()}-12-31`;
      descripcion = `Datos del a√±o ${hoy.getFullYear()}`;
      break;
      
    case 'ano_pasado':
      const anoPasado = hoy.getFullYear() - 1;
      fechaInicio = `${anoPasado}-01-01`;
      fechaFin = `${anoPasado}-12-31`;
      descripcion = `Datos del a√±o ${anoPasado}`;
      break;
      
    // === FILTROS POR SEMANAS ===
    case 'esta_semana':
      const inicioEstaSemana = obtenerInicioSemana(hoy);
      const finEstaSemana = obtenerFinSemana(hoy);
      fechaInicio = inicioEstaSemana.toISOString().split('T')[0];
      fechaFin = finEstaSemana.toISOString().split('T')[0];
      descripcion = `Esta semana (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'semana_pasada':
      const inicioPasado = new Date(hoy);
      inicioPasado.setDate(hoy.getDate() - 7);
      const inicioSemPasada = obtenerInicioSemana(inicioPasado);
      const finSemPasada = obtenerFinSemana(inicioPasado);
      fechaInicio = inicioSemPasada.toISOString().split('T')[0];
      fechaFin = finSemPasada.toISOString().split('T')[0];
      descripcion = `Semana pasada (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'ultimas_2_semanas':
      const hace2Semanas = new Date(hoy);
      hace2Semanas.setDate(hoy.getDate() - 14);
      fechaInicio = hace2Semanas.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = `√öltimas 2 semanas (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'ultimas_4_semanas':
      const hace4Semanas = new Date(hoy);
      hace4Semanas.setDate(hoy.getDate() - 28);
      fechaInicio = hace4Semanas.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = `√öltimas 4 semanas (${fechaInicio} al ${fechaFin})`;
      break;
      
    case 'este_mes_semanas':
      const inicioMesActual = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      fechaInicio = inicioMesActual.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = `Semanas de este mes (${fechaInicio} al ${fechaFin})`;
      break;
      
    // === RANGO PERSONALIZADO ===
    case 'rango_personalizado':
      const fechaInicioInput = document.getElementById('fechaInicio');
      const fechaFinInput = document.getElementById('fechaFin');
      
      if (fechaInicioInput && fechaFinInput) {
        fechaInicio = fechaInicioInput.value;
        fechaFin = fechaFinInput.value;
        
        // Formatear fechas para descripci√≥n
        const inicioFormateado = new Date(fechaInicio).toLocaleDateString('es-ES');
        const finFormateado = new Date(fechaFin).toLocaleDateString('es-ES');
        
        if (fechaInicio === fechaFin) {
          descripcion = `Datos del ${inicioFormateado}`;
        } else {
          descripcion = `Rango personalizado (${inicioFormateado} al ${finFormateado})`;
        }
      } else {
        // Fallback si no encuentra los inputs
        fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
        descripcion = 'Datos de hoy (fallback)';
      }
      break;
      
    // === PER√çODOS LEGACY ===
    case 'dia': // Para compatibilidad
      const fechaDia = hoy.toISOString().split('T')[0];
      fechaInicio = fechaDia;
      fechaFin = fechaDia;
      descripcion = `Datos de hoy (${fechaDia})`;
      break;
      
    case 'personalizado': // Para compatibilidad
      fechaInicio = fechaSeleccionada;
      fechaFin = fechaSeleccionada;
      descripcion = `Datos del ${new Date(fechaSeleccionada).toLocaleDateString('es-ES')}`;
      break;
      
    default:
      fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Datos de hoy (por defecto)';
  }
  
  return { fechaInicio, fechaFin, descripcion };
}

// ===== FUNCIONES AUXILIARES PARA C√ÅLCULO DE SEMANAS =====
function obtenerInicioSemana(fecha) {
  const nuevaFecha = new Date(fecha);
  const diaSemana = nuevaFecha.getDay(); // 0 = domingo, 1 = lunes, ...
  const diasHastaLunes = diaSemana === 0 ? 6 : diaSemana - 1; // Ajustar para que lunes sea inicio
  nuevaFecha.setDate(nuevaFecha.getDate() - diasHastaLunes);
  return nuevaFecha;
}

function obtenerFinSemana(fecha) {
  const inicioSemana = obtenerInicioSemana(fecha);
  const finSemana = new Date(inicioSemana);
  finSemana.setDate(inicioSemana.getDate() + 6); // Domingo es el final
  return finSemana;
}
// ===== FUNCIONES DE NORMALIZACI√ìN =====
function normalizar(texto) {
    if (!texto || typeof texto !== 'string') {
        return texto;
    }
    return texto.trim().toUpperCase();
}

function normalizarVendedor(vendedor) {
    const normalizado = normalizar(vendedor);
    const mapeoVendedores = {
        'BRAYAN': 'BRAYAN',
        'BRYAN': 'BRAYAN',
        'ARIEL': 'ARIEL',
        'BODEGA': 'BODEGA'
    };
    return mapeoVendedores[normalizado] || normalizado;
}

function normalizarProducto(producto) {
    const normalizado = normalizar(producto);
    const mapeoProductos = {
        'BOTELLONES': 'BOTELLONES',
        'BOTELLON': 'BOTELLONES',
        'BOTELL√ìN': 'BOTELLONES',
        'BOLSAS': 'BOLSAS',
        'BOLSA': 'BOLSAS'
    };
    return mapeoProductos[normalizado] || normalizado;
}

function normalizarCiudad(ciudad) {
    return normalizar(ciudad);
}
function normalizarCategoria(categoria) {
    return normalizar(categoria);
}
// ===== PROCESAMIENTO DE DATOS =====
function procesarDatosSupabase(records) {
  console.log('üîÑ Procesando datos de Supabase...');
  
  const datos = {
    totalRegistros: records.length,
    ventasPorVendedor: {},
    ventasPorProducto: {},
    ventasPorCiudad: {},
    gastosPorCategoria: {},
    creditosPorCategoria: {},
    totalVentas: 0,
    totalGastos: 0,
    totalCreditos: 0,
    cajaInicialTotal: 0,
    evolucionDiaria: []
  };
  
  records.forEach(record => {
    // Caja inicial
    datos.cajaInicialTotal += record.caja_inicial || 0;
    
    // Procesar ventas
    if (record.sales) {
      record.sales.forEach(sale => {
   
// Por vendedor
// NORMALIZAR DATOS PRIMERO
const vendedorNorm = normalizarVendedor(sale.vendedor);
const ciudadNorm = normalizarCiudad(sale.ciudad);
const productoNorm = normalizarProducto(sale.producto);

// Por vendedor
if (!datos.ventasPorVendedor[vendedorNorm]) {
          datos.ventasPorVendedor[vendedorNorm] = { cantidad: 0, total: 0, botellones: 0, bolsas: 0 };
        }
        datos.ventasPorVendedor[vendedorNorm].cantidad += sale.cantidad;
        datos.ventasPorVendedor[vendedorNorm].total += sale.total;
        
        if (productoNorm.toLowerCase().includes('botellon')) {
          datos.ventasPorVendedor[vendedorNorm].botellones += sale.cantidad;
        } else {
          datos.ventasPorVendedor[vendedorNorm].bolsas += sale.cantidad;
        }
        
        // Por producto
        if (!datos.ventasPorProducto[productoNorm]) {
          datos.ventasPorProducto[productoNorm] = { cantidad: 0, total: 0 };
        }
        
        // Por ciudad
        if (!datos.ventasPorCiudad[ciudadNorm]) {
          datos.ventasPorCiudad[ciudadNorm] = 0;
        }
        datos.ventasPorCiudad[ciudadNorm] += sale.total;
        
        datos.totalVentas += sale.total;
      });
    }
    
// Procesar gastos
if (record.expenses) {
  record.expenses.forEach(expense => {
    const categoriaNorm = normalizarCategoria(expense.categoria);
    if (!datos.gastosPorCategoria[categoriaNorm]) {
      datos.gastosPorCategoria[categoriaNorm] = 0;
    }
    datos.gastosPorCategoria[categoriaNorm] += expense.monto;
    datos.totalGastos += expense.monto;
  });
}

// Procesar cr√©ditos
if (record.credits) {
  record.credits.forEach(credit => {
    const categoriaCreditoNorm = normalizarCategoria(credit.categoria);
    if (!datos.creditosPorCategoria[categoriaCreditoNorm]) {
      datos.creditosPorCategoria[categoriaCreditoNorm] = 0;
    }
    datos.creditosPorCategoria[categoriaCreditoNorm] += credit.monto;
    datos.totalCreditos += credit.monto;
  });
}  
  // Evoluci√≥n diaria
  const ventasDia = record.sales ? record.sales.reduce((sum, s) => sum + s.total, 0) : 0;
  const gastosDia = record.expenses ? record.expenses.reduce((sum, e) => sum + e.monto, 0) : 0;    datos.evolucionDiaria.push({
      fecha: record.fecha,
      ventas: ventasDia,
      gastos: gastosDia,
      cajaInicial: record.caja_inicial || 0
    });
  });
  
  console.log('‚úÖ Datos procesados:', datos);
  return datos;
}

// ===== ACTUALIZACI√ìN DE KPIs =====
function actualizarKPIs(datos, descripcion) {
  const elementos = {
    totalVentas: document.getElementById('totalVentas'),
    totalGastos: document.getElementById('totalGastos'),
    totalCreditos: document.getElementById('totalCreditos'),
    resultadoFinal: document.getElementById('resultadoFinal')
  };
  
  const resultadoFinal = datos.cajaInicialTotal + datos.totalVentas - datos.totalGastos + datos.totalCreditos;
  
  if (elementos.totalVentas) {
    elementos.totalVentas.textContent = `L. ${datos.totalVentas.toLocaleString()}`;
  }
  if (elementos.totalGastos) {
    elementos.totalGastos.textContent = `L. ${datos.totalGastos.toLocaleString()}`;
  }
  if (elementos.totalCreditos) {
    elementos.totalCreditos.textContent = `L. ${datos.totalCreditos.toLocaleString()}`;
  }
  if (elementos.resultadoFinal) {
    elementos.resultadoFinal.textContent = `L. ${resultadoFinal.toLocaleString()}`;
  }
  
  console.log('üìä KPIs actualizados para:', descripcion);
}

// ===== CREACI√ìN Y ACTUALIZACI√ìN DE GR√ÅFICAS =====
function crearTodasLasGraficas() {
  console.log('üé® Preparando contenedores de gr√°ficas...');
}

function actualizarGraficas(datos) {
  console.log('üìà Actualizando gr√°ficas...');
  
  actualizarGraficaProductos(datos);
  actualizarGraficaVendedores(datos);
  actualizarGraficaGastos(datos);
  actualizarGraficaCiudades(datos);
  actualizarGraficaEvolucion(datos);
}

function actualizarGraficaProductos(datos) {
  const ctx = document.getElementById('ventasProductoChart');
  if (!ctx) return;
  
  if (charts.productos) charts.productos.destroy();
  
  const productos = Object.keys(datos.ventasPorProducto);
  const cantidades = Object.values(datos.ventasPorProducto).map(p => p.cantidad);
  
  charts.productos = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: productos,
      datasets: [{
        data: cantidades,
        backgroundColor: [colores.primary, colores.success, colores.warning, colores.purple],
        borderWidth: 3,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

function actualizarGraficaVendedores(datos) {
  const ctx = document.getElementById('ventasChart');
  if (!ctx) return;
  
  if (charts.vendedores) charts.vendedores.destroy();
  
  const vendedores = Object.keys(datos.ventasPorVendedor);
  const botellones = vendedores.map(v => datos.ventasPorVendedor[v].botellones);
  const bolsas = vendedores.map(v => datos.ventasPorVendedor[v].bolsas);
  
  charts.vendedores = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: vendedores,
      datasets: [
        {
          label: 'Botellones',
          data: botellones,
          backgroundColor: colores.primary
        },
        {
          label: 'Bolsas',
          data: bolsas,
          backgroundColor: colores.success
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function actualizarGraficaGastos(datos) {
  const ctx = document.getElementById('gastosChart');
  if (!ctx) return;
  
  if (charts.gastos) charts.gastos.destroy();
  
  const categorias = Object.keys(datos.gastosPorCategoria);
  const montos = Object.values(datos.gastosPorCategoria);
  
  charts.gastos = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: categorias,
      datasets: [{
        data: montos,
        backgroundColor: [colores.danger, colores.warning, colores.primary, colores.purple, colores.teal]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

function actualizarGraficaCiudades(datos) {
  const ctx = document.getElementById('ciudadesChart');
  if (!ctx) return;
  
  if (charts.ciudades) charts.ciudades.destroy();
  
  const ciudades = Object.keys(datos.ventasPorCiudad);
  const ventas = Object.values(datos.ventasPorCiudad);
  
  charts.ciudades = new Chart(ctx, {
    type: 'polarArea',
    data: {
      labels: ciudades,
      datasets: [{
        data: ventas,
        backgroundColor: [colores.primary, colores.success, colores.warning, colores.purple, colores.teal]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

function actualizarGraficaEvolucion(datos) {
  const ctx = document.getElementById('evolucionChart');
  if (!ctx) return;
  
  if (charts.evolucion) charts.evolucion.destroy();
  
  const fechas = datos.evolucionDiaria.map(d => new Date(d.fecha).toLocaleDateString());
  const ventas = datos.evolucionDiaria.map(d => d.ventas);
  const gastos = datos.evolucionDiaria.map(d => d.gastos);
  
  charts.evolucion = new Chart(ctx, {
    type: 'line',
    data: {
      labels: fechas,
      datasets: [
        {
          label: 'Ventas',
          data: ventas,
          borderColor: colores.success,
          backgroundColor: colores.success + '20',
          tension: 0.4
        },
        {
          label: 'Gastos',
          data: gastos,
          borderColor: colores.danger,
          backgroundColor: colores.danger + '20',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });
}

// ===== TABLA DE PERFORMANCE =====
function crearTablaPerformance(datos) {
  const tbody = document.getElementById('performanceTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  Object.entries(datos.ventasPorVendedor).forEach(([vendedor, info]) => {
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td><strong>${vendedor}</strong></td>
      <td>${info.botellones} unidades</td>
      <td>${info.bolsas} unidades</td>
      <td><strong>L. ${info.total.toLocaleString()}</strong></td>
      <td style="color: ${info.total > 15000 ? '#10b981' : '#f59e0b'};">
        ${info.total > 15000 ? '‚Üó Bueno' : '‚Üí Regular'}
      </td>
    `;
    tbody.appendChild(fila);
  });
}

console.log('‚úÖ Dashboard con Supabase configurado correctamente');

// ===== SISTEMA DE REPORTES ADMINISTRATIVOS AGUA ZAFIRO =====
console.log('üìä Cargando Sistema de Reportes Administrativos...');

// Variables globales para reportes
let modalReportesAbierto = false;
let datosReporte = null;

// ===== FUNCI√ìN PRINCIPAL - ABRIR M√ìDULO DE REPORTES =====
function abrirModuloReportes() {
  if (modalReportesAbierto) return;
  
  console.log('üìä Abriendo m√≥dulo de reportes...');
  modalReportesAbierto = true;
  
  const modal = document.createElement('div');
  modal.id = 'modalReportes';
  modal.innerHTML = `
    <div style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 50000;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(8px);
    ">
      <div style="
        background: white; border-radius: 25px; padding: 35px;
        max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 25px 80px rgba(0,0,0,0.3);
        border: 3px solid #1e40af;
      ">
        <!-- HEADER -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px;">
          <h2 style="color: #1e40af; margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">
            üìä Reportes Administrativos
          </h2>
          <p style="color: #6b7280; margin: 0; font-size: 16px;">
            An√°lisis avanzado para Agua Zafiro
          </p>
        </div>
        
        <!-- FILTROS DE PER√çODO -->
        <div style="background: #f8fafc; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 1px solid #e2e8f0;">
          <h3 style="margin: 0 0 15px 0; color: #374151; font-size: 18px;">üóìÔ∏è Seleccionar Per√≠odo</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            
            <!-- Per√≠odos r√°pidos -->
            <div>
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">‚ö° Per√≠odos R√°pidos:</label>
              <select id="reportePeriodo" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                <option value="hoy">üìÖ Hoy</option>
                <option value="ayer">üìÖ Ayer</option>
                <option value="esta_semana">üìÖ Esta semana</option>
                <option value="semana_pasada">üìÖ Semana pasada</option>
                <option value="mes" selected>üóìÔ∏è Este mes</option>
                <option value="mes_pasado">üóìÔ∏è Mes pasado</option>
                <option value="ano">üìÜ Este a√±o</option>
                <option value="personalizado">üéØ Rango personalizado</option>
              </select>
            </div>
            
            <!-- Rango personalizado -->
            <div id="rangoPersonalizadoReporte" style="display: none;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">üìÖ Rango de fechas:</label>
              <div style="display: flex; gap: 10px;">
                <input type="date" id="reporteFechaInicio" style="flex: 1; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
                <span style="align-self: center; color: #6b7280;">‚Üí</span>
                <input type="date" id="reporteFechaFin" style="flex: 1; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px;">
              </div>
            </div>
            
          </div>
        </div>
        
        <!-- GRID DE REPORTES -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
          
          <!-- Reporte 1: Performance de Vendedores -->
          <div class="reporte-card" onclick="generarReporte('vendedores')" style="
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üë•</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Performance Vendedores</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Ranking, metas vs real, an√°lisis por vendedor
            </p>
          </div>
          
          <!-- Reporte 2: An√°lisis de Productos -->
          <div class="reporte-card" onclick="generarReporte('productos')" style="
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üßä</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">An√°lisis de Productos</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Botellones vs Bolsas, rentabilidad, tendencias
            </p>
          </div>
          
          <!-- Reporte 3: An√°lisis Geogr√°fico -->
          <div class="reporte-card" onclick="generarReporte('ciudades')" style="
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üó∫Ô∏è</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">An√°lisis Geogr√°fico</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Ventas por ciudad, oportunidades de mercado
            </p>
          </div>
          
          <!-- Reporte 4: Estado Financiero -->
          <div class="reporte-card" onclick="generarReporte('financiero')" style="
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üí∞</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Estado Financiero</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Ingresos, gastos, utilidades, flujo de caja
            </p>
          </div>
          
          <!-- Reporte 5: An√°lisis de Gastos -->
          <div class="reporte-card" onclick="generarReporte('gastos')" style="
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üí∏</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">An√°lisis de Gastos</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Categor√≠as, tendencias, control de costos
            </p>
          </div>
          
          <!-- Reporte 6: Cr√©ditos y Cobranza -->
          <div class="reporte-card" onclick="generarReporte('creditos')" style="
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white; padding: 20px; border-radius: 15px; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
          ">
            <div style="font-size: 32px; margin-bottom: 10px;">üí≥</div>
            <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Cr√©ditos y Cobranza</h4>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">
              Cuentas por cobrar, hist√≥rico de cr√©ditos
            </p>
          </div>
          
        </div>
        </div>
        
        <!-- BOTONES DE ACCI√ìN -->
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px; border-top: 2px solid #e5e7eb; padding-top: 20px;">
          
          <button onclick="
            (async function() {
              console.log('üìã Creando reporte ejecutivo completo...');
              try {
                // Mostrar progreso
                const modal = document.createElement('div');
                modal.innerHTML = '<div style=\\'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 70000; display: flex; align-items: center; justify-content: center;\\'><div style=\\'background: white; padding: 30px; border-radius: 15px; text-align: center;\\'><h3>üìä Generando Reporte Completo...</h3><p>Procesando todos los reportes...</p></div></div>';
                document.body.appendChild(modal);
                
                // Obtener datos
                const { fechaInicio, fechaFin, descripcion } = obtenerRangoFechasReporte();
                const datos = await obtenerDatosParaReportes(fechaInicio, fechaFin);
                
                if (!datos || datos.length === 0) {
                  modal.remove();
                  alert('‚ùå No se encontraron datos en el per√≠odo seleccionado');
                  return;
                }
                
                // Generar todos los reportes usando las funciones que funcionan
                const vendedores = generarReporteVendedores(datos, descripcion);
                const productos = generarReporteProductos(datos, descripcion);
                const ciudades = generarReporteCiudades(datos, descripcion);
                const financiero = generarReporteFinanciero(datos, descripcion);
                const gastos = generarReporteGastos(datos, descripcion);
                const creditos = generarReporteCreditos(datos, descripcion);
                
                modal.remove();
                
                // Crear reporte combinado
                const reporteCompleto = {
                  periodo: descripcion,
                  datos: datos.length,
                  vendedores: vendedores.vendedores,
                  productos: productos.productos,
                  ciudades: ciudades.ciudades,
                  financiero: financiero.financiero,
                  gastos: gastos.gastos,
                  creditos: creditos.creditos
                };
                
                // Mostrar reporte
                mostrarReporteEnPantalla(reporteCompleto, 'completo', descripcion);
                
              } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.message);
              }
            })()
          " style="
            background: #059669; color: white; border: none; padding: 12px 25px;
            border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px;
            display: flex; align-items: center; gap: 8px;
          ">
            üìã Reporte Ejecutivo Completo
          </button>
          
          <button onclick="cerrarModalReportes()" style="
            background: #6b7280; color: white; border: none; padding: 12px 25px;
            border-radius: 10px; cursor: pointer; font-weight: 600;
          ">
            ‚ùå Cerrar
          </button>
          
        </div>
        
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Event listeners
  document.getElementById('reportePeriodo').addEventListener('change', function() {
    const rangoDiv = document.getElementById('rangoPersonalizadoReporte');
    if (this.value === 'personalizado') {
      rangoDiv.style.display = 'block';
      // Establecer fechas por defecto
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      document.getElementById('reporteFechaInicio').value = inicioMes.toISOString().split('T')[0];
      document.getElementById('reporteFechaFin').value = hoy.toISOString().split('T')[0];
    } else {
      rangoDiv.style.display = 'none';
    }
  });
  
  // Estilos hover para las cards
  const style = document.createElement('style');
  style.textContent = `
    .reporte-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
  `;
  document.head.appendChild(style);
}
  üìã Reporte Ejecutivo Completo
</button>
 
  <button onclick="cerrarModalReportes()" style="
    background: #6b7280; color: white; border: none; padding: 12px 25px;
    border-radius: 10px; cursor: pointer; font-weight: 600;
  ">
    ‚ùå Cerrar
  </button>
  
</div>

  document.body.appendChild(modal);
  
  // Event listeners
  document.getElementById('reportePeriodo').addEventListener('change', function() {
    const rangoDiv = document.getElementById('rangoPersonalizadoReporte');
    if (this.value === 'personalizado') {
      rangoDiv.style.display = 'block';
      // Establecer fechas por defecto
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      document.getElementById('reporteFechaInicio').value = inicioMes.toISOString().split('T')[0];
      document.getElementById('reporteFechaFin').value = hoy.toISOString().split('T')[0];
    } else {
      rangoDiv.style.display = 'none';
    }
  });
  
  // Estilos hover para las cards
  const style = document.createElement('style');
  style.textContent = `
    .reporte-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
  `;
  document.head.appendChild(style);
}

// ===== CERRAR MODAL DE REPORTES =====
function cerrarModalReportes() {
  const modal = document.getElementById('modalReportes');
  if (modal) {
    modal.remove();
    modalReportesAbierto = false;
  }
}

// ===== OBTENER RANGO DE FECHAS PARA REPORTES =====
function obtenerRangoFechasReporte() {
  const periodo = document.getElementById('reportePeriodo').value;
  const hoy = new Date();
  let fechaInicio, fechaFin, descripcion;
  
  switch (periodo) {
    case 'hoy':
      fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Hoy';
      break;
    case 'ayer':
      const ayer = new Date(hoy);
      ayer.setDate(hoy.getDate() - 1);
      fechaInicio = fechaFin = ayer.toISOString().split('T')[0];
      descripcion = 'Ayer';
      break;
    case 'esta_semana':
      const inicioSemana = obtenerInicioSemana(hoy);
      fechaInicio = inicioSemana.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Esta semana';
      break;
    case 'semana_pasada':
      const semPasada = new Date(hoy);
      semPasada.setDate(hoy.getDate() - 7);
      const inicioSemPasada = obtenerInicioSemana(semPasada);
      const finSemPasada = obtenerFinSemana(semPasada);
      fechaInicio = inicioSemPasada.toISOString().split('T')[0];
      fechaFin = finSemPasada.toISOString().split('T')[0];
      descripcion = 'Semana pasada';
      break;
    case 'mes':
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      fechaInicio = inicioMes.toISOString().split('T')[0];
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Este mes';
      break;
    case 'mes_pasado':
      const inicioMesPasado = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
      const finMesPasado = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
      fechaInicio = inicioMesPasado.toISOString().split('T')[0];
      fechaFin = finMesPasado.toISOString().split('T')[0];
      descripcion = 'Mes pasado';
      break;
    case 'ano':
      fechaInicio = `${hoy.getFullYear()}-01-01`;
      fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Este a√±o';
      break;
    case 'personalizado':
      fechaInicio = document.getElementById('reporteFechaInicio').value;
      fechaFin = document.getElementById('reporteFechaFin').value;
      descripcion = `${fechaInicio} al ${fechaFin}`;
      break;
    default:
      fechaInicio = fechaFin = hoy.toISOString().split('T')[0];
      descripcion = 'Hoy';
  }
  
  return { fechaInicio, fechaFin, descripcion };
}

// ===== OBTENER DATOS PARA REPORTES =====
async function obtenerDatosParaReportes(fechaInicio, fechaFin) {
  console.log(`üìä Obteniendo datos para reporte: ${fechaInicio} - ${fechaFin}`);
  
  try {
    if (!conexionSupabase || !supabaseClient) {
      throw new Error('No hay conexi√≥n a Supabase');
    }
    
    const { data: records, error } = await supabaseClient
      .from('daily_records')
      .select(`
        fecha,
        caja_inicial,
        observaciones,
        sales(vendedor, ciudad, producto, cantidad, precio, total, orden),
        expenses(categoria, descripcion, monto, orden),
        credits(categoria, detalle, monto, orden)
      `)
      .gte('fecha', fechaInicio)
      .lte('fecha', fechaFin)
      .order('fecha', { ascending: true });
    
    if (error) throw error;
    
    console.log(`‚úÖ Datos obtenidos: ${records?.length || 0} registros`);
    return records || [];
    
  } catch (error) {
    console.error('‚ùå Error obteniendo datos para reporte:', error);
    throw error;
  }
}

// ===== GENERAR REPORTE EJECUTIVO COMPLETO =====
async function generarReporteCompleto() {
  console.log('üìã Generando reporte ejecutivo completo...');
  
  try {
    // Mostrar progreso
    const progress = mostrarProgresoReporte();
    actualizarProgresoReporte(progress, 20, 'Obteniendo datos...');
    
    // Obtener rango de fechas
    const { fechaInicio, fechaFin, descripcion } = obtenerRangoFechasReporte();
    
    // Obtener datos
    const datos = await obtenerDatosParaReportes(fechaInicio, fechaFin);
    
    if (!datos || datos.length === 0) {
      cerrarProgresoReporte(progress);
      alert('‚ùå No se encontraron datos en el per√≠odo seleccionado');
      return;
    }
    
    actualizarProgresoReporte(progress, 60, 'Procesando reporte completo...');
    
    // Generar todos los tipos de reportes
    const reporteCompleto = {
      periodo: descripcion,
      datos: datos.length,
      vendedores: generarReporteVendedores(datos, descripcion).vendedores,
      productos: generarReporteProductos(datos, descripcion).productos,
      ciudades: generarReporteCiudades(datos, descripcion).ciudades,
      financiero: generarReporteFinanciero(datos, descripcion).financiero,
      gastos: generarReporteGastos(datos, descripcion).gastos,
      creditos: generarReporteCreditos(datos, descripcion).creditos
    };
    
    actualizarProgresoReporte(progress, 90, 'Generando vista...');
    
    cerrarProgresoReporte(progress);
    
    // Mostrar reporte en pantalla
    mostrarReporteEnPantalla(reporteCompleto, 'completo', descripcion);
    
  } catch (error) {
    console.error('‚ùå Error generando reporte completo:', error);
    alert(`Error generando reporte completo: ${error.message}`);
  }
}
// ===== GENERAR REPORTE ESPEC√çFICO =====
async function generarReporte(tipoReporte) {
  console.log(`üìä Generando reporte: ${tipoReporte}`);
  
  try {
    // Mostrar progreso
    const progress = mostrarProgresoReporte();
    actualizarProgresoReporte(progress, 20, 'Obteniendo datos...');
    
    // Obtener rango de fechas
    const { fechaInicio, fechaFin, descripcion } = obtenerRangoFechasReporte();
    
    // Obtener datos
    const datos = await obtenerDatosParaReportes(fechaInicio, fechaFin);
    
    if (!datos || datos.length === 0) {
      cerrarProgresoReporte(progress);
      alert('‚ùå No se encontraron datos en el per√≠odo seleccionado');
      return;
    }
    
    actualizarProgresoReporte(progress, 60, 'Procesando reporte...');
    
    // Generar reporte espec√≠fico
    let datosReporte;
    switch (tipoReporte) {
      case 'vendedores':
        datosReporte = generarReporteVendedores(datos, descripcion);
        break;
      case 'productos':
        datosReporte = generarReporteProductos(datos, descripcion);
        break;
      case 'ciudades':
        datosReporte = generarReporteCiudades(datos, descripcion);
        break;
      case 'financiero':
        datosReporte = generarReporteFinanciero(datos, descripcion);
        break;
      case 'gastos':
        datosReporte = generarReporteGastos(datos, descripcion);
        break;
      case 'creditos':
        datosReporte = generarReporteCreditos(datos, descripcion);
        break;
      default:
        throw new Error('Tipo de reporte no v√°lido');
    }
    
    actualizarProgresoReporte(progress, 90, 'Generando vista...');
    
    cerrarProgresoReporte(progress);
    
    // Mostrar reporte en pantalla
    mostrarReporteEnPantalla(datosReporte, tipoReporte, descripcion);
    
  } catch (error) {
    console.error('‚ùå Error generando reporte:', error);
    alert(`Error generando reporte: ${error.message}`);
  }
}
// ===== FUNCIONES DE PROGRESO =====
function mostrarProgresoReporte() {
  const modal = document.createElement('div');
  modal.id = 'modalProgreso';
  modal.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 70000; display: flex; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; min-width: 300px;">
        <h3 style="margin: 0 0 20px 0; color: #1f2937;">Generando Reporte</h3>
        <div style="background: #f3f4f6; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
          <div id="barraProgreso" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <p id="textoProgreso" style="margin: 0; color: #6b7280;">Iniciando...</p>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  return modal;
}

function actualizarProgresoReporte(modal, porcentaje, texto) {
  if (modal) {
    const barra = modal.querySelector('#barraProgreso');
    const textoElement = modal.querySelector('#textoProgreso');
    if (barra) barra.style.width = porcentaje + '%';
    if (textoElement) textoElement.textContent = texto;
  }
}

function cerrarProgresoReporte(modal) {
  if (modal) {
    modal.remove();
  }
}
// ===== MOSTRAR REPORTE EN PANTALLA =====
function mostrarReporteEnPantalla(datosReporte, tipoReporte, periodo) {
  // Cerrar modal de reportes
  cerrarModalReportes();
  
  // Crear modal de vista de reporte
  const modal = document.createElement('div');
  modal.id = 'modalVistaReporte';
  modal.innerHTML = `
    <div style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8); z-index: 60000;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(10px);
    ">
      <div style="
        background: white; border-radius: 20px; padding: 30px;
        max-width: 95vw; width: 1200px; max-height: 90vh; overflow: hidden;
        box-shadow: 0 25px 80px rgba(0,0,0,0.4);
        border: 3px solid #1e40af; display: flex; flex-direction: column;
      ">
        
        <!-- HEADER DEL REPORTE -->
        <div style="
          background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
          color: white; padding: 20px; border-radius: 15px; margin: -30px -30px 20px -30px;
          display: flex; justify-content: space-between; align-items: center;
        ">
          <div>
            <h2 style="margin: 0 0 5px 0; font-size: 24px; font-weight: 700;">
              ${obtenerTituloReporte(tipoReporte)}
            </h2>
            <p style="margin: 0; opacity: 0.9; font-size: 16px;">
              Per√≠odo: ${periodo} | ${datosReporte.resumen || 'Datos procesados'}
            </p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="descargarReporteExcel('${tipoReporte}', '${periodo}')" style="
              background: #10b981; color: white; border: none; padding: 10px 20px;
              border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
              display: flex; align-items: center; gap: 5px;
            ">
              üìä Descargar Excel
            </button>
            <button onclick="cerrarVistaReporte()" style="
              background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px;
              border-radius: 8px; cursor: pointer; font-weight: 600;
            ">
              ‚úï
            </button>
          </div>
        </div>
        
        <!-- CONTENIDO DEL REPORTE -->
        <div style="flex: 1; overflow-y: auto; padding: 10px 0;">
          ${generarHTMLReporte(datosReporte, tipoReporte)}
        </div>
        
        <!-- FOOTER CON ACCIONES -->
        <div style="
          border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 20px;
          display: flex; justify-content: space-between; align-items: center;
        ">
          <div style="color: #6b7280; font-size: 14px;">
            Generado: ${new Date().toLocaleString('es-ES')} | Agua Zafiro
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="cerrarVistaReporte()" style="
              background: #ef4444; color: white; border: none; padding: 10px 20px;
              border-radius: 8px; cursor: pointer; font-weight: 600;
            ">
              ‚ùå Cerrar
            </button>
          </div>
        </div>
        
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Guardar datos para descarga
  window.datosReporteActual = datosReporte;
}

// ===== GENERAR HTML PARA CADA TIPO DE REPORTE =====
function generarHTMLReporte(datosReporte, tipoReporte) {
  switch (tipoReporte) {
    case 'vendedores':
      return generarHTMLVendedores(datosReporte);
    case 'productos':
      return generarHTMLProductos(datosReporte);
    case 'ciudades':
      return generarHTMLCiudades(datosReporte);
    case 'financiero':
      return generarHTMLFinanciero(datosReporte);
    case 'gastos':
      return generarHTMLGastos(datosReporte);
    case 'creditos':
      return generarHTMLCreditos(datosReporte);
    case 'completo':
      return generarHTMLCompleto(datosReporte);
    default:
      return '<p>Tipo de reporte no v√°lido</p>';
  }
}

// ===== HTML PARA REPORTE DE VENDEDORES =====
function generarHTMLVendedores(datosReporte) {
  if (!datosReporte.vendedores || datosReporte.vendedores.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de vendedores en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  // Cards resumen
  const totalVentas = datosReporte.vendedores.reduce((sum, v) => sum + v.totalVentas, 0);
  const totalIngresos = datosReporte.vendedores.reduce((sum, v) => sum + v.ingresoTotal, 0);
  const mejorVendedor = datosReporte.vendedores[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalVentas}</div>
      <div style="opacity: 0.9;">Total Ventas</div>
    </div>
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalIngresos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Ingresos Totales</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 18px; font-weight: bold;">${mejorVendedor.vendedor}</div>
      <div style="opacity: 0.9;">Mejor Vendedor</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.vendedores.length}</div>
      <div style="opacity: 0.9;">Vendedores Activos</div>
    </div>
  `;
  
  html += '</div>';
  
  // Tabla detallada
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ranking</th>
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Vendedor</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ventas</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Botellones</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Bolsas</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ingresos</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ciudades</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.vendedores.forEach((vendedor, index) => {
    const colorRanking = index === 0 ? '#fbbf24' : index === 1 ? '#9ca3af' : index === 2 ? '#f97316' : '#6b7280';
    const iconoRanking = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px;">
          <span style="color: ${colorRanking}; font-weight: bold; font-size: 16px;">${iconoRanking}</span>
        </td>
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${vendedor.vendedor}</td>
        <td style="padding: 12px 15px; text-align: center; color: #374151;">${vendedor.totalVentas}</td>
        <td style="padding: 12px 15px; text-align: center; color: #3b82f6; font-weight: 500;">${vendedor.botellones}</td>
        <td style="padding: 12px 15px; text-align: center; color: #10b981; font-weight: 500;">${vendedor.bolsas}</td>
        <td style="padding: 12px 15px; text-align: right; color: #1f2937; font-weight: 600;">L. ${vendedor.ingresoTotal.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${vendedor.participacion > 30 ? '#dcfce7' : vendedor.participacion > 20 ? '#fef3c7' : '#fee2e2'}; 
                       color: ${vendedor.participacion > 30 ? '#166534' : vendedor.participacion > 20 ? '#92400e' : '#991b1b'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${vendedor.participacion.toFixed(1)}%
          </span>
        </td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">${vendedor.ciudadesAtendidas}</td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  return html;
}
// ===== HTML PARA REPORTE COMPLETO =====
function generarHTMLCompleto(datosReporte) {
  console.log('üìã Generando HTML del reporte ejecutivo completo...', datosReporte);
  
  if (!datosReporte) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos para el reporte completo</p>';
  }
  
  let html = `
    <!-- RESUMEN EJECUTIVO -->
    <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px;">
      <h2 style="margin: 0 0 15px 0; font-size: 28px; font-weight: 700;">üìä Resumen Ejecutivo</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">${datosReporte.datos || 0}</div>
          <div style="opacity: 0.9;">D√≠as Analizados</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">${datosReporte.vendedores?.length || 0}</div>
          <div style="opacity: 0.9;">Vendedores Activos</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">${datosReporte.productos?.length || 0}</div>
          <div style="opacity: 0.9;">Tipos de Productos</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
          <div style="font-size: 20px; font-weight: bold;">L. ${datosReporte.financiero?.totalVentas?.toLocaleString() || '0'}</div>
          <div style="opacity: 0.9;">Ventas Totales</div>
        </div>
      </div>
    </div>
    
    <!-- SECCI√ìN DE VENDEDORES -->
    <div style="margin-bottom: 40px;">
      <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px; font-weight: 600; border-bottom: 3px solid #3b82f6; padding-bottom: 10px;">
        üë• Performance de Vendedores
      </h3>
      ${datosReporte.vendedores ? generarTablaVendedoresCompleta(datosReporte.vendedores) : '<p>No hay datos de vendedores</p>'}
    </div>
    
    <!-- SECCI√ìN DE PRODUCTOS -->
    <div style="margin-bottom: 40px;">
      <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px; font-weight: 600; border-bottom: 3px solid #10b981; padding-bottom: 10px;">
        üßä An√°lisis de Productos
      </h3>
      ${datosReporte.productos ? generarTablaProductosCompleta(datosReporte.productos) : '<p>No hay datos de productos</p>'}
    </div>
    
    <!-- SECCI√ìN FINANCIERA -->
    <div style="margin-bottom: 40px;">
      <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 22px; font-weight: 600; border-bottom: 3px solid #8b5cf6; padding-bottom: 10px;">
        üí∞ Resumen Financiero
      </h3>
      ${datosReporte.financiero ? generarResumenFinancieroCompleto(datosReporte.financiero) : '<p>No hay datos financieros</p>'}
    </div>
    
    <!-- RECOMENDACIONES -->
    <div style="background: #f8fafc; padding: 25px; border-radius: 15px; border-left: 5px solid #f59e0b;">
      <h3 style="color: #1f2937; margin: 0 0 15px 0; font-size: 20px; font-weight: 600;">
        üí° Recomendaciones Estrat√©gicas
      </h3>
      ${generarRecomendaciones(datosReporte)}
    </div>
  `;
  
  return html;
}

// ===== FUNCIONES AUXILIARES PARA EL REPORTE COMPLETO =====

function generarTablaVendedoresCompleta(vendedores) {
  if (!vendedores || vendedores.length === 0) {
    return '<p>No hay datos de vendedores disponibles</p>';
  }
  
  const top3 = vendedores.slice(0, 3);
  
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
  
  top3.forEach((vendedor, index) => {
    const color = index === 0 ? '#fbbf24' : index === 1 ? '#9ca3af' : '#f97316';
    const icono = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
    
    html += `
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid ${color};">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
          <span style="font-size: 24px; margin-right: 10px;">${icono}</span>
          <h4 style="margin: 0; color: #1f2937; font-size: 18px;">${vendedor.vendedor}</h4>
        </div>
        <div style="space-y: 8px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Ventas:</span>
            <strong style="color: #1f2937;">${vendedor.totalVentas}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Ingresos:</span>
            <strong style="color: #10b981;">L. ${vendedor.ingresoTotal?.toLocaleString() || '0'}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Participaci√≥n:</span>
            <strong style="color: #3b82f6;">${vendedor.participacion?.toFixed(1) || '0'}%</strong>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function generarTablaProductosCompleta(productos) {
  if (!productos || productos.length === 0) {
    return '<p>No hay datos de productos disponibles</p>';
  }
  
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">';
  
  productos.forEach((producto, index) => {
    const color = index === 0 ? '#10b981' : '#3b82f6';
    
    html += `
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid ${color};">
        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">${producto.producto}</h4>
        <div style="space-y: 8px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Cantidad:</span>
            <strong style="color: #1f2937;">${producto.cantidadVendida || 0}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Ingresos:</span>
            <strong style="color: #10b981;">L. ${producto.ingresoTotal?.toLocaleString() || '0'}</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #6b7280;">Precio Prom:</span>
            <strong style="color: #6b7280;">L. ${producto.precioPromedio?.toFixed(2) || '0'}</strong>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function generarResumenFinancieroCompleto(financiero) {
  if (!financiero) {
    return '<p>No hay datos financieros disponibles</p>';
  }
  
  const utilidadColor = (financiero.utilidadNeta || 0) > 0 ? '#10b981' : '#ef4444';
  
  return `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #10b981;">
        <div style="font-size: 20px; font-weight: bold; color: #10b981;">L. ${(financiero.totalVentas || 0).toLocaleString()}</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Ventas</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #ef4444;">
        <div style="font-size: 20px; font-weight: bold; color: #ef4444;">L. ${(financiero.totalGastos || 0).toLocaleString()}</div>
        <div style="color: #6b7280; margin-top: 5px;">Total Gastos</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid ${utilidadColor};">
        <div style="font-size: 20px; font-weight: bold; color: ${utilidadColor};">L. ${(financiero.utilidadNeta || 0).toLocaleString()}</div>
        <div style="color: #6b7280; margin-top: 5px;">Utilidad Neta</div>
      </div>
      <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #8b5cf6;">
        <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">${(financiero.margenUtilidad || 0).toFixed(1)}%</div>
        <div style="color: #6b7280; margin-top: 5px;">Margen de Utilidad</div>
      </div>
    </div>
  `;
}

function generarRecomendaciones(datosReporte) {
  const recomendaciones = [];
  
  // An√°lisis de vendedores
  if (datosReporte.vendedores && datosReporte.vendedores.length > 0) {
    const mejorVendedor = datosReporte.vendedores[0];
    const vendedorBajo = datosReporte.vendedores[datosReporte.vendedores.length - 1];
    
    if (mejorVendedor && vendedorBajo && mejorVendedor.ingresoTotal > vendedorBajo.ingresoTotal * 2) {
      recomendaciones.push(`Considerar capacitaci√≥n para ${vendedorBajo.vendedor} basada en las t√©cnicas de ${mejorVendedor.vendedor}`);
    }
  }
  
  // An√°lisis financiero
  if (datosReporte.financiero) {
    if ((datosReporte.financiero.margenUtilidad || 0) < 20) {
      recomendaciones.push('El margen de utilidad est√° por debajo del 20%. Revisar estrategia de precios y control de gastos');
    }
    
    if ((datosReporte.financiero.totalGastos || 0) > (datosReporte.financiero.totalVentas || 0) * 0.4) {
      recomendaciones.push('Los gastos representan m√°s del 40% de las ventas. Analizar oportunidades de optimizaci√≥n');
    }
  }
  
  // An√°lisis de productos
  if (datosReporte.productos && datosReporte.productos.length > 0) {
    const totalIngresos = datosReporte.productos.reduce((sum, p) => sum + (p.ingresoTotal || 0), 0);
    const productoTop = datosReporte.productos[0];
    
    if (productoTop && (productoTop.ingresoTotal || 0) / totalIngresos > 0.7) {
      recomendaciones.push('Hay alta dependencia en un solo producto. Considerar diversificar la oferta');
    }
  }
  
  // Si no hay recomendaciones espec√≠ficas
  if (recomendaciones.length === 0) {
    recomendaciones.push('Continuar monitoreando las m√©tricas clave para identificar oportunidades de mejora');
    recomendaciones.push('Mantener el buen desempe√±o y buscar oportunidades de crecimiento');
  }
  
  return recomendaciones.map((rec, index) => 
    `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px; border-left: 3px solid #f59e0b;">
      <strong>${index + 1}.</strong> ${rec}
    </div>`
  ).join('');
}

// ===== FUNCIONES AUXILIARES =====
function obtenerTituloReporte(tipoReporte) {
  const titulos = {
    'vendedores': 'üë• Performance de Vendedores',
    'productos': 'üßä An√°lisis de Productos',
    'ciudades': 'üó∫Ô∏è An√°lisis Geogr√°fico',
    'financiero': 'üí∞ Estado Financiero',
    'gastos': 'üí∏ An√°lisis de Gastos',
    'creditos': 'üí≥ Cr√©ditos y Cobranza',
    'completo': 'üìã Reporte Ejecutivo Completo'
  };
  return titulos[tipoReporte] || 'üìä Reporte';
}

function cerrarVistaReporte() {
  const modal = document.getElementById('modalVistaReporte');
  if (modal) {
    modal.remove();
  }
}

async function descargarReporteExcel(tipoReporte, periodo) {
  if (!window.datosReporteActual) {
    alert('‚ùå No hay datos del reporte para descargar');
    return;
  }
  
  try {
    const nombreArchivo = `AguaZafiro_${tipoReporte.toUpperCase()}_${periodo.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
    await crearArchivoExcelReporte(window.datosReporteActual, nombreArchivo);
    alert(`‚úÖ Archivo Excel descargado: ${nombreArchivo}`);
  } catch (error) {
    console.error('‚ùå Error descargando Excel:', error);
    alert(`Error descargando Excel: ${error.message}`);
  }
}

// ===== REPORTES ESPEC√çFICOS =====

// 1. REPORTE DE VENDEDORES
function generarReporteVendedores(datos, periodo) {
  console.log('üë• Generando reporte de vendedores...');
  
  const vendedores = {};
  let totalVentasGeneral = 0;
  
  // Procesar datos
  datos.forEach(record => {
    if (record.sales) {
      record.sales.forEach(sale => {
        const vendedorNorm = normalizarVendedor(sale.vendedor);
        const ciudadNorm = normalizarCiudad(sale.ciudad);
        const productoNorm = normalizarProducto(sale.producto);

        if (!vendedores[vendedorNorm]) {
          vendedores[vendedorNorm] = {
            ventas: 0,
            cantidad: 0,
            botellones: 0,
            bolsas: 0,
            ingresoTotal: 0,
            ciudades: new Set(),
            diasActivos: new Set()
          };
        }
        
        const v = vendedores[vendedorNorm];
        v.ventas++;
        v.cantidad += sale.cantidad;
        v.ingresoTotal += sale.total;
        v.ciudades.add(ciudadNorm);
        v.diasActivos.add(record.fecha);
        
        if (productoNorm.toLowerCase().includes('botellon')) {
          v.botellones += sale.cantidad;
        } else {
          v.bolsas += sale.cantidad;
        }
        
        totalVentasGeneral += sale.total;
      });
    }
  });
  
  // Convertir a array y calcular m√©tricas
  const vendedoresArray = Object.entries(vendedores).map(([nombre, data]) => ({
    vendedor: nombre,
    totalVentas: data.ventas,
    cantidadUnidades: data.cantidad,
    botellones: data.botellones,
    bolsas: data.bolsas,
    ingresoTotal: data.ingresoTotal,
    promedioPorVenta: data.ingresoTotal / data.ventas,
    participacion: (data.ingresoTotal / totalVentasGeneral * 100),
    ciudadesAtendidas: data.ciudades.size,
    diasActivos: data.diasActivos.size
  }));
  
  // Ordenar por ingresos
  vendedoresArray.sort((a, b) => b.ingresoTotal - a.ingresoTotal);
  
  // Crear estructura Excel
  const headers = [
    'Ranking', 'Vendedor', 'Total Ventas', 'Unidades Vendidas', 
    'Botellones', 'Bolsas', 'Ingresos (L.)', 'Promedio/Venta', 
    'Participaci√≥n %', 'Ciudades', 'D√≠as Activos'
  ];
  
  const filas = [
    [`REPORTE DE PERFORMANCE DE VENDEDORES - ${periodo}`.toUpperCase()],
    [],
    headers
  ];
  
  vendedoresArray.forEach((v, index) => {
    filas.push([
      index + 1,
      v.vendedor,
      v.totalVentas,
      v.cantidadUnidades,
      v.botellones,
      v.bolsas,
      v.ingresoTotal.toFixed(2),
      v.promedioPorVenta.toFixed(2),
      v.participacion.toFixed(1) + '%',
      v.ciudadesAtendidas,
      v.diasActivos
    ]);
  });
  
  // Agregar totales
  filas.push([]);
  filas.push([
    'TOTALES',
    vendedoresArray.length + ' vendedores',
    vendedoresArray.reduce((sum, v) => sum + v.totalVentas, 0),
    vendedoresArray.reduce((sum, v) => sum + v.cantidadUnidades, 0),
    vendedoresArray.reduce((sum, v) => sum + v.botellones, 0),
    vendedoresArray.reduce((sum, v) => sum + v.bolsas, 0),
    totalVentasGeneral.toFixed(2),
    '',
    '100%',
    '',
    ''
  ]);
  
  return { 
    headers, 
    filas, 
    titulo: `Reporte Vendedores - ${periodo}`,
    vendedores: vendedoresArray,
    resumen: `${vendedoresArray.length} vendedores activos, ${datos.length} d√≠as analizados`
  };
}

// 2. REPORTE DE PRODUCTOS
function generarReporteProductos(datos, periodo) {
  console.log('üßä Generando reporte de productos...');
  
  const productos = {};
  
  datos.forEach(record => {
    if (record.sales) {
      record.sales.forEach(sale => {
        const productoNorm = normalizarProducto(sale.producto);
        const vendedorNorm = normalizarVendedor(sale.vendedor);
        
        if (!productos[productoNorm]) {
          productos[productoNorm] = {
            cantidad: 0,
            ingresos: 0,
            ventas: 0,
            precioPromedio: 0,
            vendedores: new Set()
          };
        }
        
        const p = productos[productoNorm];
        p.cantidad += sale.cantidad;
        p.ingresos += sale.total;
        p.ventas++;
        p.precioPromedio = p.ingresos / p.cantidad;
        p.vendedores.add(vendedorNorm);
      });
    }
  });
  
  const productosArray = Object.entries(productos).map(([nombre, data]) => ({
    producto: nombre,
    cantidadVendida: data.cantidad,
    ingresoTotal: data.ingresos,
    numeroVentas: data.ventas,
    precioPromedio: data.precioPromedio,
    vendedoresQueVenden: data.vendedores.size
  }));
  
  productosArray.sort((a, b) => b.ingresoTotal - a.ingresoTotal);
  
  const totalIngresos = productosArray.reduce((sum, p) => sum + p.ingresoTotal, 0);
  
  const headers = [
    'Producto', 'Cantidad Vendida', 'Ingresos (L.)', 'N√∫mero Ventas', 
    'Precio Promedio', 'Participaci√≥n %', 'Vendedores'
  ];
  
  const filas = [
    [`REPORTE DE AN√ÅLISIS DE PRODUCTOS - ${periodo}`.toUpperCase()],
    [],
    headers
  ];
  
  productosArray.forEach(p => {
    filas.push([
      p.producto,
      p.cantidadVendida,
      p.ingresoTotal.toFixed(2),
      p.numeroVentas,
      p.precioPromedio.toFixed(2),
      (p.ingresoTotal / totalIngresos * 100).toFixed(1) + '%',
      p.vendedoresQueVenden
    ]);
  });
  
  return { 
    headers, 
    filas, 
    titulo: `Reporte Productos - ${periodo}`,
    productos: productosArray,
    resumen: `${productosArray.length} tipos de productos`
  };
}

// 3. REPORTE DE CIUDADES
function generarReporteCiudades(datos, periodo) {
  console.log('üó∫Ô∏è Generando reporte de ciudades...');
  
  const ciudades = {};
  
  datos.forEach(record => {
    if (record.sales) {
      record.sales.forEach(sale => {
        const ciudadNorm = normalizarCiudad(sale.ciudad);
        const vendedorNorm = normalizarVendedor(sale.vendedor);
        const productoNorm = normalizarProducto(sale.producto);

        if (!ciudades[ciudadNorm]) {
          ciudades[ciudadNorm] = {
            ventas: 0,
            ingresos: 0,
            vendedores: new Set(),
            productos: new Set()
          };
        }
        
        const c = ciudades[ciudadNorm];
        c.ventas++;
        c.ingresos += sale.total;
        c.vendedores.add(vendedorNorm);
        c.productos.add(productoNorm);
      });
    }
  });
  
  const ciudadesArray = Object.entries(ciudades).map(([nombre, data]) => ({
    ciudad: nombre,
    totalVentas: data.ventas,
    ingresoTotal: data.ingresos,
    vendedoresActivos: data.vendedores.size,
    tiposProductos: data.productos.size
  }));
  
  ciudadesArray.sort((a, b) => b.ingresoTotal - a.ingresoTotal);
  
  const totalIngresos = ciudadesArray.reduce((sum, c) => sum + c.ingresoTotal, 0);
  
  const headers = ['Ciudad', 'Total Ventas', 'Ingresos (L.)', 'Vendedores', 'Productos', 'Participaci√≥n %'];
  
  const filas = [
    [`REPORTE DE AN√ÅLISIS GEOGR√ÅFICO - ${periodo}`.toUpperCase()],
    [],
    headers
  ];
  
  ciudadesArray.forEach(c => {
    filas.push([
      c.ciudad,
      c.totalVentas,
      c.ingresoTotal.toFixed(2),
      c.vendedoresActivos,
      c.tiposProductos,
      (c.ingresoTotal / totalIngresos * 100).toFixed(1) + '%'
    ]);
  });
  
  return { 
    headers, 
    filas, 
    titulo: `Reporte Ciudades - ${periodo}`,
    ciudades: ciudadesArray,
    resumen: `${ciudadesArray.length} ciudades atendidas`
  };
}

// 4. REPORTE FINANCIERO
function generarReporteFinanciero(datos, periodo) {
  console.log('üí∞ Generando reporte financiero...');
  
  let totalVentas = 0;
  let totalGastos = 0;
  let totalCreditos = 0;
  let cajaInicialTotal = 0;
  
  const filasPorDia = [];
  
  datos.forEach(record => {
    const ventasDia = record.sales ? record.sales.reduce((sum, s) => sum + s.total, 0) : 0;
    const gastosDia = record.expenses ? record.expenses.reduce((sum, e) => sum + e.monto, 0) : 0;
    const creditosDia = record.credits ? record.credits.reduce((sum, c) => sum + c.monto, 0) : 0;
    const cajaInicial = record.caja_inicial || 0;
    
    totalVentas += ventasDia;
    totalGastos += gastosDia;
    totalCreditos += creditosDia;
    cajaInicialTotal += cajaInicial;
    
    const utilidadDia = cajaInicial + ventasDia - gastosDia + creditosDia;
    
    filasPorDia.push({
      fecha: record.fecha,
      cajaInicial: cajaInicial,
      ventas: ventasDia,
      gastos: gastosDia,
      creditos: creditosDia,
      utilidad: utilidadDia
    });
  });
  
  const utilidadNeta = cajaInicialTotal + totalVentas - totalGastos + totalCreditos;
  
  const headers = ['Fecha', 'Caja Inicial', 'Ventas', 'Gastos', 'Cr√©ditos', 'Utilidad Neta'];
  
  const filas = [
    [`REPORTE FINANCIERO EJECUTIVO - ${periodo}`.toUpperCase()],
    [],
    headers
  ];
  
  filasPorDia.forEach(dia => {
    filas.push([
      dia.fecha,
      dia.cajaInicial.toFixed(2),
      dia.ventas.toFixed(2),
      dia.gastos.toFixed(2),
      dia.creditos.toFixed(2),
      dia.utilidad.toFixed(2)
    ]);
  });
  
  filas.push([]);
  filas.push([
    'TOTALES',
    cajaInicialTotal.toFixed(2),
    totalVentas.toFixed(2),
    totalGastos.toFixed(2),
    totalCreditos.toFixed(2),
    utilidadNeta.toFixed(2)
  ]);
  
  return { 
    headers, 
    filas, 
    titulo: `Reporte Financiero - ${periodo}`,
    financiero: {
      totalVentas,
      totalGastos,
      totalCreditos,
      utilidadNeta,
      margenUtilidad: (utilidadNeta / totalVentas * 100),
      promedioDiarioVentas: totalVentas / datos.length
    },
    filasPorDia,
    resumen: `${datos.length} d√≠as analizados`
  };
}

// 5. REPORTE DE GASTOS
function generarReporteGastos(datos, periodo) {
  console.log('üí∏ Generando reporte de gastos...');
  
  const gastos = {};
  
  datos.forEach(record => {
    if (record.expenses) {
      record.expenses.forEach(expense => {
        const categoriaNorm = normalizarCategoria(expense.categoria);
        if (!gastos[categoriaNorm]) {
          gastos[categoriaNorm] = {
            total: 0,
            cantidad: 0,
            descripciones: new Set()
          };
        }
        
        const g = gastos[categoriaNorm];
        g.total += expense.monto;
        g.cantidad++;
        if (expense.descripcion) {
          g.descripciones.add(expense.descripcion);
        }
      });
    }
  });
  
  const gastosArray = Object.entries(gastos).map(([categoria, data]) => ({
    categoria,
    total: data.total,
    cantidad: data.cantidad,
    promedio: data.total / data.cantidad,
    descripciones: data.descripciones.size
  }));
  
  gastosArray.sort((a, b) => b.total - a.total);
  
  const totalGastos = gastosArray.reduce((sum, g) => sum + g.total, 0);
  
  const headers = ['Categor√≠a', 'Total (L.)', 'Cantidad', 'Promedio', 'Participaci√≥n %', 'Descripciones'];
  
  const filas = [
    [`REPORTE DE AN√ÅLISIS DE GASTOS - ${periodo}`.toUpperCase()],
    [],
    headers
  ];
  
  gastosArray.forEach(g => {
    filas.push([
      g.categoria,
      g.total.toFixed(2),
      g.cantidad,
      g.promedio.toFixed(2),
      (g.total / totalGastos * 100).toFixed(1) + '%',
      g.descripciones
    ]);
  });
  
  return { 
    headers, 
    filas, 
    titulo: `Reporte Gastos - ${periodo}`,
    gastos: gastosArray,
    resumen: `${gastosArray.length} categor√≠as de gastos`
  };
}

// 6. REPORTE DE CR√âDITOS
function generarReporteCreditos(datos, periodo) {
  console.log('üí≥ Generando reporte de cr√©ditos...');
  
  const creditos = {};
  
  datos.forEach(record => {
    if (record.credits) {
      record.credits.forEach(credit => {
        if (!creditos[credit.categoria]) {
          creditos[credit.categoria] = {
            total: 0,
            cantidad: 0,
            detalles: new Set()
          };
        }
        
        const c = creditos[credit.categoria];
        c.total += credit.monto;
        c.cantidad++;
        if (credit.detalle) {
          c.detalles.add(credit.detalle);
        }
      });
    }
  });
  
  const creditosArray = Object.entries(creditos).map(([categoria, data]) => ({
    categoria,
    total: data.total,
    cantidad: data.cantidad,
    promedio: data.total / data.cantidad,
    detalles: data.detalles.size
  }));
  
  creditosArray.sort((a, b) => b.total - a.total);
  
  const totalCreditos = creditosArray.reduce((sum, c) => sum + c.total, 0);
  
  const headers = ['Categor√≠a', 'Total (L.)', 'Cantidad', 'Promedio', 'Participaci√≥n %', 'Detalles'];
  
  const filas = [
    [`REPORTE DE CR√âDITOS Y COBRANZA - ${periodo}`.toUpperCase()],
    [],
    headers
  ];
  
  creditosArray.forEach(c => {
    filas.push([
      c.categoria,
      c.total.toFixed(2),
      c.cantidad,
      c.promedio.toFixed(2),
      (c.total / totalCreditos * 100).toFixed(1) + '%',
      c.detalles
    ]);
  });
  
  return { 
    headers, 
    filas, 
    titulo: `Reporte Cr√©ditos - ${periodo}`,
    creditos: creditosArray,
    resumen: `${creditosArray.length} categor√≠as de cr√©ditos`
  };
}
// ===== VISTAS HTML ADICIONALES =====

// HTML para reporte de productos
function generarHTMLProductos(datosReporte) {
  if (!datosReporte.productos || datosReporte.productos.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de productos en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalUnidades = datosReporte.productos.reduce((sum, p) => sum + p.cantidadVendida, 0);
  const totalIngresos = datosReporte.productos.reduce((sum, p) => sum + p.ingresoTotal, 0);
  const productoTop = datosReporte.productos[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalUnidades}</div>
      <div style="opacity: 0.9;">Unidades Vendidas</div>
    </div>
    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalIngresos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Ingresos Totales</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 16px; font-weight: bold;">${productoTop.producto}</div>
      <div style="opacity: 0.9;">Producto Top</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.productos.length}</div>
      <div style="opacity: 0.9;">Tipos de Productos</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Producto</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Cantidad</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ingresos</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Precio Prom.</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.productos.forEach((producto, index) => {
    const participacion = (producto.ingresoTotal / totalIngresos * 100);
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${producto.producto}</td>
        <td style="padding: 12px 15px; text-align: center; color: #3b82f6; font-weight: 500;">${producto.cantidadVendida}</td>
        <td style="padding: 12px 15px; text-align: right; color: #1f2937; font-weight: 600;">L. ${producto.ingresoTotal.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">L. ${producto.precioPromedio.toFixed(2)}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 50 ? '#dcfce7' : '#fef3c7'}; 
                       color: ${participacion > 50 ? '#166534' : '#92400e'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

// HTML para reporte financiero
function generarHTMLFinanciero(datosReporte) {
  console.log('üí∞ Generando HTML financiero con datos:', datosReporte);
  console.log('üí∞ Tiene filasPorDia:', !!datosReporte.filasPorDia);
  console.log('üí∞ Longitud filasPorDia:', datosReporte.filasPorDia?.length);
  console.log('üí∞ Tiene financiero:', !!datosReporte.financiero);
  
  // Verificar si hay datos en filasPorDia O en la estructura de datos
  const tieneFilasPorDia = datosReporte.filasPorDia && datosReporte.filasPorDia.length > 0;
  const tieneFinanciero = datosReporte.financiero;
  
  // CAMBIO: Ser m√°s permisivo con la verificaci√≥n
  if (!tieneFilasPorDia && !tieneFinanciero && (!datosReporte.titulo || datosReporte.titulo.indexOf('Financiero') === -1)) {
    console.log('üí∞ No hay datos financieros suficientes');
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos financieros en este per√≠odo</p>';
  }
  
  // FORZAR: Si llegamos aqu√≠ pero no hay filasPorDia, usar datos directamente del t√≠tulo y filas
  let filasParaProcesar = datosReporte.filasPorDia;
  
  // Si no hay filasPorDia pero tenemos datos en 'filas', procesarlos
  if (!filasParaProcesar && datosReporte.filas && datosReporte.filas.length > 3) {
    console.log('üí∞ Convirtiendo filas a filasPorDia...');
    filasParaProcesar = [];
    
    // Saltar headers y procesar filas de datos
    for (let i = 3; i < datosReporte.filas.length; i++) {
      const fila = datosReporte.filas[i];
      if (fila && fila.length >= 6 && fila[0] !== 'TOTALES') {
        filasParaProcesar.push({
          fecha: fila[0],
          cajaInicial: parseFloat(fila[1]) || 0,
          ventas: parseFloat(fila[2]) || 0,
          gastos: parseFloat(fila[3]) || 0,
          creditos: parseFloat(fila[4]) || 0,
          utilidad: parseFloat(fila[5]) || 0
        });
      }
    }
    console.log('üí∞ FilasPorDia convertidas:', filasParaProcesar.length);
  }
  
  // Obtener o calcular totales
  let totalVentas = 0;
  let totalGastos = 0; 
  let totalCreditos = 0;
  let totalSaldoInicial = 0;
  let resultadoFinal = 0;
  
  if (filasParaProcesar && filasParaProcesar.length > 0) {
    totalVentas = filasParaProcesar.reduce((sum, d) => sum + (d.ventas || 0), 0);
    totalGastos = filasParaProcesar.reduce((sum, d) => sum + (d.gastos || 0), 0);
    totalCreditos = filasParaProcesar.reduce((sum, d) => sum + (d.creditos || 0), 0);
    totalSaldoInicial = filasParaProcesar.reduce((sum, d) => sum + (d.cajaInicial || 0), 0);
    resultadoFinal = totalSaldoInicial + totalVentas - totalGastos + totalCreditos;
  } else if (tieneFinanciero) {
    totalVentas = datosReporte.financiero.totalVentas || 0;
    totalGastos = datosReporte.financiero.totalGastos || 0;
    totalCreditos = datosReporte.financiero.totalCreditos || 0;
    totalSaldoInicial = datosReporte.financiero.cajaInicialTotal || 0;
    resultadoFinal = datosReporte.financiero.utilidadNeta || 0;
  }
  
  console.log('üí∞ Totales calculados:', {
    totalSaldoInicial, totalVentas, totalGastos, totalCreditos, resultadoFinal
  });
  
  const margenUtilidad = totalVentas > 0 ? (resultadoFinal / totalVentas * 100) : 0;
  const promedioDiario = filasParaProcesar && filasParaProcesar.length > 0 ? (totalVentas / filasParaProcesar.length) : 0;
  
  let html = `
    <!-- CARDS DE RESUMEN -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalSaldoInicial.toLocaleString()}</div>
        <div style="opacity: 0.9;">Saldo Inicial Total</div>
      </div>
      <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalVentas.toLocaleString()}</div>
        <div style="opacity: 0.9;">Total Ventas</div>
      </div>
      <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalGastos.toLocaleString()}</div>
        <div style="opacity: 0.9;">Total Gastos</div>
      </div>
      <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${totalCreditos.toLocaleString()}</div>
        <div style="opacity: 0.9;">Total Cr√©ditos</div>
      </div>
      <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
        <div style="font-size: 22px; font-weight: bold;">L. ${resultadoFinal.toLocaleString()}</div>
        <div style="opacity: 0.9;">Resultado Final</div>
      </div>
    </div>
    
    <!-- F√ìRMULA EXPLICATIVA -->
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
      <h4 style="margin: 0 0 10px 0; color: #1f2937; font-size: 16px;">üìä F√≥rmula de C√°lculo:</h4>
      <div style="font-family: monospace; font-size: 14px; color: #374151; background: white; padding: 15px; border-radius: 8px;">
        <strong>Resultado Final = Saldo Inicial + Ventas - Gastos + Cr√©ditos</strong><br>
        L. ${resultadoFinal.toLocaleString()} = L. ${totalSaldoInicial.toLocaleString()} + L. ${totalVentas.toLocaleString()} - L. ${totalGastos.toLocaleString()} + L. ${totalCreditos.toLocaleString()}
      </div>
    </div>
    
    <!-- INDICADORES ADICIONALES -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
        <div style="font-size: 20px; font-weight: bold; color: #1f2937;">${margenUtilidad.toFixed(1)}%</div>
        <div style="color: #6b7280;">Margen sobre Ventas</div>
      </div>
      <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
        <div style="font-size: 20px; font-weight: bold; color: #1f2937;">L. ${promedioDiario.toLocaleString()}</div>
        <div style="color: #6b7280;">Promedio Diario Ventas</div>
      </div>
    </div>
  `;
  
  // TABLA DETALLADA POR D√çA
  if (filasParaProcesar && filasParaProcesar.length > 0) {
    html += `
      <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="background: #3b82f6; color: white; padding: 15px;">
          <h4 style="margin: 0; font-size: 16px; font-weight: 600;">üìà Detalle Diario del Per√≠odo</h4>
        </div>
        
        <div style="max-height: 400px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead style="position: sticky; top: 0; background: #f8fafc;">
              <tr>
                <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üìÖ Fecha</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üí∞ Saldo Inicial</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üìà Ventas</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üí∏ Gastos</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üí≥ Cr√©ditos</th>
                <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">üéØ Resultado</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    filasParaProcesar.forEach((dia, index) => {
      const saldoInicial = dia.cajaInicial || 0;
      const ventasDia = dia.ventas || 0;
      const gastosDia = dia.gastos || 0;
      const creditosDia = dia.creditos || 0;
      const resultadoDia = saldoInicial + ventasDia - gastosDia + creditosDia;
      
      const resultadoColor = resultadoDia > 0 ? '#10b981' : '#ef4444';
      const resultadoIcon = resultadoDia > 0 ? '‚úÖ' : '‚ùå';
      
      html += `
        <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
          <td style="padding: 10px 15px; font-weight: 500; color: #1f2937;">
            ${new Date(dia.fecha).toLocaleDateString('es-ES', { 
              weekday: 'short', 
              day: '2-digit', 
              month: 'short' 
            })}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #f59e0b; font-weight: 500;">
            L. ${saldoInicial.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #10b981; font-weight: 500;">
            L. ${ventasDia.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #ef4444; font-weight: 500;">
            L. ${gastosDia.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: #06b6d4; font-weight: 500;">
            L. ${creditosDia.toLocaleString()}
          </td>
          <td style="padding: 10px 15px; text-align: right; color: ${resultadoColor}; font-weight: 600;">
            ${resultadoIcon} L. ${resultadoDia.toLocaleString()}
          </td>
        </tr>
      `;
    });
    
    // Fila de totales
    html += `
        <tr style="background: #f1f5f9; border-top: 2px solid #3b82f6; font-weight: 600;">
          <td style="padding: 15px; color: #1f2937; font-weight: bold;">
            üî¢ TOTALES
          </td>
          <td style="padding: 15px; text-align: right; color: #f59e0b; font-weight: bold;">
            L. ${totalSaldoInicial.toLocaleString()}
          </td>
          <td style="padding: 15px; text-align: right; color: #10b981; font-weight: bold;">
            L. ${totalVentas.toLocaleString()}
          </td>
          <td style="padding: 15px; text-align: right; color: #ef4444; font-weight: bold;">
            L. ${totalGastos.toLocaleString()}
          </td>
          <td style="padding: 15px; text-align: right; color: #06b6d4; font-weight: bold;">
            L. ${totalCreditos.toLocaleString()}
          </td>
          <td style="padding: 15px; text-align: right; color: ${resultadoFinal > 0 ? '#10b981' : '#ef4444'}; font-weight: bold; font-size: 16px;">
            ${resultadoFinal > 0 ? 'üéâ' : '‚ö†Ô∏è'} L. ${resultadoFinal.toLocaleString()}
          </td>
        </tr>
            </tbody>
          </table>
        </div>
      </div>
    `;
  } else {
    html += `
      <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 20px; border-radius: 12px; text-align: center;">
        <h4 style="color: #92400e; margin: 0 0 10px 0;">‚ö†Ô∏è Sin detalle diario</h4>
        <p style="color: #92400e; margin: 0;">Los totales se muestran pero no hay detalle d√≠a por d√≠a disponible.</p>
      </div>
    `;
  }
  
  return html;
}

// HTML para otros reportes (completados)
function generarHTMLCiudades(datosReporte) {
  console.log('üó∫Ô∏è Generando HTML de ciudades con datos:', datosReporte);
  
  if (!datosReporte.ciudades || datosReporte.ciudades.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de ciudades en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalVentas = datosReporte.ciudades.reduce((sum, c) => sum + c.totalVentas, 0);
  const totalIngresos = datosReporte.ciudades.reduce((sum, c) => sum + c.ingresoTotal, 0);
  const ciudadTop = datosReporte.ciudades[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalVentas}</div>
      <div style="opacity: 0.9;">Total Ventas</div>
    </div>
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalIngresos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Ingresos Totales</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 18px; font-weight: bold;">${ciudadTop.ciudad}</div>
      <div style="opacity: 0.9;">Ciudad L√≠der</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.ciudades.length}</div>
      <div style="opacity: 0.9;">Ciudades Atendidas</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ranking</th>
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ciudad</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ventas</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Ingresos</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Vendedores</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.ciudades.forEach((ciudad, index) => {
    const colorRanking = index === 0 ? '#fbbf24' : index === 1 ? '#9ca3af' : index === 2 ? '#f97316' : '#6b7280';
    const iconoRanking = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
    const participacion = (ciudad.ingresoTotal / totalIngresos * 100);
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px;">
          <span style="color: ${colorRanking}; font-weight: bold; font-size: 16px;">${iconoRanking}</span>
        </td>
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${ciudad.ciudad}</td>
        <td style="padding: 12px 15px; text-align: center; color: #3b82f6; font-weight: 500;">${ciudad.totalVentas}</td>
        <td style="padding: 12px 15px; text-align: right; color: #1f2937; font-weight: 600;">L. ${ciudad.ingresoTotal.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">${ciudad.vendedoresActivos}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 30 ? '#dcfce7' : participacion > 15 ? '#fef3c7' : '#fee2e2'}; 
                       color: ${participacion > 30 ? '#166534' : participacion > 15 ? '#92400e' : '#991b1b'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

function generarHTMLGastos(datosReporte) {
  console.log('üí∏ Generando HTML de gastos con datos:', datosReporte);
  
  if (!datosReporte.gastos || datosReporte.gastos.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de gastos en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalGastos = datosReporte.gastos.reduce((sum, g) => sum + g.total, 0);
  const totalCantidad = datosReporte.gastos.reduce((sum, g) => sum + g.cantidad, 0);
  const gastoTop = datosReporte.gastos[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalGastos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Total Gastos</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalCantidad}</div>
      <div style="opacity: 0.9;">Total Registros</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 16px; font-weight: bold;">${gastoTop.categoria}</div>
      <div style="opacity: 0.9;">Categor√≠a Mayor</div>
    </div>
    <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.gastos.length}</div>
      <div style="opacity: 0.9;">Categor√≠as</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Categor√≠a</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Total</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Cantidad</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Promedio</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.gastos.forEach((gasto, index) => {
    const participacion = (gasto.total / totalGastos * 100);
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${gasto.categoria}</td>
        <td style="padding: 12px 15px; text-align: right; color: #ef4444; font-weight: 600;">L. ${gasto.total.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">${gasto.cantidad}</td>
        <td style="padding: 12px 15px; text-align: right; color: #6b7280;">L. ${gasto.promedio.toFixed(2)}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 40 ? '#fef2f2' : participacion > 20 ? '#fef3c7' : '#f0fdf4'}; 
                       color: ${participacion > 40 ? '#991b1b' : participacion > 20 ? '#92400e' : '#166534'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

function generarHTMLCreditos(datosReporte) {
  console.log('üí≥ Generando HTML de cr√©ditos con datos:', datosReporte);
  
  if (!datosReporte.creditos || datosReporte.creditos.length === 0) {
    return '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos de cr√©ditos en este per√≠odo</p>';
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  `;
  
  const totalCreditos = datosReporte.creditos.reduce((sum, c) => sum + c.total, 0);
  const totalCantidad = datosReporte.creditos.reduce((sum, c) => sum + c.cantidad, 0);
  const creditoTop = datosReporte.creditos[0];
  
  html += `
    <div style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">L. ${totalCreditos.toLocaleString()}</div>
      <div style="opacity: 0.9;">Total Cr√©ditos</div>
    </div>
    <div style="background: linear-gradient(135deg, #10b981, #047857); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${totalCantidad}</div>
      <div style="opacity: 0.9;">Total Registros</div>
    </div>
    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 16px; font-weight: bold;">${creditoTop.categoria}</div>
      <div style="opacity: 0.9;">Categor√≠a Mayor</div>
    </div>
    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
      <div style="font-size: 24px; font-weight: bold;">${datosReporte.creditos.length}</div>
      <div style="opacity: 0.9;">Categor√≠as</div>
    </div>
  `;
  
  html += '</div>';
  
  html += `
    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8fafc;">
            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Categor√≠a</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Total</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Cantidad</th>
            <th style="padding: 15px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Promedio</th>
            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Participaci√≥n</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  datosReporte.creditos.forEach((credito, index) => {
    const participacion = (credito.total / totalCreditos * 100);
    
    html += `
      <tr style="border-bottom: 1px solid #f3f4f6; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
        <td style="padding: 12px 15px; font-weight: 600; color: #1f2937;">${credito.categoria}</td>
        <td style="padding: 12px 15px; text-align: right; color: #06b6d4; font-weight: 600;">L. ${credito.total.toLocaleString()}</td>
        <td style="padding: 12px 15px; text-align: center; color: #6b7280;">${credito.cantidad}</td>
        <td style="padding: 12px 15px; text-align: right; color: #6b7280;">L. ${credito.promedio.toFixed(2)}</td>
        <td style="padding: 12px 15px; text-align: center;">
          <span style="background: ${participacion > 50 ? '#ecfdf5' : participacion > 25 ? '#fef3c7' : '#f0f9ff'}; 
                       color: ${participacion > 50 ? '#166534' : participacion > 25 ? '#92400e' : '#0369a1'}; 
                       padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${participacion.toFixed(1)}%
          </span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  return html;
}

console.log('‚úÖ Sistema de Reportes Administrativos cargado correctamente');
console.log('üìä Reportes disponibles: Vendedores, Productos, Ciudades, Financiero, Gastos, Cr√©ditos');
  </script>

  <!-- Scripts de autenticaci√≥n (opcionales) -->
  <script>
    // Si tienes archivos auth.js y roles.js, descomenta estas l√≠neas
    // <script src="auth.js"></script>
    // <script src="roles.js"></script>
  </script>
</body>
</html>