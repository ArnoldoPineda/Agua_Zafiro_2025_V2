<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Producción - Agua Zafiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* ===== NAVBAR ===== */
        .navbar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 0 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 1.4em;
            font-weight: bold;
            text-decoration: none;
        }

        .navbar-brand i {
            color: #667eea;
            font-size: 1.6em;
        }

        .navbar-center {
            display: flex;
            gap: 10px;
            flex: 1;
            justify-content: center;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(102, 126, 234, 0.8);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .user-name {
            font-weight: bold;
            color: white;
        }

        .user-role {
            color: #667eea;
            font-size: 0.8em;
            text-transform: uppercase;
        }

        .btn-logout {
            padding: 10px 18px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-logout:active {
            transform: translateY(0);
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .header i {
            color: #667eea;
        }

        /* ===== FILTROS ===== */
        .filtros-container {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .filtro-grupo {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filtro-grupo label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filtro-grupo label i {
            color: #667eea;
            font-size: 1.1em;
        }

        .filtro-grupo select,
        .filtro-grupo input[type="date"] {
            padding: 10px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            color: #2c3e50;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, sans-serif;
        }

        .filtro-grupo select:hover,
        .filtro-grupo input[type="date"]:hover {
            border-color: #667eea;
        }

        .filtro-grupo select:focus,
        .filtro-grupo input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .rango-grupo {
            grid-column: span 1;
        }

        .rango-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rango-inputs input[type="date"] {
            flex: 1;
            min-width: 120px;
        }

        .rango-inputs span {
            color: #7f8c8d;
            font-size: 0.9em;
            font-weight: 500;
        }

        .botones-filtro {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-aplicar, .btn-datos, .btn-actualizar {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .btn-aplicar {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            flex: 1;
            justify-content: center;
        }

        .btn-aplicar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        .btn-datos {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            flex: 1;
            justify-content: center;
        }

        .btn-datos:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-actualizar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
        }

        .btn-actualizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-actualizar:active {
            animation: spin 1s linear;
        }

        /* Estado de Filtros */
        .estado-filtros {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(39, 174, 96, 0.1) 100%);
            border-left: 4px solid #27ae60;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #27ae60;
            font-size: 0.95em;
            font-weight: 500;
        }

        .estado-filtros i {
            font-size: 1.2em;
        }

        /* ===== TARJETAS DE ESTADÍSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.2);
        }

        .stat-card.bolsas { border-left-color: #3498db; }
        .stat-card.bolsas .stat-icon { color: #3498db; }

        .stat-card.packs { border-left-color: #2ecc71; }
        .stat-card.packs .stat-icon { color: #2ecc71; }

        .stat-card.botellones { border-left-color: #e74c3c; }
        .stat-card.botellones .stat-icon { color: #e74c3c; }

        .stat-card.calidad { border-left-color: #f39c12; }
        .stat-card.calidad .stat-icon { color: #f39c12; }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #2c3e50;
            position: relative;
            z-index: 1;
        }

        .stat-change {
            color: #27ae60;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        /* ===== GRID DE GRÁFICAS ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 50px rgba(0, 0, 0, 0.15);
        }

        .chart-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .chart-title i {
            font-size: 1.3em;
            color: #667eea;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-wrapper canvas {
            max-width: 100%;
        }

        /* ===== PALETA DE COLORES PROFESIONAL ===== */
        .color-primary { color: #667eea; }
        .color-success { color: #2ecc71; }
        .color-danger { color: #e74c3c; }
        .color-warning { color: #f39c12; }
        .color-info { color: #3498db; }

        /* ===== GRÁFICA DE EFICIENCIA (GRANDE) ===== */
        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        /* ===== ANIMACIONES ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            animation: fadeInUp 0.5s ease forwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }

        .chart-container {
            animation: fadeInUp 0.6s ease forwards;
        }

        .chart-container:nth-child(1) { animation-delay: 0.6s; }
        .chart-container:nth-child(2) { animation-delay: 0.7s; }
        .chart-container:nth-child(3) { animation-delay: 0.8s; }
        .chart-container:nth-child(4) { animation-delay: 0.9s; }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 40px;
            padding: 20px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .navbar {
                flex-wrap: wrap;
                height: auto;
                padding: 10px;
            }

            .navbar-brand {
                font-size: 1.1em;
                flex: 1;
            }

            .navbar-center {
                flex: 1;
                width: 100%;
                gap: 5px;
                margin: 10px 0;
                justify-content: space-around;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 0.8em;
                flex: 1;
                justify-content: center;
            }

            .navbar-right {
                flex: 1;
                width: 100%;
                gap: 8px;
                justify-content: space-between;
            }

            .user-info {
                display: none;
            }

            .btn-logout {
                width: 100%;
                justify-content: center;
            }

            .main-content {
                padding: 15px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .stat-value {
                font-size: 1.6em;
            }

            .filtros-container {
                grid-template-columns: 1fr;
            }

            .rango-inputs {
                flex-direction: column;
            }

            .rango-inputs input[type="date"] {
                width: 100%;
            }

            .botones-filtro {
                flex-direction: column;
            }

            .btn-aplicar, .btn-datos {
                width: 100%;
            }

            .header > div {
                flex-direction: column;
                gap: 15px;
            }

            .btn-actualizar {
                width: 100%;
                justify-content: center;
            }
        }

        /* ===== LOADING SPINNER ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #667eea;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="#" class="navbar-brand">
            <i class="fas fa-chart-line"></i>
            Agua Zafiro
        </a>

        <div class="navbar-center">
            <button class="nav-btn" onclick="irACapturador()">
                <i class="fas fa-keyboard"></i>
                Capturador de Producción
            </button>
            <button class="nav-btn active" onclick="irADashboard()">
                <i class="fas fa-chart-bar"></i>
                Dashboard
            </button>
        </div>

        <div class="navbar-right">
            <div class="user-info">
                <span class="user-name" id="nombreUsuario">Usuario</span>
                <span class="user-role" id="rolUsuario">Admin</span>
            </div>
            <button class="btn-logout" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i>
                Salir
            </button>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1>
                        <i class="fas fa-chart-line"></i>
                        Dashboard Agua Zafiro
                    </h1>
                    <p><i class="fas fa-water"></i> Control de Producción Diaria</p>
                </div>
                <button class="btn-actualizar" onclick="cargarDatos()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>

            <!-- FILTROS -->
            <div class="filtros-container">
                <!-- Períodos Rápidos -->
                <div class="filtro-grupo">
                    <label><i class="fas fa-bolt"></i> Períodos Rápidos:</label>
                    <select id="periodoRapido" onchange="aplicarFiltroRapido()">
                        <option value="hoy">Hoy</option>
                        <option value="esta_semana">Esta semana</option>
                        <option value="este_mes" selected>Este mes</option>
                        <option value="ultimo_mes">Último mes</option>
                        <option value="este_año">Este año</option>
                    </select>
                </div>

                <!-- Por Semanas -->
                <div class="filtro-grupo">
                    <label><i class="fas fa-calendar-week"></i> Por Semanas:</label>
                    <select id="porSemana">
                        <option value="">Seleccionar semana...</option>
                        <option value="1">Semana 1</option>
                        <option value="2">Semana 2</option>
                        <option value="3">Semana 3</option>
                        <option value="4">Semana 4</option>
                    </select>
                </div>

                <!-- Rango Personalizado -->
                <div class="filtro-grupo rango-grupo">
                    <label><i class="fas fa-calendar"></i> Rango Personalizado:</label>
                    <div class="rango-inputs">
                        <input type="date" id="fechaDesde" placeholder="Desde">
                        <span>hasta</span>
                        <input type="date" id="fechaHasta" placeholder="Hasta">
                    </div>
                </div>

                <!-- Botones -->
                <div class="filtro-grupo botones-filtro">
                    <button class="btn-aplicar" onclick="aplicarFiltros()">
                        <i class="fas fa-check"></i> Aplicar
                    </button>
                    <button class="btn-datos" onclick="mostrarEstadosFiltros()">
                        <i class="fas fa-database"></i> Datos
                    </button>
                </div>
            </div>

            <!-- Indicador de Estado -->
            <div class="estado-filtros" id="estadoFiltros">
                <i class="fas fa-check-circle"></i>
                <span id="textoEstado">Datos del día actual - Cargando...</span>
            </div>
        </div>

        <!-- ESTADÍSTICAS PRINCIPALES -->
        <div class="stats-grid">
            <!-- Bolsas -->
            <div class="stat-card bolsas">
                <div class="stat-icon"><i class="fas fa-cube"></i></div>
                <div class="stat-label">Bolsitas Producidas</div>
                <div class="stat-value" id="bolsas-producidas">0</div>
                <div class="stat-change">Hoy</div>
            </div>

            <div class="stat-card bolsas">
                <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                <div class="stat-label">Bolsitas Rechazadas</div>
                <div class="stat-value" id="bolsas-rechazadas">0</div>
                <div class="stat-change negative">Defectos</div>
            </div>

            <!-- Packs -->
            <div class="stat-card packs">
                <div class="stat-icon"><i class="fas fa-box"></i></div>
                <div class="stat-label">Packs Calculados</div>
                <div class="stat-value" id="packs-calculados">0</div>
                <div class="stat-change">Sistema</div>
            </div>

            <div class="stat-card packs">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-label">Packs Operador</div>
                <div class="stat-value" id="packs-operador">0</div>
                <div class="stat-change">Confirmado</div>
            </div>

            <!-- Botellones -->
            <div class="stat-card botellones">
                <div class="stat-icon"><i class="fas fa-bottle-water"></i></div>
                <div class="stat-label">Botellones Producidos</div>
                <div class="stat-value" id="botellones-producidos">0</div>
                <div class="stat-change">Hoy</div>
            </div>

            <!-- Aditivos: Sales al Ozono -->
            <div class="stat-card calidad">
                <div class="stat-icon"><i class="fas fa-flask-vial"></i></div>
                <div class="stat-label">Días con Sales al Ozono</div>
                <div class="stat-value" id="dias-sales-ozono">0</div>
                <div class="stat-change">En período</div>
            </div>

            <!-- Aditivos: Silice -->
            <div class="stat-card calidad">
                <div class="stat-icon"><i class="fas fa-droplet"></i></div>
                <div class="stat-label">Días con Silice</div>
                <div class="stat-value" id="dias-silice">0</div>
                <div class="stat-change">En período</div>
            </div>
        </div>
        </div>

        <!-- GRÁFICAS PRINCIPALES -->
        <div class="charts-grid">
            <!-- GRÁFICA 1: BOLSITAS -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-cube"></i>
                    Producción de Bolsitas
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartBolsitas"></canvas>
                </div>
            </div>

            <!-- GRÁFICA 2: PACKS -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-box"></i>
                    Cálculo vs Realidad - Packs
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartPacks"></canvas>
                </div>
            </div>

            <!-- GRÁFICA 3: BOTELLONES -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-bottle-water"></i>
                    Producción de Botellones
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartBotellones"></canvas>
                </div>
            </div>

            <!-- GRÁFICA 4: MOTIVOS DE RECHAZO -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Razones de Rechazo
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartMotivos"></canvas>
                </div>
            </div>

            <!-- GRÁFICA 5: CALIDAD DEL AGUA -->
            <div class="chart-container full-width">
                <!-- GRÁFICA 5B: USO DE ADITIVOS -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-flask-vial"></i>
                    Uso de Aditivos (Sales & Silice)
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartAditivos"></canvas>
                </div>
            </div>

            <!-- TABLA: HISTORIAL DE ADITIVOS -->
            <div class="chart-container full-width">
                <div class="chart-title">
                    <i class="fas fa-history"></i>
                    Historial de Aditivos Utilizados
                </div>
                <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">Fecha</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #667eea;">¿Sales al Ozono?</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">Obs. Sales</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #667eea;">¿Silice?</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">Obs. Silice</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-aditivos">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                    <i class="fas fa-inbox"></i> Cargando datos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
                <div class="chart-title">
                    <i class="fas fa-water"></i>
                    Parámetros de Calidad del Agua
                </div>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="chartCalidad"></canvas>
                </div>
            </div>

            <!-- GRÁFICA 6: EFICIENCIA -->
            <div class="chart-container full-width">
                <div class="chart-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Eficiencia de Producción
                </div>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="chartEficiencia"></canvas>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Agua Zafiro © 2025 - Sistema de Control de Producción</p>
        </div>
    </div>
    </div>

    <!-- SCRIPTS DE SUPABASE Y DATOS -->
    <script>
        // ===== CONFIGURACIÓN SUPABASE =====
        const SUPABASE_URL = 'https://hjrplwxvyukevcljodyg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqcnBsd3h2eXVrZXZjbGpvZHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzUzMzQsImV4cCI6MjA3MzYxMTMzNH0.uJ-krjLrFVo7cHuIQQb1-x2wQzXwyZfcvg4XvnppkqE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let charts = {};
        let filtroActual = {
            tipo: 'dia',
            fechaDesde: new Date().toISOString().split('T')[0],
            fechaHasta: new Date().toISOString().split('T')[0]
        };

        // ===== NAVEGACIÓN Y AUTENTICACIÓN =====
        function irACapturador() {
            window.location.href = 'produccion.html';
        }

        function irADashboard() {
            // Ya estamos en el dashboard
            console.log('Ya estamos en el dashboard de producción');
        }

        function cerrarSesion() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                // Limpiar datos de sesión
                localStorage.removeItem('usuarioActual');
                localStorage.removeItem('rolUsuario');
                
                // Redirigir al login
                window.location.href = 'index.html';
            }
        }

        // ===== CARGAR INFORMACIÓN DEL USUARIO =====
        function cargarInfoUsuario() {
            try {
                const usuario = localStorage.getItem('usuarioActual') || 'Usuario';
                const rol = localStorage.getItem('rolUsuario') || 'Admin';
                
                document.getElementById('nombreUsuario').textContent = usuario;
                document.getElementById('rolUsuario').textContent = rol;
            } catch (error) {
                console.log('No hay sesión activa');
            }
        }

        // Agregar esto al DOMContentLoaded existente
        const oldDOMContentLoaded = document.onload;
        document.addEventListener('DOMContentLoaded', () => {
            cargarInfoUsuario();
            inicializarFiltros();
            // Aplicar filtro por defecto "Este mes" 
            aplicarFiltroRapido();
            // Actualizar cada 30 segundos
            setInterval(cargarDatos, 30000);
        });

        // ===== INICIALIZAR FILTROS =====
        function inicializarFiltros() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaDesde').value = hoy;
            document.getElementById('fechaHasta').value = hoy;
        }

        // ===== APLICAR FILTRO RÁPIDO =====
        function aplicarFiltroRapido() {
            const periodo = document.getElementById('periodoRapido').value;
            const hoy = new Date();
            let desde, hasta;

            switch(periodo) {
                case 'hoy':
                    desde = hasta = new Date();
                    break;
                case 'esta_semana':
                    desde = new Date(hoy.setDate(hoy.getDate() - hoy.getDay()));
                    hasta = new Date();
                    break;
                case 'este_mes':
                    desde = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    hasta = new Date();
                    break;
                case 'ultimo_mes':
                    hasta = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                    desde = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                    break;
                case 'este_año':
                    desde = new Date(hoy.getFullYear(), 0, 1);
                    hasta = new Date();
                    break;
            }

            document.getElementById('fechaDesde').value = desde.toISOString().split('T')[0];
            document.getElementById('fechaHasta').value = hasta.toISOString().split('T')[0];
            document.getElementById('porSemana').value = '';
            aplicarFiltros();
        }

        // ===== APLICAR FILTROS =====
        function aplicarFiltros() {
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;

            if (!fechaDesde || !fechaHasta) {
                alert('Por favor selecciona ambas fechas');
                return;
            }

            filtroActual.fechaDesde = fechaDesde;
            filtroActual.fechaHasta = fechaHasta;
            filtroActual.tipo = 'rango';

            cargarDatos();
            mostrarEstadosFiltros();
        }

        // ===== MOSTRAR ESTADO DE FILTROS =====
        function mostrarEstadosFiltros() {
            const desde = document.getElementById('fechaDesde').value;
            const hasta = document.getElementById('fechaHasta').value;
            const periodo = document.getElementById('periodoRapido').value;

            let textoEstado = '';
            
            if (desde === hasta) {
                const fecha = new Date(desde + 'T00:00:00').toLocaleDateString('es-HN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                textoEstado = `Datos de ${fecha}`;
            } else {
                textoEstado = `Datos desde ${desde} hasta ${hasta}`;
            }

            const ahora = new Date().toLocaleTimeString('es-HN');
            textoEstado += ` - Última actualización: ${ahora}`;

            document.getElementById('textoEstado').textContent = textoEstado;
        }

        // ===== CARGAR TODOS LOS DATOS =====
        async function cargarDatos() {
            const fechaDesde = filtroActual.fechaDesde || new Date().toISOString().split('T')[0];
            const fechaHasta = filtroActual.fechaHasta || new Date().toISOString().split('T')[0];

            try {
                // ✅ CORREGIDO v2.5 - Agregar filtros de fecha a queryBolsas
                 let queryBolsas = supabase
                 .from('control_produccion_bolsas')
                 .select('*')
                 .gte('fecha', fechaDesde)
                 .lte('fecha', fechaHasta);

                // Cargar datos de botellones
                let queryBotellones = supabase
                    .from('control_botellones')
                    .select('*')
                    .gte('fecha', fechaDesde)
                    .lte('fecha', fechaHasta);

                // Cargar datos de calidad
                let queryCalidad = supabase
                    .from('control_calidad_agua')
                    .select('*')
                    .gte('fecha', fechaDesde)
                    .lte('fecha', fechaHasta);

                const { data: bolsas } = await queryBolsas;
                const { data: botellones } = await queryBotellones;
                const { data: calidad } = await queryCalidad;

                console.log('✅ Datos cargados correctamente:');
                console.log('Bolsas:', bolsas?.length || 0, 'registros');
                console.log('Botellones:', botellones?.length || 0, 'registros');
                console.log('Calidad:', calidad?.length || 0, 'registros');

                actualizarEstadisticas(bolsas, botellones, calidad);
                actualizarGraficas(bolsas, botellones, calidad);
                mostrarEstadosFiltros();
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('textoEstado').textContent = '⚠️ Error al cargar datos: ' + error.message;
            }
        }

        // ===== ACTUALIZAR ESTADÍSTICAS =====
        function actualizarEstadisticas(bolsas, botellones, calidad) {
            // Bolsas
            let totalBolsasProducidas = 0;
            let totalBolsasRechazadas = 0;
            let totalPacksCalculados = 0;
            let totalPacksOperador = 0;

            if (bolsas && bolsas.length > 0) {
                bolsas.forEach(b => {
                    totalBolsasProducidas += b.bolsitas_producidas || 0;
                    totalBolsasRechazadas += b.bolsitas_rechazadas || 0;
                    totalPacksCalculados += Math.floor((b.bolsitas_producidas || 0) / 35);
                    totalPacksOperador += b.packs_operador || 0;
                });
            }

            let totalBotellonesProducidos = 0;
            if (botellones && botellones.length > 0) {
                botellones.forEach(b => {
                    totalBotellonesProducidos += b.botellones_producidos || 0;
                });
            }

            // Actualizar DOM
            document.getElementById('bolsas-producidas').textContent = totalBolsasProducidas;
            document.getElementById('bolsas-rechazadas').textContent = totalBolsasRechazadas;
            document.getElementById('packs-calculados').textContent = totalPacksCalculados;
            document.getElementById('packs-operador').textContent = totalPacksOperador;
            document.getElementById('botellones-producidos').textContent = totalBotellonesProducidos;
        }

        // ===== ACTUALIZAR GRÁFICAS MEJORADAS =====
        function actualizarGraficas(bolsas, botellones, calidad) {
            actualizarGraficaBolsitas(bolsas);
            actualizarGraficaPacks(bolsas);
            actualizarGraficaBotellones(botellones);
            actualizarGraficaMotivos(bolsas);
            actualizarGraficaCalidad(calidad);
            actualizarGraficaEficiencia(bolsas);
            actualizarAditivos(calidad);  // ← NUEVA LÍNEA
        }

        // ===== GRÁFICA 1: BOLSITAS =====
        function actualizarGraficaBolsitas(datos) {
            const ctx = document.getElementById('chartBolsitas').getContext('2d');
            
            let producidas = 0;
            let rechazadas = 0;

            if (datos && datos.length > 0) {
                datos.forEach(d => {
                    producidas += d.bolsitas_producidas || 0;
                    rechazadas += d.bolsitas_rechazadas || 0;
                });
            }

            if (charts.bolsitas) charts.bolsitas.destroy();

            charts.bolsitas = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Producidas ✓', 'Rechazadas ✗'],
                    datasets: [{
                        data: [producidas, rechazadas],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(231, 76, 60, 0.8)'
                        ],
                        borderColor: [
                            '#2ecc71',
                            '#e74c3c'
                        ],
                        borderWidth: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.2)',
                        shadowBlur: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 14, weight: 'bold' },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 15,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            borderColor: '#667eea',
                            borderWidth: 2,
                            callbacks: {
                                label: (context) => {
                                    const total = producidas + rechazadas;
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===== GRÁFICA 2: PACKS =====
        function actualizarGraficaPacks(datos) {
            const ctx = document.getElementById('chartPacks').getContext('2d');

            let horasPacks = [];
            let calculados = [];
            let operador = [];

            if (datos && datos.length > 0) {
                datos.forEach(d => {
                    horasPacks.push(d.hora || '--:--');
                    calculados.push(Math.floor((d.bolsitas_producidas || 0) / 35));
                    operador.push(d.packs_operador || 0);
                });
            }

            if (charts.packs) charts.packs.destroy();

            charts.packs = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: horasPacks,
                    datasets: [
                        {
                            label: 'Calculados',
                            data: calculados,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.4,
                            shadowColor: 'rgba(0, 0, 0, 0.2)',
                            shadowBlur: 8
                        },
                        {
                            label: 'Del Operador',
                            data: operador,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#2ecc71',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 13, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: '#667eea',
                            borderWidth: 2
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                font: { size: 12 }
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // ===== GRÁFICA 3: BOTELLONES =====
        function actualizarGraficaBotellones(datos) {
            const ctx = document.getElementById('chartBotellones').getContext('2d');

            let producidos = 0;
            let rechazados = 0;

            if (datos && datos.length > 0) {
                datos.forEach(d => {
                    producidos += d.botellones_producidos || 0;
                    rechazados += d.botellones_rechazados || 0;
                });
            }

            if (charts.botellones) charts.botellones.destroy();

            charts.botellones = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Producidos', 'Rechazados'],
                    datasets: [{
                        label: 'Botellones',
                        data: [producidos, rechazados],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(231, 76, 60, 0.8)'
                        ],
                        borderColor: [
                            '#3498db',
                            '#e74c3c'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: '#3498db',
                            borderWidth: 2,
                            callbacks: {
                                label: (context) => `${context.parsed.x} botellones`
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 12 }
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // ===== GRÁFICA 4: MOTIVOS DE RECHAZO =====
        function actualizarGraficaMotivos(datos) {
            const ctx = document.getElementById('chartMotivos').getContext('2d');

            let motivos = {};
            if (datos && datos.length > 0) {
                datos.forEach(d => {
                    if (d.motivos_rechazo) {
                        const listaMotivos = d.motivos_rechazo.split(',');
                        listaMotivos.forEach(motivo => {
                            const clean = motivo.trim();
                            motivos[clean] = (motivos[clean] || 0) + 1;
                        });
                    }
                });
            }

            const labels = Object.keys(motivos);
            const values = Object.values(motivos);

            const colores = [
                'rgba(231, 76, 60, 0.8)',
                'rgba(230, 126, 34, 0.8)',
                'rgba(241, 196, 15, 0.8)',
                'rgba(155, 89, 182, 0.8)',
                'rgba(52, 73, 94, 0.8)'
            ];

            if (charts.motivos) charts.motivos.destroy();

            charts.motivos = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.length > 0 ? labels : ['Sin rechazos'],
                    datasets: [{
                        data: values.length > 0 ? values : [1],
                        backgroundColor: colores.slice(0, labels.length),
                        borderColor: '#fff',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: '#f39c12',
                            borderWidth: 2
                        }
                    }
                }
            });
        }

        // ===== GRÁFICA 5: CALIDAD DEL AGUA =====
        function actualizarGraficaCalidad(datos) {
            const ctx = document.getElementById('chartCalidad').getContext('2d');

            let tds = [];
            let usm = [];
            let temp = [];
            let ph = [];
            let horas = [];

            if (datos && datos.length > 0) {
                datos.forEach(d => {
                    tds.push(d.tds || 0);
                    usm.push(d.usm || 0);
                    temp.push(d.temperatura || 0);
                    ph.push(d.ph || 0);
                    horas.push(d.hora || '--:--');
                });
            }

            if (charts.calidad) charts.calidad.destroy();

            charts.calidad = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: horas,
                    datasets: [
                        {
                            label: 'TDS (ppm)',
                            data: tds,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            borderWidth: 2.5,
                            pointRadius: 5,
                            pointBackgroundColor: '#3498db',
                            yAxisID: 'y'
                        },
                        {
                            label: 'USM (µS/cm)',
                            data: usm,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true,
                            borderWidth: 2.5,
                            pointRadius: 5,
                            pointBackgroundColor: '#2ecc71',
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Temperatura (°C)',
                            data: temp,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            borderWidth: 2.5,
                            pointRadius: 5,
                            pointBackgroundColor: '#e74c3c',
                            yAxisID: 'y2'
                        },
                        {
                            label: 'pH',
                            data: ph,
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            fill: true,
                            borderWidth: 2.5,
                            pointRadius: 5,
                            pointBackgroundColor: '#f39c12',
                            yAxisID: 'y3'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 15,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: '#667eea',
                            borderWidth: 2,
                            displayColors: true
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'TDS (ppm)',
                                font: { weight: 'bold', size: 12 },
                                color: '#3498db'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'USM (µS/cm)',
                                font: { weight: 'bold', size: 12 },
                                color: '#2ecc71'
                            },
                            grid: { display: false }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperatura (°C)',
                                font: { weight: 'bold', size: 12 },
                                color: '#e74c3c'
                            },
                            grid: { display: false },
                            offset: true
                        },
                        y3: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'pH',
                                font: { weight: 'bold', size: 12 },
                                color: '#f39c12'
                            },
                            grid: { display: false },
                            offset: true
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ===== GRÁFICA 6: EFICIENCIA =====
        function actualizarGraficaEficiencia(datos) {
            const ctx = document.getElementById('chartEficiencia').getContext('2d');

            let horas = [];
            let eficiencia = [];
            let colores = [];

            if (datos && datos.length > 0) {
                datos.forEach(d => {
                    const producidas = d.bolsitas_producidas || 0;
                    const rechazadas = d.bolsitas_rechazadas || 0;
                    const total = producidas + rechazadas;
                    const eff = total > 0 ? ((producidas / total) * 100).toFixed(1) : 0;
                    const effNum = parseFloat(eff);
                    
                    horas.push(d.hora || '--:--');
                    eficiencia.push(effNum);
                    
                    if (effNum >= 90) colores.push('rgba(46, 204, 113, 0.8)');
                    else if (effNum >= 80) colores.push('rgba(52, 152, 219, 0.8)');
                    else if (effNum >= 70) colores.push('rgba(241, 196, 15, 0.8)');
                    else colores.push('rgba(231, 76, 60, 0.8)');
                });
            } else {
                horas = ['Sin datos'];
                eficiencia = [0];
                colores = ['rgba(189, 195, 199, 0.8)'];
            }

            if (charts.eficiencia) charts.eficiencia.destroy();

            charts.eficiencia = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: horas,
                    datasets: [{
                        label: 'Eficiencia (%)',
                        data: eficiencia,
                        backgroundColor: colores,
                        borderColor: '#fff',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            borderColor: '#2ecc71',
                            borderWidth: 2,
                            callbacks: {
                                label: (context) => {
                                    const val = context.parsed.y || 0;
                                    return `${val.toFixed(1)}% de eficiencia`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 12 },
                                callback: (value) => value + '%'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }
        // ===== ACTUALIZAR ADITIVOS =====
        function actualizarAditivos(calidad) {
            // Contar días con sales y silice
            let diasSales = 0;
            let diasSilice = 0;
            let registrosAditivos = [];

            if (calidad && calidad.length > 0) {
                calidad.forEach(d => {
                    if (d.usa_sales_ozono === true) diasSales++;
                    if (d.usa_silice === true) diasSilice++;
                    
                    registrosAditivos.push({
                        fecha: d.fecha,
                        usaSales: d.usa_sales_ozono,
                        obsSales: d.observacion_sales_ozono,
                        usaSilice: d.usa_silice,
                        obsSilice: d.observacion_silice
                    });
                });
            }

            // Actualizar estadísticas
            document.getElementById('dias-sales-ozono').textContent = diasSales;
            document.getElementById('dias-silice').textContent = diasSilice;

            // Actualizar gráfica
            actualizarGraficaAditivos(calidad);
            
            // Actualizar tabla
            actualizarTablaAditivos(registrosAditivos);
        }

        // ===== GRÁFICA: ADITIVOS =====
        function actualizarGraficaAditivos(datos) {
            const ctx = document.getElementById('chartAditivos').getContext('2d');

            let fechas = [];
            let sales = [];
            let silice = [];

            if (datos && datos.length > 0) {
                datos.forEach(d => {
                    fechas.push(d.fecha);
                    sales.push(d.usa_sales_ozono === true ? 1 : 0);
                    silice.push(d.usa_silice === true ? 1 : 0);
                });
            }

            if (charts.aditivos) charts.aditivos.destroy();

            charts.aditivos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fechas,
                    datasets: [
                        {
                            label: 'Sales al Ozono',
                            data: sales,
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: 'Silice',
                            data: silice,
                            backgroundColor: 'rgba(46, 204, 113, 0.8)',
                            borderColor: '#2ecc71',
                            borderWidth: 2,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                callback: (value) => value === 1 ? 'Sí' : 'No'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 12,
                            callbacks: {
                                label: (context) => {
                                    return context.parsed.y === 1 ? '✅ Utilizado' : '❌ No utilizado';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===== TABLA: HISTORIAL ADITIVOS =====
        function actualizarTablaAditivos(registros) {
            const tbody = document.getElementById('tbody-aditivos');
            
            if (!registros || registros.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">
                            <i class="fas fa-inbox"></i> No hay registros de aditivos
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = registros.map(r => `
                <tr style="border-bottom: 1px solid #ecf0f1; transition: background 0.2s;">
                    <td style="padding: 12px; font-weight: bold; color: #2c3e50;">${r.fecha}</td>
                    <td style="padding: 12px; text-align: center;">
                        ${r.usaSales === true ? '<span style="color: #2ecc71; font-weight: bold;">✅ Sí</span>' : '<span style="color: #e74c3c;">❌ No</span>'}
                    </td>
                    <td style="padding: 12px; color: #555;">${r.obsSales ? r.obsSales : '--'}</td>
                    <td style="padding: 12px; text-align: center;">
                        ${r.usaSilice === true ? '<span style="color: #2ecc71; font-weight: bold;">✅ Sí</span>' : '<span style="color: #e74c3c;">❌ No</span>'}
                    </td>
                    <td style="padding: 12px; color: #555;">${r.obsSilice ? r.obsSilice : '--'}</td>
                </tr>
            `).join('');
        }

        // Actualizar en la función cargarDatos existente
        // Reemplaza la línea:
        //     actualizarGraficas(bolsas, botellones, calidad);
        // POR:
        //     actualizarGraficas(bolsas, botellones, calidad);
        //     actualizarAditivos(calidad);
    </script>
</body>
</html>